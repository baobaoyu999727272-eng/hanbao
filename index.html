<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HANBAO — QQ 风格 演示 (修复版)</title>
    <style>
      :root {
        --qq-blue: #1a8aff;
        --nav-height: 56px;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: PingFang SC, Segoe UI, Roboto, 'Microsoft Yahei', sans-serif;
        background: #1b4574;
      }
      .notch {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 18px;
        width: 120px; /* 微调更短 */
        height: 28px;
        background: #000;
        border-radius: 14px;
      }
      .phone {
        width: 360px; /* 进一步收窄外壳，更贴合截图 */
        height: 800px;
        margin: 46px auto;
        border-radius: 36px;
        box-shadow: 0 18px 56px rgba(2, 40, 80, 0.45), inset 0 2px 0 rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
        border: 3px solid rgba(255, 255, 255, 0.18); /* 更浅更自然的边框 */
        background: linear-gradient(180deg, #ddf0ff, #eef7ff);
      }
      .wallpaper {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, #cfe8ff, #eaf6ff);
      }
      .screen-content {
        position: relative;
        height: 100%;
        padding-top: 84px;
        box-sizing: border-box;
      }
      .watermark {
        position: absolute;
        right: 12px;
        bottom: 18px;
        color: rgba(0, 0, 0, 0.06);
        font-weight: 700;
        font-size: 22px;
      }
      .home-panel {
        position: absolute;
        left: 14px;
        right: 14px;
        top: 120px; /* 与截图保持一定下移，留出 notch 空白 */
        bottom: 20px;
        background: transparent; /* 透明，回到壁纸上 */
        border-radius: 0; /* 无圆角卡片 */
        box-shadow: none; /* 去掉白卡阴影 */
        padding: 20px 18px 34px 18px; /* 保留内边距以维持图标位置 */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }
      .app-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 42px 34px; /* 更接近截图的较大垂直间距 */
        justify-items: center;
        align-items: center;
        margin: 0;
        width: 260px; /* 使图标行在卡片中更居中 */
        margin-top: 6px;
      }
      .app {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: inherit;
      }
      .icon {
        width: 96px; /* 略大一些，让图标更显眼 */
        height: 96px;
        border-radius: 20px;
        background: radial-gradient(
            circle at 30% 20%,
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.6) 30%,
            rgba(230, 245, 255, 0.6) 60%
          ),
          linear-gradient(180deg, #ffffff, #f0f8ff);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 14px 30px rgba(6, 36, 60, 0.12), inset 0 6px 14px rgba(255, 255, 255, 0.6);
        padding: 12px;
        border: 1px solid rgba(11, 58, 69, 0.06);
        transition: transform 160ms cubic-bezier(0.2, 0.9, 0.2, 1), box-shadow 160ms ease;
      }
      .icon img {
        width: 56px; /* 图标尺寸 */
        height: 56px;
        object-fit: contain;
        border-radius: 12px;
        transition: transform 180ms ease, filter 160ms ease;
      }
      .icon:hover {
        transform: translateY(-6px) scale(1.06);
        box-shadow: 0 28px 48px rgba(6, 36, 60, 0.16), inset 0 6px 14px rgba(255, 255, 255, 0.6);
        filter: drop-shadow(0 6px 18px rgba(10, 40, 80, 0.08));
      }
      /* typing 指示器 */
      .typing-dots {
        display: inline-flex;
        gap: 6px;
        align-items: center;
      }
      .typing-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #cfe8ff;
        opacity: 0.9;
        transform: translateY(0);
        animation: typing 1s infinite;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: 0.12s;
      }
      .typing-dots span:nth-child(3) {
        animation-delay: 0.24s;
      }
      @keyframes typing {
        0% {
          transform: translateY(0);
          opacity: 0.6;
        }
        50% {
          transform: translateY(-6px);
          opacity: 1;
        }
        100% {
          transform: translateY(0);
          opacity: 0.6;
        }
      }
      .label {
        margin-top: 10px;
        font-weight: 600;
        font-size: 13px;
        color: #08313a;
        text-align: center;
      }
      /* API / QQ 页面美化 */
      #api-screen .page-content,
      #qq-screen .page-content {
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        box-shadow: 0 8px 18px rgba(12, 40, 80, 0.04);
        padding: 16px;
      }
      #api-screen .actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .btn {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 13px;
      }
      .btn.primary {
        background: var(--qq-blue);
        color: #fff;
      }
      .btn.ghost {
        background: linear-gradient(180deg, #f7fbff, #eef7ff);
        border: 1px solid #d6ecff;
        color: #0b3a45;
      }
      .btn.ghost:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(12, 40, 80, 0.04);
      }
      .btn[disabled] {
        opacity: 0.6;
        cursor: default;
      }
      /* roll icon 微调 */
      #rollFooterBtn img {
        filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.06));
      }
      input[type='text'],
      input[type='password'],
      input:not([type]),
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #e8f0fb;
        background: linear-gradient(180deg, #ffffff, #fbfeff);
        box-sizing: border-box;
        font-size: 13px;
        transition: box-shadow 160ms ease, transform 120ms ease;
      }
      input[type='text']::placeholder,
      textarea::placeholder {
        color: #94aab5;
      }
      select {
        height: 38px;
      }
      select {
        appearance: none;
        -webkit-appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, #888 50%),
          linear-gradient(135deg, #888 50%, transparent 50%);
        background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px);
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        box-shadow: 0 6px 18px rgba(26, 138, 255, 0.08);
        border-color: #9fd0ff;
      }
      /* apiResponse 样式已移除（响应面板不再存在） */
      .placeholder-qq {
        text-align: center;
        color: #6b8796;
        padding: 28px 12px;
      }
      /* QQ 列表美化 */
      #qq-session-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 4px;
      }
      .qq-session {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px;
        border-radius: 12px;
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        box-shadow: 0 6px 18px rgba(12, 40, 80, 0.04);
        border: 1px solid rgba(6, 36, 60, 0.03);
        cursor: pointer;
        position: relative;
      }
      .qq-session .qq-del {
        position: absolute;
        right: 8px;
        top: 8px;
        background: transparent;
        border: none;
        color: #ff6b6b;
        font-weight: 700;
        cursor: pointer;
        padding: 4px 6px;
        border-radius: 6px;
      }
      .qq-avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: linear-gradient(180deg, #eaf6ff, #d6edff);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #0b3a45;
        flex-shrink: 0;
      }
      .qq-session .info {
        flex: 1;
        overflow: hidden;
      }
      .qq-session .name {
        font-weight: 700;
        color: #08313a;
        font-size: 14px;
      }
      .qq-session .msg {
        color: #6b8796;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .qq-session .meta {
        font-size: 12px;
        color: #94aab5;
      }
      .qq-badge {
        background: #ff4d6d;
        color: #fff;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      .add-btn {
        padding: 6px 10px;
        border-radius: 10px;
        border: none;
        background: var(--qq-blue);
        color: #fff;
        box-shadow: 0 6px 14px rgba(26, 138, 255, 0.12);
      }
      .add-btn:hover {
        transform: translateY(-2px);
      }
      .hidden {
        display: none !important;
      }
      .screen {
        position: absolute;
        inset: 0;
        padding-top: var(--nav-height);
        display: none;
        flex-direction: column;
      }
      .screen.active {
        display: flex;
      }
      .nav {
        height: var(--nav-height);
        display: flex;
        align-items: center;
        padding: 8px 12px;
      }
      .nav strong {
        flex: 1;
        text-align: center;
      }
      .back-btn {
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid rgba(11, 58, 69, 0.08);
        background: linear-gradient(180deg, #ffffff, #fbfeff);
        box-shadow: 0 4px 10px rgba(12, 40, 80, 0.06);
        cursor: pointer;
      }
      .back-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(12, 40, 80, 0.09);
      }
      .page-content {
        flex: 1;
        overflow: auto;
        padding: 18px;
        background: #fff;
        border-radius: 18px 18px 0 0;
        margin: 0 12px 12px 12px;
      }
      /* 给聊天页面底部留出足够空间，避免最后一条消息被底部输入栏遮挡 */
      .page-content.chat {
        padding-bottom: 140px;
      }
      .bubble {
        padding: 10px 14px;
        border-radius: 14px;
        background: #f1f8ff;
        max-width: 78%;
        margin: 6px 0;
      }
      .bubble.me {
        background: var(--qq-blue);
        color: #fff;
      }
      /* 新增：消息行与头像 */
      .message-row {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        margin: 6px 0;
      }
      .message-row.me {
        justify-content: flex-end;
      }
      .message-row .avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: linear-gradient(180deg, #fff, #eef7ff);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #08313a;
        flex-shrink: 0;
        overflow: hidden;
      }
      .message-row .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .input-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .chat-action-btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid #e6eefb;
        background: #fff;
        cursor: pointer;
      }
      /* 聊天界面样式 */
      .chat-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: linear-gradient(180deg, #ffffff, #f8fbff);
        border-bottom: 1px solid #e8f0fb;
        box-shadow: 0 2px 8px rgba(12, 40, 80, 0.05);
      }
      .chat-top .left-section {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .chat-top .center-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .chat-top .right-section {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .chat-top .contact-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #1a8aff, #0066cc);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        overflow: hidden;
      }
      .chat-top .contact-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .chat-top .contact-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .chat-top .contact-name {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }
      .chat-top .contact-status {
        font-size: 12px;
        color: #7f8c8d;
        margin: 0;
        margin-top: -2px;
      }
      .chat-top .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: rgba(26, 138, 255, 0.1);
        color: #1a8aff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .chat-top .action-btn:hover {
        background: rgba(26, 138, 255, 0.2);
        transform: scale(1.1);
      }
      #chatTitle {
        font-size: 16px;
        font-weight: 700;
      }
      .chat-footer {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 10px 12px;
        background: linear-gradient(180deg, #fff, #f9fbff);
        box-shadow: 0 -6px 18px rgba(12, 40, 80, 0.04);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .attachment-icons {
        display: flex;
        gap: 8px;
      }
      .chat-input-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .chat-input {
        flex: 1;
        padding: 10px 14px;
        border-radius: 24px;
        border: 1px solid #eef3fb;
        background: #fff;
      }
      .send-btn {
        width: 64px;
        height: 40px;
        border-radius: 20px;
      }
      #messages {
        padding: 12px;
        min-height: 420px;
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-backdrop.active {
        display: flex;
      }
      .modal {
        width: 92%;
        max-width: 520px;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
      }
      textarea {
        font-family: inherit;
      }
      @media (max-width: 480px) {
        .phone {
          width: 360px;
          height: 780px;
        }
      }

      /* 改进的响应式和UI样式 */
      .phone {
        transition: all 0.3s ease;
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12);
      }

      .modal {
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .btn {
        transition: all 0.2s ease;
        user-select: none;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      /* 优化输入框样式 */
      input,
      textarea,
      select {
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #1a8aff;
        box-shadow: 0 0 0 3px rgba(26, 138, 255, 0.1);
      }

      /* QQ界面优化 */
      .qq-session {
        transition: background-color 0.2s ease;
      }

      .qq-session:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }

      /* 消息气泡动画 */
      .bubble {
        animation: bubbleSlideIn 0.3s ease-out;
      }

      @keyframes bubbleSlideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 世界书条目样式优化 */
      #worldBookList {
        scrollbar-width: thin;
        scrollbar-color: #ddd transparent;
      }

      #worldBookList::-webkit-scrollbar {
        width: 6px;
      }

      #worldBookList::-webkit-scrollbar-track {
        background: transparent;
      }

      #worldBookList::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 3px;
      }

      /* 改进loading动画 */
      .typing-dots span {
        animation: typing 1.4s infinite;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        30% {
          transform: translateY(-10px);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="phone" role="application" aria-label="HANBAO Demo Phone">
      <div class="wallpaper"></div>
      <div class="notch" aria-hidden></div>
      <div class="screen-content">
        <div class="watermark">HANBAO</div>
        <div class="home-panel">
          <div class="app-row" id="app-row">
            <a class="app" href="#" onclick="showWorldBookModal(); return false;"
              ><div class="icon"><img src="https://img.cdn1.vip/i/68b4d6a78c089_1756681895.webp" alt="世界书" /></div>
              <div class="label">世界书</div></a
            >
            <a class="app" href="#" data-screen="qq-screen"
              ><div class="icon"><img src="https://img.cdn1.vip/i/68b4d5cee23f7_1756681678.webp" alt="QQ" /></div>
              <div class="label">QQ</div></a
            >
            <a class="app" href="#" data-screen="api-screen"
              ><div class="icon"><img src="https://img.cdn1.vip/i/68b4d6a787f9c_1756681895.webp" alt="API" /></div>
              <div class="label">API</div></a
            >
            <a class="app" href="#" data-screen="settings-screen"
              ><div class="icon"><img src="https://i.111666.best/image/KrGLd0mjGkHswb9ieAE9CG.png" alt="设置" /></div>
              <div class="label">设置</div></a
            >
          </div>
        </div>

        <div id="chat-screen" class="screen" aria-hidden>
          <div class="nav chat-top">
            <div class="left-section">
              <button class="back-btn">◀</button>
              <div class="contact-avatar" id="contactAvatar">AI</div>
              <div class="contact-info">
                <div class="contact-name" id="chatTitle">聊天</div>
                <div class="contact-status" id="contactStatus">在线</div>
              </div>
            </div>
            <div class="right-section">
              <button class="action-btn" title="语音通话" onclick="showTransferModal()">�</button>
              <button class="action-btn" title="视频通话" onclick="showRedPacketModal()">📹</button>
              <button class="action-btn" title="更多" onclick="showGroupChatModal()">⋯</button>
            </div>
          </div>
          <div class="page-content chat" id="chatPage">
            <div id="messages"></div>
          </div>
          <div class="chat-footer">
            <div class="attachment-icons">
              <button class="btn ghost" onclick="showGroupChatModal()" title="创建群聊">
                <img
                  src="https://i.111666.best/image/9kHFDz5Nadhj7g2vwOyk9G.png"
                  alt="群聊"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" onclick="showCameraModal()" title="拍照">
                <img
                  src="https://i.111666.best/image/3QPuXFeAydF7NrY5IDMxYu.png"
                  alt="拍照"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" onclick="showAlbumModal()" title="相册">
                <img
                  src="https://i.111666.best/image/GF2ZspS1bnNGxsoto5GhIc.png"
                  alt="相册"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" onclick="showTransferModal()" title="转账">
                <img
                  src="https://i.111666.best/image/gb4daNz41OHTOBfoHnvBqv.png"
                  alt="转账"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" onclick="showRedPacketModal()" title="红包">
                <img
                  src="https://i.111666.best/image/K2nroRSSGapSjiL7yU70qc.png"
                  alt="红包"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" title="表情包">
                <img
                  src="https://i.111666.best/image/CNvFPp13Aiqt9ILZznqqha.png"
                  alt="表情包"
                  style="width: 20px; height: 20px"
                />
              </button>
            </div>
            <div class="chat-input-row">
              <input id="inputBox" placeholder="输入消息..." class="chat-input" />
              <button
                id="rollFooterBtn"
                class="btn ghost"
                style="margin-left: 8px; padding: 6px 8px; border-radius: 14px"
                onclick="showRollOptions()"
              >
                <img
                  src="https://img.cdn1.vip/i/68b52535066a9_1756702005.webp"
                  alt="重生"
                  style="width: 20px; height: 20px; display: block"
                />
              </button>
              <button id="sendBtn" class="btn primary send-btn">发送</button>
            </div>
          </div>
        </div>

        <div id="qq-screen" class="screen" aria-hidden>
          <div class="nav"><button class="back-btn">返回</button><strong>QQ</strong></div>
          <div class="page-content">
            <div style="margin-bottom: 12px; display: flex; gap: 8px">
              <input
                id="qq-search"
                style="
                  flex: 1;
                  padding: 8px;
                  border-radius: 10px;
                  border: 1px solid #e6f1fb;
                  background: linear-gradient(180deg, #fff, #f7fbff);
                "
                placeholder="🔍 搜索联系人"
              /><button id="addPersonaBtn" class="add-btn">+ 添加</button>
            </div>
            <div id="qq-session-list"></div>
          </div>
        </div>

        <div id="api-screen" class="screen" aria-hidden>
          <div class="nav"><button class="back-btn">返回</button><strong>API 配置</strong></div>
          <div class="page-content">
            <div style="display: flex; gap: 12px">
              <div style="flex: 1; min-width: 180px">
                <form id="apiForm">
                  <div style="display: flex; gap: 8px; align-items: center">
                    <label style="min-width: 56px">来源</label>
                    <select id="apiSource">
                      <option value="openai">OpenAI 兼容</option>
                      <option value="gemini">Gemini</option>
                    </select>
                  </div>
                  <div style="margin-top: 8px">
                    <label>端点</label>
                    <input id="apiUrl" placeholder="https://api.openai.com/v1" style="width: 100%" />
                  </div>
                  <div style="margin-top: 8px">
                    <label id="apiKeyLabel">API Key</label>
                    <input id="apiKey" placeholder="sk-..." style="width: 100%" />
                  </div>
                  <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center">
                    <label style="min-width: 56px">模型</label>
                    <select id="modelSelect" style="flex: 1; display: none"></select>
                    <button type="submit" class="btn primary">连接</button>
                    <button id="saveBtn" type="button" class="btn ghost hidden">保存</button>
                  </div>
                  <div id="status" class="status" style="margin-top: 6px; color: #0b3a45; font-size: 13px"></div>
                </form>

                <!-- 自定义请求体已移除，发送使用预设请求 -->
                <div style="margin-top: 12px">
                  <div style="color: #6b8796; font-size: 13px">
                    发送将使用预设 Chat Completions 请求，选择模型后点击发送。
                  </div>
                </div>
                <!-- 发送控件已移除 -->
              </div>
              <!-- 响应面板已移除以保持界面简洁 -->
            </div>
          </div>
        </div>

        <div id="settings-screen" class="screen" aria-hidden>
          <div class="nav"><button class="back-btn">返回</button><strong>设置</strong></div>
          <div class="page-content">
            <label><input id="enableNotchPreview" type="checkbox" /> 启用灵动岛预览</label>

            <!-- 壁纸设置 -->
            <div style="margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 12px">
              <h4 style="margin: 0 0 12px 0; color: #333">🎨 壁纸设置</h4>
              <div style="margin-bottom: 12px">
                <label style="font-size: 13px; display: block; margin-bottom: 4px">壁纸类型</label>
                <select
                  id="wallpaperType"
                  style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd"
                >
                  <option value="color">纯色背景</option>
                  <option value="gradient">渐变背景</option>
                  <option value="image">图片背景</option>
                </select>
              </div>

              <div id="colorWallpaper" style="margin-bottom: 12px">
                <label style="font-size: 13px; display: block; margin-bottom: 4px">背景颜色</label>
                <input
                  type="color"
                  id="wallpaperColor"
                  value="#f0f2f5"
                  style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer"
                />
              </div>

              <div id="gradientWallpaper" style="margin-bottom: 12px; display: none">
                <label style="font-size: 13px; display: block; margin-bottom: 4px">渐变色彩</label>
                <div style="display: flex; gap: 8px; align-items: center">
                  <input
                    type="color"
                    id="gradientColor1"
                    value="#667eea"
                    style="width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer"
                  />
                  <span>→</span>
                  <input
                    type="color"
                    id="gradientColor2"
                    value="#764ba2"
                    style="width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer"
                  />
                </div>
              </div>

              <div id="imageWallpaper" style="margin-bottom: 12px; display: none">
                <label style="font-size: 13px; display: block; margin-bottom: 4px">背景图片</label>
                <div style="display: flex; gap: 8px; align-items: center">
                  <input
                    id="wallpaperImageUrl"
                    placeholder="图片URL或点击上传"
                    style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd"
                  />
                  <button id="wallpaperUploadBtn" class="btn ghost" style="padding: 6px 8px">上传</button>
                </div>
                <input id="wallpaperImageFile" type="file" accept="image/*" style="display: none" />
              </div>

              <button id="applyWallpaper" class="btn primary" style="width: 100%; margin-top: 8px">应用壁纸</button>
            </div>

            <!-- 世界书设置 -->
            <div style="margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 12px">
              <h4 style="margin: 0 0 12px 0; color: #333">📖 世界书</h4>
              <p style="margin: 0 0 12px 0; font-size: 12px; color: #666">
                添加世界观设定、角色背景等额外信息，帮助AI更好地理解对话场景
              </p>
              <button id="openWorldBook" class="btn primary" style="width: 100%">管理世界书</button>
            </div>

            <!-- 作者信息 -->
            <div
              style="
                margin: 20px 0;
                padding: 16px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px;
                color: white;
                text-align: center;
              "
            >
              <h4 style="margin: 0 0 8px 0">👨‍💻 作者信息</h4>
              <p style="margin: 0; font-size: 14px; opacity: 0.9">作者：baobaoyu</p>
              <div style="margin: 12px 0; font-size: 12px; opacity: 0.8; line-height: 1.4">
                <p style="margin: 0">⚠️ 禁止二传，禁止商业化</p>
                <p style="margin: 4px 0 0 0">📍 仅在类脑or旅程发布</p>
                <p style="margin: 4px 0 0 0">🐛 有bug请在旅程or类脑找我哦</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 添加会话模态 -->
    <div id="addModal" class="modal-backdrop">
      <div class="modal" style="padding: 16px">
        <div style="padding: 8px 0 12px"><strong>新建会话</strong></div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">AI 名称（char）</label>
          <input
            id="charNameInput"
            placeholder="例如：汉堡堡"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 8px">
          <button id="cancelAddBtn" class="btn ghost">取消</button>
          <button id="confirmAddBtn" class="btn primary">创建</button>
        </div>
      </div>
    </div>
    <!-- 确认模态（与 addModal 风格一致） -->
    <div id="confirmModal" class="modal-backdrop">
      <div class="modal" style="padding: 16px">
        <div style="padding: 8px 0 12px"><strong id="confirmTitle">确认</strong></div>
        <div id="confirmBody" style="margin-bottom: 12px; color: #444">确认操作吗？</div>
        <div style="display: flex; justify-content: flex-end; gap: 8px">
          <button id="confirmCancel" class="btn ghost">取消</button>
          <button id="confirmOk" class="btn primary">确认</button>
        </div>
      </div>
    </div>

    <!-- 角色与用户设置模态 -->
    <div id="settingsModal" class="modal-backdrop">
      <div class="modal" style="padding: 16px">
        <div style="padding: 8px 0 12px"><strong>会话与用户设置</strong></div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">AI 名称（char）</label>
          <input
            id="settingsCharName"
            placeholder="AI 名称"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">AI 头像 URL（可选）</label>
          <div style="display: flex; gap: 8px; align-items: center">
            <input
              id="settingsCharAvatar"
              placeholder="https://...png 或 本地上传"
              style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
            />
            <button id="settingsCharUploadBtn" class="btn ghost" type="button" style="padding: 6px 8px">上传</button>
          </div>
          <input id="settingsCharAvatarFile" type="file" accept="image/*" style="display: none" />
          <div id="settingsCharAvatarPreview" style="margin-top: 6px"></div>
        </div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">AI 设定（system prompt，可选）</label>
          <textarea
            id="settingsCharPrompt"
            rows="3"
            placeholder="AI 的行为设定..."
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          ></textarea>
        </div>
        <hr />
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">用户名称</label>
          <input
            id="settingsUserName"
            placeholder="你的名字"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">用户头像 URL（可选）</label>
          <div style="display: flex; gap: 8px; align-items: center">
            <input
              id="settingsUserAvatar"
              placeholder="https://...png 或 本地上传"
              style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
            />
            <button id="settingsUserUploadBtn" class="btn ghost" type="button" style="padding: 6px 8px">上传</button>
          </div>
          <input id="settingsUserAvatarFile" type="file" accept="image/*" style="display: none" />
          <div id="settingsUserAvatarPreview" style="margin-top: 6px"></div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 8px">
          <button id="settingsCancel" class="btn ghost">取消</button>
          <button id="settingsSave" class="btn primary">保存</button>
        </div>
      </div>
    </div>

    <!-- 转账模态框 -->
    <div id="transferModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 300px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">💰 转账</h3>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">收款人</label>
          <input
            id="transferReceiver"
            placeholder="输入收款人昵称"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">转账金额</label>
          <input
            id="transferAmount"
            type="number"
            placeholder="0.00"
            style="
              width: 100%;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              margin-top: 4px;
              font-size: 18px;
              text-align: center;
            "
          />
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; color: #666">转账说明</label>
          <input
            id="transferNote"
            placeholder="添加转账说明（可选）"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="display: flex; gap: 8px">
          <button id="transferCancel" class="btn ghost" style="flex: 1">取消</button>
          <button id="transferConfirm" class="btn primary" style="flex: 1">确认转账</button>
        </div>
      </div>
    </div>

    <!-- 红包模态框 -->
    <div id="redPacketModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 300px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #ff4757">🧧 发红包</h3>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">红包类型</label>
          <select
            id="redPacketType"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          >
            <option value="normal">普通红包</option>
            <option value="lucky">拼手气红包</option>
          </select>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">红包金额</label>
          <input
            id="redPacketAmount"
            type="number"
            placeholder="0.00"
            style="
              width: 100%;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              margin-top: 4px;
              font-size: 18px;
              text-align: center;
            "
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">红包个数</label>
          <input
            id="redPacketCount"
            type="number"
            value="1"
            min="1"
            max="100"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; color: #666">红包祝福</label>
          <input
            id="redPacketMessage"
            placeholder="恭喜发财，大吉大利"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="display: flex; gap: 8px">
          <button id="redPacketCancel" class="btn ghost" style="flex: 1">取消</button>
          <button id="redPacketConfirm" class="btn primary" style="flex: 1">发红包</button>
        </div>
      </div>
    </div>

    <!-- 群聊模态框 -->
    <div id="groupChatModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 320px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">👥 创建群聊</h3>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">群聊名称</label>
          <input
            id="groupName"
            placeholder="输入群聊名称"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">群聊头像 URL（可选）</label>
          <input
            id="groupAvatar"
            placeholder="https://... 或留空使用默认"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; color: #666">群聊介绍</label>
          <textarea
            id="groupDescription"
            placeholder="群聊介绍（可选）"
            style="
              width: 100%;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              margin-top: 4px;
              min-height: 60px;
              resize: vertical;
            "
          ></textarea>
        </div>
        <div style="display: flex; gap: 8px">
          <button id="groupCancel" class="btn ghost" style="flex: 1">取消</button>
          <button id="groupConfirm" class="btn primary" style="flex: 1">创建群聊</button>
        </div>
      </div>
    </div>

    <!-- 世界书模态框 -->
    <div id="worldBookModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 500px; max-height: 80vh; overflow-y: auto">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #667eea">📖 世界书管理</h3>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #666">
            添加关键词和对应描述，当对话中出现关键词时自动注入相关信息
          </p>
        </div>

        <div style="margin-bottom: 16px">
          <div style="display: flex; gap: 8px; margin-bottom: 12px">
            <input
              id="worldBookKeyword"
              placeholder="关键词（如：角色名、地名）"
              style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
            />
            <button id="addWorldBookEntry" class="btn primary">添加</button>
          </div>
          <textarea
            id="worldBookContent"
            placeholder="描述内容（当出现关键词时，此内容会自动添加到对话上下文中）"
            style="
              width: 100%;
              padding: 8px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              min-height: 80px;
              resize: vertical;
            "
          ></textarea>
        </div>

        <div style="margin-bottom: 16px">
          <h4 style="margin: 0 0 8px 0; color: #333">已添加条目</h4>
          <div
            id="worldBookList"
            style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 8px"
          >
            <!-- 世界书条目将在这里显示 -->
          </div>
        </div>

        <div style="display: flex; gap: 8px">
          <button id="worldBookCancel" class="btn ghost" style="flex: 1">关闭</button>
          <button id="clearWorldBook" class="btn" style="flex: 1; background: #ff4757; color: white">清空全部</button>
        </div>
      </div>
    </div>

    <!-- 拍照模态框 -->
    <div id="cameraModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 350px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">📷 拍照描述</h3>
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; color: #666">用文字描述你想要的图片内容</label>
          <textarea
            id="cameraDescription"
            placeholder="例如：一只可爱的小猫坐在阳光下..."
            style="
              width: 100%;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              margin-top: 4px;
              min-height: 80px;
              resize: vertical;
            "
          ></textarea>
        </div>
        <div style="display: flex; gap: 8px">
          <button id="cameraCancel" class="btn ghost" style="flex: 1">取消</button>
          <button id="cameraConfirm" class="btn primary" style="flex: 1">发送描述</button>
        </div>
      </div>
    </div>

    <!-- 相册模态框 -->
    <div id="albumModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 350px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">🖼️ 选择图片</h3>
        </div>
        <div style="margin-bottom: 16px">
          <input type="file" id="albumFileInput" accept="image/*" style="display: none" />
          <button
            id="selectImageBtn"
            class="btn"
            style="width: 100%; padding: 20px; border: 2px dashed #ddd; background: #f9f9f9"
          >
            点击选择图片
          </button>
          <div id="imagePreview" style="margin-top: 12px; text-align: center"></div>
        </div>
        <div style="display: flex; gap: 8px">
          <button id="albumCancel" class="btn ghost" style="flex: 1">取消</button>
          <button id="albumConfirm" class="btn primary" style="flex: 1; display: none">发送图片</button>
        </div>
      </div>
    </div>

    <!-- Roll选项模态框 -->
    <div id="rollOptionsModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 250px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">🎲 选择操作</h3>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px">
          <button id="waitReplyBtn" class="btn primary" style="width: 100%">等待回复</button>
          <button id="rollBtn" class="btn" style="width: 100%; background: #f39c12; color: white">重新生成</button>
        </div>
      </div>
    </div>

    <!-- 聊天设置模态框 -->
    <div id="chatSettingsModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 400px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">⚙️ 聊天设置</h3>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">AI 昵称</label>
          <input
            id="chatCharName"
            placeholder="AI的名字"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">AI 头像URL</label>
          <input
            id="chatCharAvatar"
            placeholder="头像链接"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">AI 人设</label>
          <textarea
            id="chatCharPrompt"
            placeholder="AI的性格和行为设定..."
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb; min-height: 60px"
          ></textarea>
        </div>
        <hr style="margin: 16px 0; border: none; border-top: 1px solid #eee" />
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">你的昵称</label>
          <input
            id="chatUserName"
            placeholder="你的名字"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">你的头像URL</label>
          <input
            id="chatUserAvatar"
            placeholder="头像链接"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="display: flex; gap: 8px">
          <button id="chatSettingsCancel" class="btn ghost" style="flex: 1">取消</button>
          <button id="chatSettingsSave" class="btn primary" style="flex: 1">保存</button>
        </div>
      </div>
    </div>

    <script>
      // 全局函数定义（供onclick事件使用）
      function showTransferModal() {
        const modal = document.getElementById('transferModal');
        if (modal) {
          modal.classList.add('active');
          const activeChatName = window.activeChatName || '';
          document.getElementById('transferReceiver').value = activeChatName || '';
          document.getElementById('transferAmount').value = '';
          document.getElementById('transferNote').value = '';
        }
      }

      function showRedPacketModal() {
        const modal = document.getElementById('redPacketModal');
        if (modal) {
          modal.classList.add('active');
          document.getElementById('redPacketAmount').value = '';
          document.getElementById('redPacketCount').value = '1';
          document.getElementById('redPacketMessage').value = '恭喜发财，大吉大利';
        }
      }

      function showGroupChatModal() {
        const modal = document.getElementById('groupChatModal');
        if (modal) {
          modal.classList.add('active');
          document.getElementById('groupName').value = '';
          document.getElementById('groupAvatar').value = '';
          document.getElementById('groupDescription').value = '';
        }
      }

      function closeTransferModal() {
        const modal = document.getElementById('transferModal');
        if (modal) modal.classList.remove('active');
      }

      function closeRedPacketModal() {
        const modal = document.getElementById('redPacketModal');
        if (modal) modal.classList.remove('active');
      }

      function closeGroupChatModal() {
        const modal = document.getElementById('groupChatModal');
        if (modal) modal.classList.remove('active');
      }

      function showWorldBookModal() {
        const modal = document.getElementById('worldBookModal');
        if (modal) {
          modal.classList.add('active');
          loadWorldBookEntries();
        }
      }

      function closeWorldBookModal() {
        const modal = document.getElementById('worldBookModal');
        if (modal) modal.classList.remove('active');
      }

      // 拍照模态框
      function showCameraModal() {
        const modal = document.getElementById('cameraModal');
        if (modal) {
          modal.classList.add('active');
          document.getElementById('cameraDescription').value = '';
        }
      }

      function closeCameraModal() {
        const modal = document.getElementById('cameraModal');
        if (modal) modal.classList.remove('active');
      }

      // 相册模态框
      function showAlbumModal() {
        const modal = document.getElementById('albumModal');
        if (modal) {
          modal.classList.add('active');
          document.getElementById('imagePreview').innerHTML = '';
          document.getElementById('albumConfirm').style.display = 'none';
        }
      }

      function closeAlbumModal() {
        const modal = document.getElementById('albumModal');
        if (modal) modal.classList.remove('active');
      }

      // Roll选项模态框
      function showRollOptions() {
        const modal = document.getElementById('rollOptionsModal');
        if (modal) modal.classList.add('active');
      }

      function closeRollOptions() {
        const modal = document.getElementById('rollOptionsModal');
        if (modal) modal.classList.remove('active');
      }

      // 聊天设置
      function openChatSettings() {
        const modal = document.getElementById('chatSettingsModal');
        if (modal) {
          modal.classList.add('active');
          loadChatSettings();
        }
      }

      function closeChatSettings() {
        const modal = document.getElementById('chatSettingsModal');
        if (modal) modal.classList.remove('active');
      }

      // 删除模式
      let deleteMode = false;
      function toggleDeleteMode() {
        deleteMode = !deleteMode;
        const deleteBtn = document.getElementById('deleteBtn');
        const messages = document.querySelectorAll('#messages .bubble');

        if (deleteMode) {
          deleteBtn.style.background = '#ff4757';
          deleteBtn.style.color = 'white';
          // 为每个消息添加删除按钮
          messages.forEach((msg, index) => {
            if (!msg.querySelector('.delete-msg-btn')) {
              const delBtn = document.createElement('button');
              delBtn.className = 'delete-msg-btn';
              delBtn.innerHTML = '❌';
              delBtn.style.cssText =
                'position: absolute; top: -5px; right: -5px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;';
              delBtn.onclick = () => deleteMessage(index);
              msg.style.position = 'relative';
              msg.appendChild(delBtn);
            }
          });
        } else {
          deleteBtn.style.background = '';
          deleteBtn.style.color = '';
          // 移除所有删除按钮
          document.querySelectorAll('.delete-msg-btn').forEach(btn => btn.remove());
        }
      }

      function deleteMessage(index) {
        if (currentMessages && currentMessages[index]) {
          currentMessages.splice(index, 1);
          saveChat(activeChatName);
          // 重新渲染消息
          const messagesEl = document.getElementById('messages');
          messagesEl.innerHTML = '';
          currentMessages.forEach(m => renderMessage(m.content, m.role === 'user' ? 'me' : 'assistant'));
          // 重新进入删除模式
          deleteMode = false;
          toggleDeleteMode();
        }
      }

      function showMoreOptions() {
        alert('更多功能开发中...');
      }

      // 转账接收处理
      function showTransferReceived(receiver, amount, note) {
        const receivedCard = `
          <div class="transfer-received" style="
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            max-width: 250px;
            color: #2e7d32;
          ">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span style="color: #4caf50; margin-right: 8px;">✅</span>
              <span style="font-weight: bold;">转账已接收</span>
            </div>
            <div style="font-size: 18px; font-weight: bold; margin: 8px 0; color: #2e7d32;">¥${amount}</div>
            <div style="font-size: 12px; color: #666;">来自: ${receiver}</div>
            ${note ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${note}</div>` : ''}
            <div style="text-align: center; margin-top: 8px; font-size: 12px; color: #4caf50;">
              转账已到账
            </div>
          </div>
        `;
        appendMessage(receivedCard, 'assistant');
      }

      // 红包接收处理
      function showRedPacketReceived(type, amount, count, message) {
        const randomAmount =
          type === 'lucky'
            ? (Math.random() * parseFloat(amount)).toFixed(2)
            : (parseFloat(amount) / parseInt(count)).toFixed(2);
        const receivedCard = `
          <div class="redpacket-received" style="
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            max-width: 250px;
            text-align: center;
            color: #e65100;
          ">
            <div style="font-size: 24px; margin-bottom: 8px;">🎉</div>
            <div style="font-weight: bold; margin-bottom: 8px;">恭喜发财!</div>
            <div style="font-size: 20px; font-weight: bold; color: #ff5722; margin: 8px 0;">¥${randomAmount}</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${message}</div>
            <div style="font-size: 10px; color: #999;">
              ${type === 'lucky' ? '拼手气红包' : '普通红包'} · 已领取
            </div>
          </div>
        `;
        appendMessage(receivedCard, 'assistant');
      }

      (function () {
        const screens = ['chat-screen', 'settings-screen', 'qq-screen', 'api-screen'];
        document.querySelectorAll('.app-row .app').forEach(a =>
          a.addEventListener('click', e => {
            e.preventDefault();
            document.getElementById('app-row').style.display = 'none';
            screens.forEach(id => document.getElementById(id).classList.remove('active'));
            const t = a.getAttribute('data-screen');
            if (t) document.getElementById(t).classList.add('active');
          }),
        );
        document.querySelectorAll('.back-btn').forEach(b =>
          b.addEventListener('click', () => {
            document.getElementById('app-row').style.display = 'grid';
            screens.forEach(id => document.getElementById(id).classList.remove('active'));
          }),
        );

        // API form connect
        const apiForm = document.getElementById('apiForm');
        if (apiForm) {
          const apiUrl = document.getElementById('apiUrl');
          const apiKey = document.getElementById('apiKey');
          const modelSelect = document.getElementById('modelSelect');
          const statusEl = document.getElementById('status');
          function buildModelsUrl(base) {
            base = (base || '').replace(/\/$/, '');
            if (/\/v1(\/|$)/.test(base)) return base + '/models';
            return base + '/v1/models';
          }
          function buildChatUrl(base) {
            base = (base || '').replace(/\/$/, '');
            if (/\/v1(\/|$)/.test(base)) return base + '/chat/completions';
            return base + '/v1/chat/completions';
          }

          async function connectAndFillModels(showStatus = true) {
            try {
              if (showStatus && statusEl) statusEl.textContent = '连接中...';
              const base = (apiUrl.value || '').trim();
              const modelsUrl = buildModelsUrl(base);
              const res = await fetch(modelsUrl, {
                headers: apiKey.value ? { Authorization: 'Bearer ' + apiKey.value } : {},
              });
              const text = await res.text();
              if (!res.ok) {
                // show raw body for debugging
                const msg = `HTTP ${res.status} ${text}`;
                throw new Error(msg);
              }
              let j = {};
              try {
                j = JSON.parse(text || '{}');
              } catch (e) {
                // not JSON
                j = { data: [] };
              }
              const models = (j.data || j.models || []).map(m => m.id || m.name || m);
              modelSelect.innerHTML = '';
              models.forEach(m => {
                const o = document.createElement('option');
                o.value = m;
                o.textContent = m;
                modelSelect.appendChild(o);
              });
              modelSelect.style.display = 'block';
              if (models.length) {
                const savedModel = localStorage.getItem('api-model');
                if (savedModel && models.indexOf(savedModel) >= 0) modelSelect.value = savedModel;
                else modelSelect.value = models[0];
              }
              document.getElementById('saveBtn').classList.remove('hidden');
              // 自动保存当前有效配置，避免刷新丢失
              localStorage.setItem('api-url', apiUrl.value);
              localStorage.setItem('api-key', apiKey.value);
              if (modelSelect && modelSelect.value) localStorage.setItem('api-model', modelSelect.value);
              if (showStatus && statusEl) {
                statusEl.style.color = '#28a745';
                statusEl.textContent = '已连接';
                setTimeout(() => (statusEl.textContent = ''), 3500);
              }
              return true;
            } catch (err) {
              console.error('连接失败: ' + err.message);
              if (statusEl) {
                statusEl.style.color = '#f44';
                statusEl.textContent = '连接失败: ' + err.message;
                setTimeout(() => (statusEl.textContent = ''), 3500);
              }
              return false;
            }
          }

          apiForm.addEventListener('submit', async e => {
            e.preventDefault();
            await connectAndFillModels(true);
          });
          // 当用户更改模型时，保存选择
          if (modelSelect) {
            modelSelect.addEventListener('change', () => {
              if (modelSelect.value) localStorage.setItem('api-model', modelSelect.value);
            });
          }
          document.getElementById('saveBtn').addEventListener('click', () => {
            localStorage.setItem('api-url', apiUrl.value);
            localStorage.setItem('api-key', apiKey.value);
            // 如果有选中的模型一起保存
            if (modelSelect && modelSelect.value) localStorage.setItem('api-model', modelSelect.value);
            console.log('已保存 API 配置');
            if (statusEl) {
              statusEl.style.color = '#28a745';
              statusEl.textContent = '已保存';
              setTimeout(() => (statusEl.textContent = ''), 3500);
            }
          });
          apiUrl.value = localStorage.getItem('api-url') || '';
          apiKey.value = localStorage.getItem('api-key') || '';
          // 如果已有值，显示保存按钮，避免用户以为没有保存
          if ((apiUrl.value && apiUrl.value.trim()) || (apiKey.value && apiKey.value.trim())) {
            document.getElementById('saveBtn').classList.remove('hidden');
          }
          // 自动在输入变化时保存，确保刷新不会丢失（也便于调试）
          apiUrl.addEventListener('change', () => {
            localStorage.setItem('api-url', apiUrl.value || '');
            document.getElementById('saveBtn').classList.remove('hidden');
            if (statusEl) {
              statusEl.style.color = '#28a745';
              statusEl.textContent = '已保存';
              setTimeout(() => (statusEl.textContent = ''), 2000);
            }
          });
          apiKey.addEventListener('change', () => {
            localStorage.setItem('api-key', apiKey.value || '');
            document.getElementById('saveBtn').classList.remove('hidden');
            if (statusEl) {
              statusEl.style.color = '#28a745';
              statusEl.textContent = '已保存';
              setTimeout(() => (statusEl.textContent = ''), 2000);
            }
          });
          // 恢复上次保存的模型（若有）
          const savedModel = localStorage.getItem('api-model');
          if (savedModel) {
            // 如果之前保存了 url/key，尝试自动连接并恢复模型
            if (apiUrl.value && apiKey.value) {
              // 不显示连接提示（用户刷新时静默恢复）
              connectAndFillModels(false);
            }
          }

          // 历史功能已移除：为了匹配 UI 要求，相关历史存储与事件监听已删除
        }

        // 简单聊天交互
        const messagesEl = document.getElementById('messages');
        const inputBox = document.getElementById('inputBox');
        const sendBtn = document.getElementById('sendBtn');
        // 当前激活会话名与内存消息数组
        let activeChatName = null;
        let currentMessages = [];
        // 请求互斥标志，避免重复并发生成导致多条回复
        let pendingRequest = false;

        function saveChat(name) {
          if (!name) return;
          try {
            const data = JSON.stringify(currentMessages || []);
            localStorage.setItem('chat:' + name, data);
            console.log(`聊天记录已保存: ${name}, 消息数量: ${(currentMessages || []).length}`);
          } catch (e) {
            console.error('保存聊天到 localStorage 失败', e);
            // 尝试清理一些空间
            try {
              const keys = Object.keys(localStorage);
              keys.forEach(key => {
                if (key.startsWith('chat:') && !localStorage.getItem(key)) {
                  localStorage.removeItem(key);
                }
              });
              // 重试保存
              localStorage.setItem('chat:' + name, JSON.stringify(currentMessages || []));
            } catch (retryError) {
              console.error('重试保存也失败了', retryError);
            }
          }
        }

        function loadChat(name) {
          if (!name) return [];
          try {
            const txt = localStorage.getItem('chat:' + name);
            if (!txt) {
              console.log(`没有找到聊天记录: ${name}`);
              return [];
            }
            const data = JSON.parse(txt);
            console.log(`聊天记录已加载: ${name}, 消息数量: ${data.length}`);
            return data;
          } catch (e) {
            console.error('读取聊天失败', e);
            // 尝试修复损坏的数据
            try {
              localStorage.removeItem('chat:' + name);
              console.log(`已清理损坏的聊天记录: ${name}`);
            } catch (cleanupError) {
              console.error('清理失败', cleanupError);
            }
            return [];
          }
        }

        // 仅渲染消息到 DOM（不修改内存或 localStorage）
        function renderMessage(text, who) {
          const row = document.createElement('div');
          row.className = 'message-row ' + (who === 'me' ? 'me' : '');

          // avatar
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'avatar';
          // 决定头像：优先使用当前会话的专属设置，然后是全局设置
          try {
            if (who === 'me') {
              let ua = '';
              let uname = '';

              // 优先使用当前会话的用户设置
              if (activeChatName) {
                try {
                  const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
                  ua = meta.userAvatar || '';
                  uname = meta.userName || '';
                } catch (e) {}
              }

              // 如果当前会话没有设置，回退到全局设置
              if (!ua) ua = localStorage.getItem('user-avatar') || '';
              if (!uname) uname = localStorage.getItem('user-name') || '';

              if (ua) {
                const img = document.createElement('img');
                img.src = ua;
                avatarDiv.appendChild(img);
              } else {
                avatarDiv.textContent = uname && uname[0] ? uname[0] : '我';
              }
            } else {
              let a = '';
              let label = '';

              // 获取AI头像和名称
              if (activeChatName) {
                try {
                  const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
                  a = meta.avatar || '';
                  label = meta.name || activeChatName;
                } catch (e) {}
              }

              // 如果没有头像，回退到全局默认
              if (!a) a = localStorage.getItem('default-char-avatar') || '';

              if (a) {
                const img = document.createElement('img');
                img.src = a;
                avatarDiv.appendChild(img);
              } else {
                avatarDiv.textContent = label && label[0] ? label[0] : 'AI';
              }
            }
          } catch (e) {
            avatarDiv.textContent = who === 'me' ? '我' : 'AI';
          }

          const bubble = document.createElement('div');
          bubble.className = 'bubble ' + (who === 'me' ? 'me' : '');
          bubble.innerText = text;

          if (who === 'me') {
            row.appendChild(bubble);
            row.appendChild(avatarDiv);
          } else {
            row.appendChild(avatarDiv);
            row.appendChild(bubble);
          }

          messagesEl.appendChild(row);
        }

        // 追加消息并保存到当前会话
        function appendMessage(text, who) {
          renderMessage(text, who);
          messagesEl.scrollTop = messagesEl.scrollHeight;
          // 保存到当前会话
          if (activeChatName) {
            currentMessages.push({ role: who === 'me' ? 'user' : 'assistant', content: text, ts: Date.now() });
            saveChat(activeChatName);
          }
        }
        // 将请求逻辑提取为一个可复用函数：requestReply(text, { appendUser: true/false })
        async function requestReply(text, opts = { appendUser: true }) {
          const t = (text || '').trim();
          if (!t) return;
          if (pendingRequest) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
              statusEl.style.color = '#f5a623';
              statusEl.textContent = '正在生成中，请稍候...';
              setTimeout(() => (statusEl.textContent = ''), 1800);
            }
            return;
          }
          pendingRequest = true;
          // 禁用发送与重生按钮以避免并发
          const rollFooterEl = document.getElementById('rollFooterBtn');
          if (rollFooterEl) rollFooterEl.disabled = true;
          if (sendBtn) sendBtn.disabled = true;
          if (opts.appendUser) {
            appendMessage(t, 'me');
          }

          // 应用世界书
          let worldBookContext = '';
          try {
            worldBookContext = applyWorldBook(t);
          } catch (e) {
            console.error('世界书应用失败', e);
          }

          // 从配置读取 endpoint/key/model
          const base =
            (document.getElementById('apiUrl') && document.getElementById('apiUrl').value) ||
            localStorage.getItem('api-url') ||
            '';
          const key =
            (document.getElementById('apiKey') && document.getElementById('apiKey').value) ||
            localStorage.getItem('api-key') ||
            '';
          const model =
            (document.getElementById('modelSelect') && document.getElementById('modelSelect').value) ||
            localStorage.getItem('api-model') ||
            '';

          if (!base || !key) {
            // 没有配置 API，就不发请求（保持本地展示）
            return;
          }

          // 显示正在输入的 typing 指示器
          const typing = document.createElement('div');
          typing.className = 'bubble';
          const span = document.createElement('div');
          span.className = 'typing-dots';
          span.innerHTML = '<span></span><span></span><span></span>';
          typing.appendChild(span);
          messagesEl.appendChild(typing);
          messagesEl.scrollTop = messagesEl.scrollHeight;

          try {
            const url = buildChatUrl(base);
            // 尝试注入 system prompt（会话级别优先，然后默认设置）
            let sysPrompt = '';
            try {
              if (activeChatName) {
                const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
                if (meta && meta.prompt) sysPrompt = meta.prompt;
              }
            } catch (e) {}
            if (!sysPrompt) sysPrompt = localStorage.getItem('default-char-prompt') || '';

            const messagesPayload = [];
            // 注入用户元数据，让模型知道 user 的名字等（作为 system 描述）
            try {
              const uname = localStorage.getItem('user-name') || '';
              if (uname) messagesPayload.push({ role: 'system', content: `User name: ${uname}` });
            } catch (e) {}
            if (sysPrompt) messagesPayload.push({ role: 'system', content: sysPrompt });

            // 添加世界书上下文
            if (worldBookContext) {
              messagesPayload.push({ role: 'system', content: `世界书信息: ${worldBookContext}` });
            }

            messagesPayload.push({ role: 'user', content: t });

            const body = {
              model: model || undefined,
              messages: messagesPayload,
              temperature: 0.7,
            };
            const res = await fetch(url, {
              method: 'POST',
              headers: Object.assign(
                { 'Content-Type': 'application/json' },
                key ? { Authorization: 'Bearer ' + key } : {},
              ),
              body: JSON.stringify(body),
            });
            const raw = await res.text();
            if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + raw);
            let j = {};
            try {
              j = JSON.parse(raw || '{}');
            } catch (e) {
              j = {};
            }
            let reply = '';
            if (j.choices && j.choices[0])
              reply = (j.choices[0].message && j.choices[0].message.content) || j.choices[0].text || '';
            if (!reply && j.text) reply = j.text;
            typing.remove();
            if (reply) appendMessage(reply, 'assistant');
            else appendMessage('[空响应]', 'assistant');
          } catch (err) {
            typing.remove();
            appendMessage('[请求失败] ' + err.message, 'assistant');
            const statusEl = document.getElementById('status');
            if (statusEl) {
              statusEl.style.color = '#f44';
              statusEl.textContent = '请求失败: ' + err.message;
              setTimeout(() => (statusEl.textContent = ''), 4000);
            }
          } finally {
            pendingRequest = false;
            const rollFooterEl2 = document.getElementById('rollFooterBtn');
            if (rollFooterEl2) rollFooterEl2.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
          }
        }

        if (sendBtn)
          sendBtn.addEventListener('click', () => {
            const t = (inputBox.value || '').trim();
            if (!t) return;
            inputBox.value = '';
            // 只发送消息，不请求AI回复
            appendMessage(t, 'me');
          });

        // API 响应相关已移除

        // QQ 占位渲染（不使用示例对话）
        function renderQQPlaceholder() {
          const list = document.getElementById('qq-session-list');
          if (!list) return;
          if (!list.children.length) {
            list.innerHTML = '<div class="placeholder-qq">暂无会话，点击右上角添加一个</div>';
          }
        }
        renderQQPlaceholder();

        // 添加会话模态（在页面底部有对应 DOM）
        const addBtn = document.getElementById('addPersonaBtn');
        const addModal = document.getElementById('addModal');
        const charInput = document.getElementById('charNameInput');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const confirmAddBtn = document.getElementById('confirmAddBtn');

        if (addBtn)
          addBtn.addEventListener('click', () => {
            if (addModal) {
              addModal.classList.add('active');
              if (charInput) {
                // 新建时清空输入，仅将 default 名称作为 placeholder 提示
                const def = localStorage.getItem('default-char-name') || '';
                charInput.value = '';
                charInput.placeholder = def || '例如：汉堡堡';
                charInput.focus();
              }
            }
          });
        if (cancelAddBtn)
          cancelAddBtn.addEventListener('click', () => {
            if (addModal) addModal.classList.remove('active');
          });
        if (confirmAddBtn)
          confirmAddBtn.addEventListener('click', () => {
            const name = (charInput && charInput.value.trim()) || localStorage.getItem('default-char-name') || '汉堡堡';
            const list = document.getElementById('qq-session-list');
            if (!list) return;

            // 检查是否已存在同名会话
            const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
            if (sessions.indexOf(name) !== -1) {
              alert('会话名称已存在，请使用其他名称');
              return;
            }

            const placeholder = list.querySelector('.placeholder-qq');
            if (placeholder) placeholder.remove();
            const el = document.createElement('div');
            el.className = 'qq-session';

            // 为新会话创建独立的设置
            const metaKey = 'chatmeta:' + name;
            const newMeta = {
              name: name,
              avatar: '', // 新会话不继承头像
              prompt: '', // 新会话不继承提示
              userName: '', // 新会话使用独立的用户设置
              userAvatar: '', // 新会话使用独立的用户头像
              isGroup: false,
            };

            try {
              localStorage.setItem(metaKey, JSON.stringify(newMeta));
              console.log(`[CREATE] 创建新会话: ${name}，独立设置已初始化`);
            } catch (e) {
              console.error('初始化会话设置失败', e);
            }

            // 渲染会话项（新会话使用首字母头像）
            el.innerHTML = `<div class="qq-avatar">${
              name[0] || '我'
            }</div><div class="info"><div class="name">${name} <span class="meta">· 刚刚</span></div><div class="msg">与 ${name} 的对话</div></div><button class="qq-del">删除</button>`;

            list.insertBefore(el, list.firstChild);

            // persist sessions list
            try {
              sessions.push(name);
              localStorage.setItem('qq-sessions', JSON.stringify(sessions));

              // 刷新 UI
              try {
                renderUserDisplay();
                refreshSessionListAvatars();
                refreshMessageAvatars();
              } catch (e) {}
            } catch (e) {
              console.error('保存会话列表失败', e);
            }
            if (addModal) addModal.classList.remove('active');
          });
        if (addModal)
          addModal.addEventListener('click', e => {
            if (e.target === addModal) addModal.classList.remove('active');
          });
        // 模态确认工具，返回 Promise<boolean>
        const confirmModalEl = document.getElementById('confirmModal');
        const confirmOkBtn = document.getElementById('confirmOk');
        const confirmCancelBtn = document.getElementById('confirmCancel');
        const confirmTitleEl = document.getElementById('confirmTitle');
        const confirmBodyEl = document.getElementById('confirmBody');
        function showConfirm(title, body) {
          return new Promise(resolve => {
            if (!confirmModalEl) return resolve(window.confirm(body));
            confirmTitleEl.textContent = title || '确认';
            confirmBodyEl.textContent = body || '';
            confirmModalEl.classList.add('active');
            function done(val) {
              confirmModalEl.classList.remove('active');
              confirmOkBtn.removeEventListener('click', onOk);
              confirmCancelBtn.removeEventListener('click', onCancel);
              resolve(val);
            }
            function onOk() {
              done(true);
            }
            function onCancel() {
              done(false);
            }
            confirmOkBtn.addEventListener('click', onOk);
            confirmCancelBtn.addEventListener('click', onCancel);
          });
        }
        // 设置模态交互：打开/读取/保存
        const settingsModal = document.getElementById('settingsModal');
        const settingsCharName = document.getElementById('settingsCharName');
        const settingsCharAvatar = document.getElementById('settingsCharAvatar');
        const settingsCharPrompt = document.getElementById('settingsCharPrompt');
        const settingsUserName = document.getElementById('settingsUserName');
        const settingsUserAvatar = document.getElementById('settingsUserAvatar');
        const settingsSaveBtn = document.getElementById('settingsSave');
        const settingsCancelBtn = document.getElementById('settingsCancel');

        function openSettingsModal() {
          if (!settingsModal) return;
          settingsModal.classList.add('active');

          // 根据当前会话加载设置
          if (activeChatName) {
            try {
              // 加载当前会话的专属设置
              const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');

              settingsCharName.value = meta.name || activeChatName || '';
              settingsCharAvatar.value = meta.avatar || '';
              settingsCharPrompt.value = meta.prompt || '';
              settingsUserName.value = meta.userName || localStorage.getItem('user-name') || '';
              settingsUserAvatar.value = meta.userAvatar || localStorage.getItem('user-avatar') || '';

              console.log(`[SETTINGS] 已加载会话设置: ${activeChatName}`, meta);
            } catch (e) {
              console.error('加载会话设置失败，使用默认设置', e);
              // fallback到全局设置
              settingsCharName.value = localStorage.getItem('default-char-name') || '';
              settingsCharAvatar.value = localStorage.getItem('default-char-avatar') || '';
              settingsCharPrompt.value = localStorage.getItem('default-char-prompt') || '';
              settingsUserName.value = localStorage.getItem('user-name') || '';
              settingsUserAvatar.value = localStorage.getItem('user-avatar') || '';
            }
          } else {
            // 没有激活会话时，加载全局默认设置
            settingsCharName.value = localStorage.getItem('default-char-name') || '';
            settingsCharAvatar.value = localStorage.getItem('default-char-avatar') || '';
            settingsCharPrompt.value = localStorage.getItem('default-char-prompt') || '';
            settingsUserName.value = localStorage.getItem('user-name') || '';
            settingsUserAvatar.value = localStorage.getItem('user-avatar') || '';
          }

          // 预览已保存的头像（如果是 dataURL 或 URL）
          try {
            previewImageEl(document.getElementById('settingsCharAvatarPreview'), settingsCharAvatar.value);
          } catch (e) {}
          try {
            previewImageEl(document.getElementById('settingsUserAvatarPreview'), settingsUserAvatar.value);
          } catch (e) {}
        }

        function closeSettingsModal() {
          if (!settingsModal) return;
          settingsModal.classList.remove('active');
        }
        // 更新聊天界面的联系人信息
        function updateChatContactInfo() {
          if (!activeChatName) return;

          try {
            // 更新聊天标题
            const chatTitle = document.getElementById('chatTitle');
            const contactStatus = document.getElementById('contactStatus');
            const contactAvatar = document.getElementById('contactAvatar');

            // 获取当前会话的设置
            const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');

            // 更新标题
            if (chatTitle) {
              chatTitle.textContent = meta.name || activeChatName;
            }

            // 更新状态
            if (contactStatus) {
              contactStatus.textContent = meta.isGroup ? '群聊' : '在线';
            }

            // 更新头像
            if (contactAvatar) {
              contactAvatar.innerHTML = '';
              if (meta.avatar) {
                const img = document.createElement('img');
                img.src = meta.avatar;
                contactAvatar.appendChild(img);
              } else {
                contactAvatar.textContent = (meta.name || activeChatName)[0] || 'AI';
              }
            }
          } catch (e) {
            console.error('更新联系人信息失败', e);
          }
        }

        // 调试用的短提示（用于确认事件被触发）
        function showDebugToast(msg) {
          try {
            let t = document.getElementById('debugToast');
            if (!t) {
              t = document.createElement('div');
              t.id = 'debugToast';
              t.style.position = 'fixed';
              t.style.left = '50%';
              t.style.top = '8%';
              t.style.transform = 'translateX(-50%)';
              t.style.background = 'rgba(0,0,0,0.7)';
              t.style.color = '#fff';
              t.style.padding = '8px 12px';
              t.style.borderRadius = '6px';
              t.style.zIndex = '9999';
              document.body.appendChild(t);
            }
            t.textContent = msg || 'debug';
            t.style.display = 'block';
            setTimeout(() => (t.style.display = 'none'), 2000);
          } catch (e) {}
        }

        // 将设置保存到 localStorage
        if (settingsSaveBtn)
          settingsSaveBtn.addEventListener('click', () => {
            try {
              const cname = (settingsCharName && settingsCharName.value.trim()) || '';
              const cavatar = (settingsCharAvatar && settingsCharAvatar.value) || '';
              const cprompt = (settingsCharPrompt && settingsCharPrompt.value) || '';
              const uname = (settingsUserName && settingsUserName.value) || '';
              const uavatar = (settingsUserAvatar && settingsUserAvatar.value) || '';

              // 如果当前有激活的聊天会话，保存到会话专属设置
              if (activeChatName) {
                try {
                  const metaKey = 'chatmeta:' + activeChatName;
                  const meta = JSON.parse(localStorage.getItem(metaKey) || '{}');

                  // 保存AI设置到当前会话
                  if (cname) meta.name = cname;
                  if (cavatar) meta.avatar = cavatar;
                  if (cprompt) meta.prompt = cprompt;

                  // 保存用户设置到当前会话
                  meta.userName = uname;
                  meta.userAvatar = uavatar;

                  localStorage.setItem(metaKey, JSON.stringify(meta));
                  console.log(`[SETTINGS] 已保存会话专属设置: ${activeChatName}`, meta);
                } catch (e) {
                  console.error('保存会话设置失败', e);
                }
              } else {
                // 没有激活会话时，保存为全局默认设置
                localStorage.setItem('default-char-name', cname);
                localStorage.setItem('default-char-avatar', cavatar);
                localStorage.setItem('default-char-prompt', cprompt);
                localStorage.setItem('user-name', uname);
                localStorage.setItem('user-avatar', uavatar);
                console.log('[SETTINGS] 已保存全局默认设置');
              }

              // 简短提示
              const statusEl = document.getElementById('status');
              if (statusEl) {
                statusEl.style.color = '#28a745';
                statusEl.textContent = '已保存设置';
                setTimeout(() => (statusEl.textContent = ''), 2000);
              }

              // 更新当前显示
              try {
                renderUserDisplay();
                refreshSessionListAvatars();
                refreshMessageAvatars();

                // 如果在聊天界面，更新联系人信息
                if (activeChatName) {
                  updateChatContactInfo();
                }
              } catch (e) {
                console.error('更新显示失败', e);
              }
              // 如果当前打开了会话并且修改了 AI 名称，尝试重命名当前会话并迁移数据
              try {
                const newChar = (settingsCharName && settingsCharName.value && settingsCharName.value.trim()) || '';
                if (newChar && activeChatName && newChar !== activeChatName) {
                  // 如果目标名已存在，提示并跳过迁移
                  if (localStorage.getItem('chat:' + newChar)) {
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                      statusEl.style.color = '#f44';
                      statusEl.textContent = '会话名已存在，未执行重命名';
                      setTimeout(() => (statusEl.textContent = ''), 3000);
                    }
                  } else {
                    // 迁移聊天记录
                    try {
                      const oldChat = localStorage.getItem('chat:' + activeChatName);
                      if (oldChat != null) {
                        localStorage.setItem('chat:' + newChar, oldChat);
                        localStorage.removeItem('chat:' + activeChatName);
                      }
                    } catch (e) {}
                    // 迁移 meta
                    try {
                      const oldMeta = localStorage.getItem('chatmeta:' + activeChatName);
                      if (oldMeta != null) {
                        localStorage.setItem('chatmeta:' + newChar, oldMeta);
                        localStorage.removeItem('chatmeta:' + activeChatName);
                      }
                    } catch (e) {}
                    // 更新 qq-sessions 列表
                    try {
                      const list = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
                      const idx = list.indexOf(activeChatName);
                      if (idx >= 0) {
                        list[idx] = newChar;
                        localStorage.setItem('qq-sessions', JSON.stringify(list));
                      }
                      // 更新 DOM 列表项文本
                      const qqListEl = document.getElementById('qq-session-list');
                      if (qqListEl) {
                        const items = qqListEl.querySelectorAll('.qq-session');
                        items.forEach(it => {
                          const nameEl = it.querySelector('.name');
                          if (nameEl && nameEl.childNodes[0].textContent.trim() === activeChatName) {
                            nameEl.childNodes[0].textContent = newChar;
                          }
                        });
                      }
                    } catch (e) {}
                    // 切换 activeChatName 并重新加载消息区
                    try {
                      activeChatName = newChar;
                      const messages = document.getElementById('messages');
                      if (messages) {
                        messages.innerHTML = '';
                        currentMessages = loadChat(activeChatName) || [];
                        currentMessages.forEach(m => renderMessage(m.content, m.role === 'user' ? 'me' : 'assistant'));
                      }
                      const navStrong = document.querySelector('#chat-screen .nav strong');
                      if (navStrong) navStrong.textContent = activeChatName;
                    } catch (e) {}
                  }
                }
              } catch (e) {}
              // 迁移与保存逻辑完成后，后续会在写入 avatar 后统一刷新 UI
            } catch (e) {
              console.error('保存设置失败', e);
            }
            // 保存后更新预览并存储可能为 dataURL 的头像，并同步到当前会话的 meta（如果用户填写了）
            try {
              const ca = (settingsCharAvatar && settingsCharAvatar.value) || '';
              const ua = (settingsUserAvatar && settingsUserAvatar.value) || '';
              if (ca) localStorage.setItem('default-char-avatar', ca);
              if (ua) localStorage.setItem('user-avatar', ua);
              // 如果当前有激活会话且用户在设置中指定了 AI 头像，则同步到该会话的 chatmeta
              if (ca && activeChatName) {
                try {
                  const metaKey = 'chatmeta:' + activeChatName;
                  const meta = JSON.parse(localStorage.getItem(metaKey) || '{}');
                  meta.avatar = ca;
                  localStorage.setItem(metaKey, JSON.stringify(meta));
                } catch (e) {}
              }
              // 强制覆盖所有会话的 avatar（若 ca 为空则移除所有会话 avatar），保证设置能立即同步到会话列表和消息区
              try {
                const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
                sessions.forEach(n => {
                  try {
                    const key = 'chatmeta:' + n;
                    const m = JSON.parse(localStorage.getItem(key) || '{}');
                    if (ca) {
                      m.avatar = ca;
                    } else {
                      if (m.hasOwnProperty('avatar')) delete m.avatar;
                    }
                    localStorage.setItem(key, JSON.stringify(m));
                  } catch (e) {}
                });
              } catch (e) {}
            } catch (e) {}
            try {
              // 将全局设置同步到所有会话
              syncGlobalSettingsToSessions(true);
              renderUserDisplay();
              refreshSessionListAvatars();
              refreshMessageAvatars();
            } catch (e) {}
            closeSettingsModal();
          });
        if (settingsCancelBtn) settingsCancelBtn.addEventListener('click', closeSettingsModal);
        if (settingsModal)
          settingsModal.addEventListener('click', e => {
            if (e.target === settingsModal) closeSettingsModal();
          });

        // 转账模态框事件监听器
        const transferModal = document.getElementById('transferModal');
        const transferConfirm = document.getElementById('transferConfirm');
        const transferCancel = document.getElementById('transferCancel');

        if (transferConfirm) {
          transferConfirm.addEventListener('click', () => {
            const receiver = document.getElementById('transferReceiver').value;
            const amount = document.getElementById('transferAmount').value;
            const note = document.getElementById('transferNote').value;

            if (!receiver || !amount) {
              alert('请填写收款人和转账金额');
              return;
            }

            // 发送QQ风格的转账卡片
            const transferCard = `
              <div class="transfer-card" style="
                background: linear-gradient(135deg, #ff9a8b 0%, #a8e6cf 100%);
                border-radius: 12px;
                padding: 16px;
                margin: 8px 0;
                color: white;
                max-width: 250px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              ">
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                  <span style="font-size: 24px; margin-right: 8px;">💰</span>
                  <span style="font-weight: bold;">转账给 ${receiver}</span>
                </div>
                <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">¥${amount}</div>
                ${note ? `<div style="font-size: 12px; opacity: 0.9;">${note}</div>` : ''}
                <div style="text-align: center; margin-top: 12px;">
                  <button onclick="showTransferReceived('${receiver}', '${amount}', '${note}')" 
                          style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer;">
                    查看转账
                  </button>
                </div>
              </div>
            `;
            appendMessage(transferCard, 'me');
            closeTransferModal();
          });
        }

        if (transferCancel) transferCancel.addEventListener('click', closeTransferModal);
        if (transferModal) {
          transferModal.addEventListener('click', e => {
            if (e.target === transferModal) closeTransferModal();
          });
        }

        // 红包模态框事件监听器
        const redPacketModal = document.getElementById('redPacketModal');
        const redPacketConfirm = document.getElementById('redPacketConfirm');
        const redPacketCancel = document.getElementById('redPacketCancel');

        if (redPacketConfirm) {
          redPacketConfirm.addEventListener('click', () => {
            const type = document.getElementById('redPacketType').value;
            const amount = document.getElementById('redPacketAmount').value;
            const count = document.getElementById('redPacketCount').value;
            const message = document.getElementById('redPacketMessage').value;

            if (!amount) {
              alert('请填写红包金额');
              return;
            }

            // 发送QQ风格的红包卡片
            const typeText = type === 'lucky' ? '拼手气红包' : '普通红包';
            const redPacketCard = `
              <div class="redpacket-card" style="
                background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
                border-radius: 12px;
                padding: 16px;
                margin: 8px 0;
                color: white;
                max-width: 250px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                text-align: center;
              ">
                <div style="font-size: 32px; margin-bottom: 8px;">🧧</div>
                <div style="font-weight: bold; margin-bottom: 4px;">${message}</div>
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">${typeText}</div>
                <div style="font-size: 18px; font-weight: bold;">¥${amount} × ${count}个</div>
                <div style="margin-top: 12px;">
                  <button onclick="showRedPacketReceived('${type}', '${amount}', '${count}', '${message}')" 
                          style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer;">
                    开红包
                  </button>
                </div>
              </div>
            `;
            appendMessage(redPacketCard, 'me');
            closeRedPacketModal();
          });
        }

        if (redPacketCancel) redPacketCancel.addEventListener('click', closeRedPacketModal);
        if (redPacketModal) {
          redPacketModal.addEventListener('click', e => {
            if (e.target === redPacketModal) closeRedPacketModal();
          });
        }

        // 群聊模态框事件监听器
        const groupChatModal = document.getElementById('groupChatModal');
        const groupConfirm = document.getElementById('groupConfirm');
        const groupCancel = document.getElementById('groupCancel');

        if (groupConfirm) {
          groupConfirm.addEventListener('click', () => {
            const name = document.getElementById('groupName').value;
            const avatar = document.getElementById('groupAvatar').value;
            const description = document.getElementById('groupDescription').value;

            if (!name) {
              alert('请填写群聊名称');
              return;
            }

            // 创建群聊会话
            try {
              const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
              const groupName = `[群] ${name}`;

              if (sessions.indexOf(groupName) === -1) {
                sessions.push(groupName);
                localStorage.setItem('qq-sessions', JSON.stringify(sessions));

                // 保存群聊元数据
                const groupMeta = {
                  name: groupName,
                  avatar: avatar || '',
                  prompt: description || `这是一个名为"${name}"的群聊`,
                  isGroup: true,
                };
                localStorage.setItem('chatmeta:' + groupName, JSON.stringify(groupMeta));

                // 重新渲染会话列表
                initQQSessionList();

                alert(`群聊"${name}"创建成功！`);
              } else {
                alert('群聊名称已存在');
              }
            } catch (e) {
              console.error('创建群聊失败', e);
              alert('创建群聊失败');
            }

            closeGroupChatModal();
          });
        }

        if (groupCancel) groupCancel.addEventListener('click', closeGroupChatModal);
        if (groupChatModal) {
          groupChatModal.addEventListener('click', e => {
            if (e.target === groupChatModal) closeGroupChatModal();
          });
        }

        // 上传按钮与 file input 行为
        const settingsCharUploadBtn = document.getElementById('settingsCharUploadBtn');
        const settingsCharAvatarFile = document.getElementById('settingsCharAvatarFile');
        const settingsCharAvatarPreview = document.getElementById('settingsCharAvatarPreview');
        const settingsUserUploadBtn = document.getElementById('settingsUserUploadBtn');
        const settingsUserAvatarFile = document.getElementById('settingsUserAvatarFile');
        const settingsUserAvatarPreview = document.getElementById('settingsUserAvatarPreview');

        function previewImageEl(container, src) {
          if (!container) return;
          container.innerHTML = '';
          if (!src) return;
          const img = document.createElement('img');
          img.src = src;
          img.style.width = '48px';
          img.style.height = '48px';
          img.style.borderRadius = '6px';
          img.style.objectFit = 'cover';
          container.appendChild(img);
        }

        if (settingsCharUploadBtn && settingsCharAvatarFile) {
          settingsCharUploadBtn.addEventListener('click', () => settingsCharAvatarFile.click());
          settingsCharAvatarFile.addEventListener('change', e => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
              const data = ev.target.result;
              settingsCharAvatar.value = data;
              previewImageEl(settingsCharAvatarPreview, data);
            };
            r.readAsDataURL(f);
          });
        }
        if (settingsUserUploadBtn && settingsUserAvatarFile) {
          settingsUserUploadBtn.addEventListener('click', () => settingsUserAvatarFile.click());
          settingsUserAvatarFile.addEventListener('change', e => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
              const data = ev.target.result;
              settingsUserAvatar.value = data;
              previewImageEl(settingsUserAvatarPreview, data);
            };
            r.readAsDataURL(f);
          });
        }

        // 在主设置页的齿轮按钮上挂载打开设置模态
        document.querySelectorAll('.btn.ghost[title="设置"]').forEach(b =>
          b.addEventListener('click', e => {
            e.preventDefault();
            openSettingsModal();
          }),
        );
        // 渲染用户显示（头像与名字）
        // 顶部头像显示：显示当前会话（AI）头像，若无则显示默认角色头像
        function renderUserDisplay() {
          const disp = document.getElementById('userDisplay');
          if (!disp) return;
          disp.innerHTML = '';
          let a = '';
          try {
            if (activeChatName) {
              const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
              a = meta && meta.avatar;
            }
          } catch (e) {}
          if (!a) a = localStorage.getItem('default-char-avatar') || '';
          if (a) {
            const i = document.createElement('img');
            i.src = a;
            i.alt = activeChatName || 'AI';
            i.style.width = '28px';
            i.style.height = '28px';
            i.style.borderRadius = '50%';
            disp.appendChild(i);
          } else {
            const s = document.createElement('div');
            const label =
              (activeChatName && activeChatName[0]) || (localStorage.getItem('default-char-name') || 'A')[0];
            s.textContent = label;
            s.style.width = '28px';
            s.style.height = '28px';
            s.style.borderRadius = '50%';
            s.style.background = 'linear-gradient(180deg,#fff,#eef7ff)';
            s.style.display = 'flex';
            s.style.alignItems = 'center';
            s.style.justifyContent = 'center';
            s.style.fontWeight = '700';
            disp.appendChild(s);
          }
        }

        // 刷新会话列表中的头像显示（如果 chatmeta 中有 avatar）
        function refreshSessionListAvatars() {
          const list = document.getElementById('qq-session-list');
          if (!list) return;
          Array.from(list.querySelectorAll('.qq-session')).forEach(el => {
            const nameEl = el.querySelector('.name');
            const name = nameEl ? nameEl.childNodes[0].textContent.trim() : null;
            if (!name) return;
            try {
              const meta = JSON.parse(localStorage.getItem('chatmeta:' + name) || '{}');
              const avatar = meta && meta.avatar;
              const avatarContainer = el.querySelector('.qq-avatar');
              if (avatar && avatarContainer) {
                avatarContainer.innerHTML = `<img src="${avatar}" alt="avatar" style="width:100%;height:100%;border-radius:50%"/>`;
              } else if (avatarContainer) {
                // 无 avatar 时回退为首字母占位，避免保留旧图片
                const ch = (name && name[0]) || '我';
                avatarContainer.innerHTML = '';
                avatarContainer.textContent = ch;
              }
            } catch (e) {}
          });
        }
        // 刷新消息区中的头像（用于设置修改后同步已渲染的消息）
        function refreshMessageAvatars() {
          const msgs = document.getElementById('messages');
          if (!msgs) return;
          Array.from(msgs.querySelectorAll('.message-row')).forEach(row => {
            const isMe = row.classList.contains('me');
            const avatarDiv = row.querySelector('.avatar');
            if (!avatarDiv) return;
            avatarDiv.innerHTML = '';
            try {
              if (isMe) {
                const ua = localStorage.getItem('user-avatar') || '';
                const uname = localStorage.getItem('user-name') || '';
                if (ua) {
                  const img = document.createElement('img');
                  img.src = ua;
                  avatarDiv.appendChild(img);
                } else {
                  avatarDiv.textContent = uname && uname[0] ? uname[0] : '我';
                }
              } else {
                let a = '';
                if (activeChatName) {
                  try {
                    const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
                    a = meta && meta.avatar;
                  } catch (e) {}
                }
                if (!a) a = localStorage.getItem('default-char-avatar') || '';
                if (a) {
                  const img = document.createElement('img');
                  img.src = a;
                  avatarDiv.appendChild(img);
                } else {
                  const label = activeChatName && activeChatName[0] ? activeChatName[0] : 'AI';
                  avatarDiv.textContent = label;
                }
              }
            } catch (e) {
              avatarDiv.textContent = isMe ? '我' : 'AI';
            }
          });
        }

        // 将全局默认设置同步到所有会话的 chatmeta（force = true 时强制覆盖）
        function syncGlobalSettingsToSessions(force = true) {
          try {
            const defName = localStorage.getItem('default-char-name') || '';
            const defAvatar = localStorage.getItem('default-char-avatar') || '';
            const defPrompt = localStorage.getItem('default-char-prompt') || '';
            const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
            sessions.forEach(n => {
              try {
                const key = 'chatmeta:' + n;
                const m = JSON.parse(localStorage.getItem(key) || '{}');
                if (force) {
                  // 覆盖或写入默认字段
                  if (defName) m.name = defName; // 仅当 defName 非空时写入
                  if (defAvatar) m.avatar = defAvatar;
                  else if (!defAvatar && m.hasOwnProperty('avatar')) delete m.avatar;
                  if (defPrompt) m.prompt = defPrompt;
                  else if (!defPrompt && m.hasOwnProperty('prompt')) delete m.prompt;
                } else {
                  if (!m.avatar && defAvatar) m.avatar = defAvatar;
                  if (!m.prompt && defPrompt) m.prompt = defPrompt;
                }
                const after = JSON.stringify(m);
                localStorage.setItem(key, after);
                try {
                  console.log('[SYNC] session', n, 'after:', after);
                } catch (e) {}
              } catch (e) {}
            });
          } catch (e) {}
        }
        // 首次渲染用户显示
        renderUserDisplay();

        // 页面加载时初始化数据同步
        function initializeApp() {
          try {
            // 同步全局设置到所有会话
            syncGlobalSettingsToSessions(false); // 不强制覆盖已有设置

            // 刷新所有头像显示
            refreshSessionListAvatars();
            refreshMessageAvatars();

            // 重新渲染用户显示
            renderUserDisplay();

            console.log('应用初始化完成，数据已同步');
          } catch (e) {
            console.error('应用初始化失败:', e);
          }
        }

        // 页面加载完成后立即初始化
        initializeApp();

        // 添加页面可见性变化监听器，确保切换回页面时数据同步
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            // 页面变为可见时重新同步数据
            setTimeout(initializeApp, 100);
          }
        });

        // 添加窗口焦点监听器，确保窗口获得焦点时数据同步
        window.addEventListener('focus', () => {
          setTimeout(initializeApp, 100);
        });

        // 在切换到聊天界面时，确保数据同步
        function openChat(name) {
          document.getElementById('app-row').style.display = 'none';
          ['chat-screen', 'settings-screen', 'qq-screen', 'api-screen'].forEach(id =>
            document.getElementById(id).classList.remove('active'),
          );
          document.getElementById('chat-screen').classList.add('active');
          const navStrong = document.querySelector('#chat-screen .nav strong');
          if (navStrong) navStrong.textContent = name;
          const messages = document.getElementById('messages');
          if (messages) {
            messages.innerHTML = '';
            activeChatName = name;
            currentMessages = loadChat(name) || [];
            if (currentMessages.length) {
              currentMessages.forEach(m => {
                renderMessage(m.content, m.role === 'user' ? 'me' : 'assistant');
              });
            }
            // 渲染完成后滚动到底部
            messages.scrollTop = messages.scrollHeight;
          }

          // 确保切换会话时头像和数据同步
          try {
            renderUserDisplay();
            refreshMessageAvatars();
            updateChatContactInfo(); // 更新聊天界面的联系人信息
          } catch (e) {
            console.error('切换会话时同步数据失败:', e);
          }
        }
        const qqList = document.getElementById('qq-session-list');
        if (qqList) {
          qqList.addEventListener('click', async e => {
            // 删除按钮使用事件委托
            const del = e.target.closest('.qq-del');
            if (del) {
              e.stopPropagation();
              const row = del.closest('.qq-session');
              const nameEl = row && row.querySelector('.name');
              const name = nameEl ? nameEl.childNodes[0].textContent.trim() : null;
              if (!name) return;
              const ok = await showConfirm('删除会话', `确认删除会话：${name} ?`);
              if (!ok) return;
              try {
                localStorage.removeItem('chat:' + name);
                // 同时移除该会话的 meta（头像/提示）
                try {
                  localStorage.removeItem('chatmeta:' + name);
                } catch (e) {}
                try {
                  console.log('[DELETE] removed chat and chatmeta for', name);
                } catch (e) {}
                // 如果被删除的会话正好是当前的全局默认 AI 名，则清除对应的全局默认设置
                try {
                  const def = localStorage.getItem('default-char-name') || '';
                  if (def && def === name) {
                    localStorage.removeItem('default-char-name');
                    localStorage.removeItem('default-char-avatar');
                    localStorage.removeItem('default-char-prompt');
                  }
                } catch (e) {}
                row.remove();
                const remaining = Array.from(qqList.querySelectorAll('.qq-session'))
                  .map(s => {
                    const n = s.querySelector('.name');
                    return n ? n.childNodes[0].textContent.trim() : null;
                  })
                  .filter(Boolean);
                localStorage.setItem('qq-sessions', JSON.stringify(remaining));
                if (activeChatName === name) {
                  messagesEl.innerHTML = '';
                  activeChatName = null;
                  currentMessages = [];
                }
                try {
                  renderUserDisplay();
                  refreshSessionListAvatars();
                  refreshMessageAvatars();
                } catch (e) {}
              } catch (err) {
                console.error('删除会话失败', err);
              }
              return;
            }
            const s = e.target.closest('.qq-session');
            if (!s) return;
            const nameEl = s.querySelector('.name');
            const name = nameEl ? nameEl.childNodes[0].textContent.trim() : '汉堡堡';
            openChat(name);
          });
          // 恢复已保存的会话
          try {
            const saved = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
            if (saved && saved.length) {
              qqList.innerHTML = '';
              saved.forEach(n => {
                const el = document.createElement('div');
                el.className = 'qq-session';
                // 尝试读取会话元数据（avatar/prompt）
                let avatar = null;
                try {
                  const meta = JSON.parse(localStorage.getItem('chatmeta:' + n) || '{}');
                  avatar = meta && meta.avatar;
                } catch (e) {}
                if (avatar) {
                  el.innerHTML = `<div class="qq-avatar"><img src="${avatar}" alt="avatar" style="width:100%;height:100%;border-radius:50%"/></div><div class="info"><div class="name">${n} <span class="meta">· 之前</span></div><div class="msg">与 ${n} 的对话</div></div><button class="qq-del">删除</button>`;
                } else {
                  el.innerHTML = `<div class="qq-avatar">${
                    n[0] || '我'
                  }</div><div class="info"><div class="name">${n} <span class="meta">· 之前</span></div><div class="msg">与 ${n} 的对话</div></div><button class="qq-del">删除</button>`;
                }
                qqList.appendChild(el);
              });
            }
            // roll 按钮逻辑：重新生成上一次 assistant 的回复（如果有）
            const rollFooter = document.getElementById('rollFooterBtn');
            if (rollFooter) {
              rollFooter.addEventListener('click', async () => {
                if (!activeChatName || !currentMessages.length) return;
                // 找到上一个用户消息
                let lastUser = null;
                for (let i = currentMessages.length - 1; i >= 0; i--) {
                  if (currentMessages[i].role === 'user') {
                    lastUser = currentMessages[i].content;
                    break;
                  }
                }
                if (!lastUser) return;
                // 删除最后一条 assistant 回复（如果存在）
                for (let i = currentMessages.length - 1; i >= 0; i--) {
                  if (currentMessages[i].role === 'assistant') {
                    currentMessages.splice(i, 1);
                    break;
                  }
                }
                // re-render messages
                messagesEl.innerHTML = '';
                currentMessages.forEach(m => renderMessage(m.content, m.role === 'user' ? 'me' : 'assistant'));
                messagesEl.scrollTop = messagesEl.scrollHeight;
                // 直接调用 requestReply，不重复添加用户消息
                await requestReply(lastUser, { appendUser: false });
              });
            }
          } catch (e) {
            console.error('恢复会话失败', e);
          }
        }

        // 壁纸功能
        function initWallpaperSettings() {
          const wallpaperType = document.getElementById('wallpaperType');
          const colorDiv = document.getElementById('colorWallpaper');
          const gradientDiv = document.getElementById('gradientWallpaper');
          const imageDiv = document.getElementById('imageWallpaper');
          const applyBtn = document.getElementById('applyWallpaper');
          const uploadBtn = document.getElementById('wallpaperUploadBtn');
          const fileInput = document.getElementById('wallpaperImageFile');

          // 切换壁纸类型
          wallpaperType.addEventListener('change', () => {
            const type = wallpaperType.value;
            colorDiv.style.display = type === 'color' ? 'block' : 'none';
            gradientDiv.style.display = type === 'gradient' ? 'block' : 'none';
            imageDiv.style.display = type === 'image' ? 'block' : 'none';
          });

          // 上传图片
          uploadBtn.addEventListener('click', () => fileInput.click());
          fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = e => {
                document.getElementById('wallpaperImageUrl').value = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          });

          // 应用壁纸
          applyBtn.addEventListener('click', () => {
            const type = wallpaperType.value;
            let backgroundStyle = '';

            if (type === 'color') {
              const color = document.getElementById('wallpaperColor').value;
              backgroundStyle = `background: ${color}`;
            } else if (type === 'gradient') {
              const color1 = document.getElementById('gradientColor1').value;
              const color2 = document.getElementById('gradientColor2').value;
              backgroundStyle = `background: linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
            } else if (type === 'image') {
              const imageUrl = document.getElementById('wallpaperImageUrl').value;
              if (imageUrl) {
                backgroundStyle = `background: url('${imageUrl}') center/cover no-repeat`;
              }
            }

            if (backgroundStyle) {
              document.body.style.cssText += '; ' + backgroundStyle;
              localStorage.setItem('wallpaper-style', backgroundStyle);
              localStorage.setItem('wallpaper-type', type);
              alert('壁纸已应用！');
            }
          });

          // 加载保存的壁纸
          const savedStyle = localStorage.getItem('wallpaper-style');
          const savedType = localStorage.getItem('wallpaper-type');
          if (savedStyle) {
            document.body.style.cssText += '; ' + savedStyle;
            if (savedType) wallpaperType.value = savedType;
          }
        }

        // 世界书功能
        function initWorldBook() {
          const openBtn = document.getElementById('openWorldBook');
          const addBtn = document.getElementById('addWorldBookEntry');
          const clearBtn = document.getElementById('clearWorldBook');
          const cancelBtn = document.getElementById('worldBookCancel');

          openBtn.addEventListener('click', showWorldBookModal);
          cancelBtn.addEventListener('click', closeWorldBookModal);

          addBtn.addEventListener('click', () => {
            const keyword = document.getElementById('worldBookKeyword').value.trim();
            const content = document.getElementById('worldBookContent').value.trim();

            if (!keyword || !content) {
              alert('请填写关键词和描述内容');
              return;
            }

            const worldBook = JSON.parse(localStorage.getItem('world-book') || '[]');
            const existingIndex = worldBook.findIndex(entry => entry.keyword === keyword);

            if (existingIndex >= 0) {
              worldBook[existingIndex].content = content;
            } else {
              worldBook.push({ keyword, content, id: Date.now() });
            }

            localStorage.setItem('world-book', JSON.stringify(worldBook));
            document.getElementById('worldBookKeyword').value = '';
            document.getElementById('worldBookContent').value = '';
            loadWorldBookEntries();
          });

          clearBtn.addEventListener('click', () => {
            if (confirm('确定要清空所有世界书条目吗？')) {
              localStorage.removeItem('world-book');
              loadWorldBookEntries();
            }
          });
        }

        function loadWorldBookEntries() {
          const listDiv = document.getElementById('worldBookList');
          const worldBook = JSON.parse(localStorage.getItem('world-book') || '[]');

          if (worldBook.length === 0) {
            listDiv.innerHTML = '<p style="color: #999; text-align: center; margin: 20px 0">暂无条目</p>';
            return;
          }

          listDiv.innerHTML = worldBook
            .map(
              entry => `
            <div style="border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; align-items: flex-start">
              <div style="flex: 1">
                <strong style="color: #667eea">${entry.keyword}</strong>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #666; white-space: pre-wrap">${entry.content}</p>
              </div>
              <button onclick="deleteWorldBookEntry(${entry.id})" 
                      style="background: #ff4757; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer">删除</button>
            </div>
          `,
            )
            .join('');
        }

        window.deleteWorldBookEntry = function (id) {
          const worldBook = JSON.parse(localStorage.getItem('world-book') || '[]');
          const filtered = worldBook.filter(entry => entry.id !== id);
          localStorage.setItem('world-book', JSON.stringify(filtered));
          loadWorldBookEntries();
        };

        // 在消息发送时应用世界书
        function applyWorldBook(messageContent) {
          const worldBook = JSON.parse(localStorage.getItem('world-book') || '[]');
          let contextAddition = '';

          worldBook.forEach(entry => {
            if (messageContent.toLowerCase().includes(entry.keyword.toLowerCase())) {
              contextAddition += `\n[世界书: ${entry.keyword}] ${entry.content}`;
            }
          });

          return contextAddition;
        }

        // 初始化新功能模态框
        function initNewModals() {
          // 拍照模态框
          const cameraCancel = document.getElementById('cameraCancel');
          const cameraConfirm = document.getElementById('cameraConfirm');
          cameraCancel.addEventListener('click', closeCameraModal);
          cameraConfirm.addEventListener('click', () => {
            const description = document.getElementById('cameraDescription').value.trim();
            if (description) {
              appendMessage(`[图片描述] ${description}`, 'me');
              closeCameraModal();
            }
          });

          // 相册模态框
          const albumCancel = document.getElementById('albumCancel');
          const albumConfirm = document.getElementById('albumConfirm');
          const selectImageBtn = document.getElementById('selectImageBtn');
          const albumFileInput = document.getElementById('albumFileInput');

          albumCancel.addEventListener('click', closeAlbumModal);
          selectImageBtn.addEventListener('click', () => albumFileInput.click());

          albumFileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = e => {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;" />`;
                document.getElementById('albumConfirm').style.display = 'block';
              };
              reader.readAsDataURL(file);
            }
          });

          albumConfirm.addEventListener('click', () => {
            const preview = document.getElementById('imagePreview');
            const img = preview.querySelector('img');
            if (img) {
              appendMessage(`[发送图片] <img src="${img.src}" style="max-width: 200px; border-radius: 8px;" />`, 'me');
              closeAlbumModal();
            }
          });

          // Roll选项模态框
          const waitReplyBtn = document.getElementById('waitReplyBtn');
          const rollBtn = document.getElementById('rollBtn');

          waitReplyBtn.addEventListener('click', () => {
            closeRollOptions();
            // 获取最后一条用户消息并请求AI回复
            const lastUserMsg = [...currentMessages].reverse().find(m => m.role === 'user');
            if (lastUserMsg) {
              requestReply(lastUserMsg.content, { appendUser: false });
            }
          });

          rollBtn.addEventListener('click', () => {
            closeRollOptions();
            // 删除最后一条AI回复并重新生成
            if (currentMessages.length > 0 && currentMessages[currentMessages.length - 1].role === 'assistant') {
              currentMessages.pop();
              const messagesEl = document.getElementById('messages');
              messagesEl.removeChild(messagesEl.lastChild);
              saveChat(activeChatName);
            }
            // 获取最后一条用户消息并重新请求
            const lastUserMsg = [...currentMessages].reverse().find(m => m.role === 'user');
            if (lastUserMsg) {
              requestReply(lastUserMsg.content, { appendUser: false });
            }
          });

          // 聊天设置模态框
          const chatSettingsCancel = document.getElementById('chatSettingsCancel');
          const chatSettingsSave = document.getElementById('chatSettingsSave');

          chatSettingsCancel.addEventListener('click', closeChatSettings);
          chatSettingsSave.addEventListener('click', saveChatSettings);

          // 模态框背景点击关闭
          document.addEventListener('click', e => {
            if (e.target.classList.contains('modal-backdrop')) {
              e.target.classList.remove('active');
            }
          });
        }

        // 聊天设置相关函数
        function loadChatSettings() {
          if (activeChatName) {
            const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
            document.getElementById('chatCharName').value = activeChatName || '';
            document.getElementById('chatCharAvatar').value = meta.avatar || '';
            document.getElementById('chatCharPrompt').value = meta.prompt || '';
          }
          document.getElementById('chatUserName').value = localStorage.getItem('user-name') || '';
          document.getElementById('chatUserAvatar').value = localStorage.getItem('user-avatar') || '';
        }

        function saveChatSettings() {
          const charName = document.getElementById('chatCharName').value.trim();
          const charAvatar = document.getElementById('chatCharAvatar').value.trim();
          const charPrompt = document.getElementById('chatCharPrompt').value.trim();
          const userName = document.getElementById('chatUserName').value.trim();
          const userAvatar = document.getElementById('chatUserAvatar').value.trim();

          // 保存用户信息
          if (userName) localStorage.setItem('user-name', userName);
          if (userAvatar) localStorage.setItem('user-avatar', userAvatar);

          // 保存AI信息
          if (activeChatName && charName) {
            // 如果改了名字，需要迁移数据
            if (charName !== activeChatName) {
              const chatData = localStorage.getItem('chat:' + activeChatName);
              const metaData = localStorage.getItem('chatmeta:' + activeChatName);
              if (chatData) localStorage.setItem('chat:' + charName, chatData);

              const meta = JSON.parse(metaData || '{}');
              meta.avatar = charAvatar;
              meta.prompt = charPrompt;
              localStorage.setItem('chatmeta:' + charName, JSON.stringify(meta));

              // 更新会话列表
              const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
              const index = sessions.indexOf(activeChatName);
              if (index >= 0) {
                sessions[index] = charName;
                localStorage.setItem('qq-sessions', JSON.stringify(sessions));
              }

              // 清理旧数据
              localStorage.removeItem('chat:' + activeChatName);
              localStorage.removeItem('chatmeta:' + activeChatName);

              activeChatName = charName;
            } else {
              const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
              meta.avatar = charAvatar;
              meta.prompt = charPrompt;
              localStorage.setItem('chatmeta:' + activeChatName, JSON.stringify(meta));
            }

            // 更新界面
            document.getElementById('chatTitle').textContent = charName;
            if (charAvatar) {
              document.getElementById(
                'contactAvatar',
              ).innerHTML = `<img src="${charAvatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />`;
            }
          }

          closeChatSettings();
          renderUserDisplay();
          refreshSessionListAvatars();
          refreshMessageAvatars();
        }

        // 初始化新功能
        initWallpaperSettings();
        initWorldBook();
        initNewModals();

        // 修复聊天页面导航栏
        function fixChatNavigation() {
          const rightSection = document.querySelector('#chat-screen .nav .right-section');
          if (rightSection) {
            rightSection.innerHTML = `
              <button class="action-btn" title="删除消息" onclick="toggleDeleteMode()" id="deleteBtn">
                <img src="https://i.111666.best/image/8B6YbkOChM9r1Qh7j66M3O.png" alt="删除" style="width: 18px; height: 18px;" />
              </button>
              <button class="action-btn" title="聊天设置" onclick="openChatSettings()">⚙️</button>
              <button class="action-btn" title="更多" onclick="showMoreOptions()">⋯</button>
            `;
          }
        }

        // 在DOM加载完成后执行修复
        setTimeout(fixChatNavigation, 100);
      })();
    </script>
  </body>
</html>
