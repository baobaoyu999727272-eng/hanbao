<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HANBAO â€” QQ é£æ ¼ æ¼”ç¤º (ä¿®å¤ç‰ˆ)</title>
    <style>
      :root {
        --qq-blue: #1a8aff;
        --nav-height: 56px;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: PingFang SC, Segoe UI, Roboto, 'Microsoft Yahei', sans-serif;
        background: #1b4574;
      }
      .notch {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 18px;
        width: 120px; /* å¾®è°ƒæ›´çŸ­ */
        height: 28px;
        background: #000;
        border-radius: 14px;
      }
      .phone {
        width: 360px; /* è¿›ä¸€æ­¥æ”¶çª„å¤–å£³ï¼Œæ›´è´´åˆæˆªå›¾ */
        height: 800px;
        margin: 46px auto;
        border-radius: 36px;
        box-shadow: 0 18px 56px rgba(2, 40, 80, 0.45), inset 0 2px 0 rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
        border: 3px solid rgba(255, 255, 255, 0.18); /* æ›´æµ…æ›´è‡ªç„¶çš„è¾¹æ¡† */
        background: linear-gradient(180deg, #ddf0ff, #eef7ff);
      }
      .wallpaper {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, #cfe8ff, #eaf6ff);
      }
      .screen-content {
        position: relative;
        height: 100%;
        padding-top: 84px;
        box-sizing: border-box;
      }
      .watermark {
        position: absolute;
        right: 12px;
        bottom: 18px;
        color: rgba(0, 0, 0, 0.06);
        font-weight: 700;
        font-size: 22px;
      }
      .home-panel {
        position: absolute;
        left: 14px;
        right: 14px;
        top: 120px; /* ä¸æˆªå›¾ä¿æŒä¸€å®šä¸‹ç§»ï¼Œç•™å‡º notch ç©ºç™½ */
        bottom: 20px;
        background: transparent; /* é€æ˜ï¼Œå›åˆ°å£çº¸ä¸Š */
        border-radius: 0; /* æ— åœ†è§’å¡ç‰‡ */
        box-shadow: none; /* å»æ‰ç™½å¡é˜´å½± */
        padding: 20px 18px 34px 18px; /* ä¿ç•™å†…è¾¹è·ä»¥ç»´æŒå›¾æ ‡ä½ç½® */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }
      .app-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 42px 34px; /* æ›´æ¥è¿‘æˆªå›¾çš„è¾ƒå¤§å‚ç›´é—´è· */
        justify-items: center;
        align-items: center;
        margin: 0;
        width: 260px; /* ä½¿å›¾æ ‡è¡Œåœ¨å¡ç‰‡ä¸­æ›´å±…ä¸­ */
        margin-top: 6px;
      }
      .app {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: inherit;
      }
      .icon {
        width: 96px; /* ç•¥å¤§ä¸€äº›ï¼Œè®©å›¾æ ‡æ›´æ˜¾çœ¼ */
        height: 96px;
        border-radius: 20px;
        background: radial-gradient(
            circle at 30% 20%,
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.6) 30%,
            rgba(230, 245, 255, 0.6) 60%
          ),
          linear-gradient(180deg, #ffffff, #f0f8ff);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 14px 30px rgba(6, 36, 60, 0.12), inset 0 6px 14px rgba(255, 255, 255, 0.6);
        padding: 12px;
        border: 1px solid rgba(11, 58, 69, 0.06);
        transition: transform 160ms cubic-bezier(0.2, 0.9, 0.2, 1), box-shadow 160ms ease;
      }
      .icon img {
        width: 56px; /* å›¾æ ‡å°ºå¯¸ */
        height: 56px;
        object-fit: contain;
        border-radius: 12px;
        transition: transform 180ms ease, filter 160ms ease;
      }
      .icon:hover {
        transform: translateY(-6px) scale(1.06);
        box-shadow: 0 28px 48px rgba(6, 36, 60, 0.16), inset 0 6px 14px rgba(255, 255, 255, 0.6);
        filter: drop-shadow(0 6px 18px rgba(10, 40, 80, 0.08));
      }
      /* typing æŒ‡ç¤ºå™¨ */
      .typing-dots {
        display: inline-flex;
        gap: 6px;
        align-items: center;
      }
      .typing-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #cfe8ff;
        opacity: 0.9;
        transform: translateY(0);
        animation: typing 1s infinite;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: 0.12s;
      }
      .typing-dots span:nth-child(3) {
        animation-delay: 0.24s;
      }
      @keyframes typing {
        0% {
          transform: translateY(0);
          opacity: 0.6;
        }
        50% {
          transform: translateY(-6px);
          opacity: 1;
        }
        100% {
          transform: translateY(0);
          opacity: 0.6;
        }
      }
      .label {
        margin-top: 10px;
        font-weight: 600;
        font-size: 13px;
        color: #08313a;
        text-align: center;
      }
      /* API / QQ é¡µé¢ç¾åŒ– */
      #api-screen .page-content,
      #qq-screen .page-content {
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        box-shadow: 0 8px 18px rgba(12, 40, 80, 0.04);
        padding: 16px;
      }
      #api-screen .actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .btn {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 13px;
      }
      .btn.primary {
        background: var(--qq-blue);
        color: #fff;
      }
      .btn.ghost {
        background: linear-gradient(180deg, #f7fbff, #eef7ff);
        border: 1px solid #d6ecff;
        color: #0b3a45;
      }
      .btn.ghost:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(12, 40, 80, 0.04);
      }
      .btn[disabled] {
        opacity: 0.6;
        cursor: default;
      }
      /* roll icon å¾®è°ƒ */
      #rollFooterBtn img {
        filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.06));
      }
      input[type='text'],
      input[type='password'],
      input:not([type]),
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #e8f0fb;
        background: linear-gradient(180deg, #ffffff, #fbfeff);
        box-sizing: border-box;
        font-size: 13px;
        transition: box-shadow 160ms ease, transform 120ms ease;
      }
      input[type='text']::placeholder,
      textarea::placeholder {
        color: #94aab5;
      }
      select {
        height: 38px;
      }
      select {
        appearance: none;
        -webkit-appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, #888 50%),
          linear-gradient(135deg, #888 50%, transparent 50%);
        background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px);
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        box-shadow: 0 6px 18px rgba(26, 138, 255, 0.08);
        border-color: #9fd0ff;
      }
      /* apiResponse æ ·å¼å·²ç§»é™¤ï¼ˆå“åº”é¢æ¿ä¸å†å­˜åœ¨ï¼‰ */
      .placeholder-qq {
        text-align: center;
        color: #6b8796;
        padding: 28px 12px;
      }
      /* QQ åˆ—è¡¨ç¾åŒ– */
      #qq-session-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 4px;
      }
      .qq-session {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px;
        border-radius: 12px;
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        box-shadow: 0 6px 18px rgba(12, 40, 80, 0.04);
        border: 1px solid rgba(6, 36, 60, 0.03);
        cursor: pointer;
        position: relative;
      }
      .qq-session .qq-del {
        position: absolute;
        right: 8px;
        top: 8px;
        background: transparent;
        border: none;
        color: #ff6b6b;
        font-weight: 700;
        cursor: pointer;
        padding: 4px 6px;
        border-radius: 6px;
      }
      .qq-avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: linear-gradient(180deg, #eaf6ff, #d6edff);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #0b3a45;
        flex-shrink: 0;
      }
      .qq-session .info {
        flex: 1;
        overflow: hidden;
      }
      .qq-session .name {
        font-weight: 700;
        color: #08313a;
        font-size: 14px;
      }
      .qq-session .msg {
        color: #6b8796;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .qq-session .meta {
        font-size: 12px;
        color: #94aab5;
      }
      .qq-badge {
        background: #ff4d6d;
        color: #fff;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      .add-btn {
        padding: 6px 10px;
        border-radius: 10px;
        border: none;
        background: var(--qq-blue);
        color: #fff;
        box-shadow: 0 6px 14px rgba(26, 138, 255, 0.12);
      }
      .add-btn:hover {
        transform: translateY(-2px);
      }
      .hidden {
        display: none !important;
      }
      .screen {
        position: absolute;
        inset: 0;
        padding-top: var(--nav-height);
        display: none;
        flex-direction: column;
      }
      .screen.active {
        display: flex;
      }
      .nav {
        height: var(--nav-height);
        display: flex;
        align-items: center;
        padding: 8px 12px;
      }
      .nav strong {
        flex: 1;
        text-align: center;
      }
      .back-btn {
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid rgba(11, 58, 69, 0.08);
        background: linear-gradient(180deg, #ffffff, #fbfeff);
        box-shadow: 0 4px 10px rgba(12, 40, 80, 0.06);
        cursor: pointer;
      }
      .back-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(12, 40, 80, 0.09);
      }
      .page-content {
        flex: 1;
        overflow: auto;
        padding: 18px;
        background: #fff;
        border-radius: 18px 18px 0 0;
        margin: 0 12px 12px 12px;
      }
      /* ç»™èŠå¤©é¡µé¢åº•éƒ¨ç•™å‡ºè¶³å¤Ÿç©ºé—´ï¼Œé¿å…æœ€åä¸€æ¡æ¶ˆæ¯è¢«åº•éƒ¨è¾“å…¥æ é®æŒ¡ */
      .page-content.chat {
        padding-bottom: 140px;
      }
      .bubble {
        padding: 10px 14px;
        border-radius: 14px;
        background: #f1f8ff;
        max-width: 78%;
        margin: 6px 0;
      }
      .bubble.me {
        background: var(--qq-blue);
        color: #fff;
      }
      /* æ–°å¢ï¼šæ¶ˆæ¯è¡Œä¸å¤´åƒ */
      .message-row {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        margin: 6px 0;
      }
      .message-row.me {
        justify-content: flex-end;
      }
      .message-row .avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: linear-gradient(180deg, #fff, #eef7ff);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #08313a;
        flex-shrink: 0;
        overflow: hidden;
      }
      .message-row .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .input-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .chat-action-btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid #e6eefb;
        background: #fff;
        cursor: pointer;
      }
      /* èŠå¤©ç•Œé¢æ ·å¼ */
      .chat-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: linear-gradient(180deg, #ffffff, #f8fbff);
        border-bottom: 1px solid #e8f0fb;
        box-shadow: 0 2px 8px rgba(12, 40, 80, 0.05);
      }
      .chat-top .left-section {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .chat-top .center-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .chat-top .right-section {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .chat-top .contact-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #1a8aff, #0066cc);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        overflow: hidden;
      }
      .chat-top .contact-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .chat-top .contact-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .chat-top .contact-name {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }
      .chat-top .contact-status {
        font-size: 12px;
        color: #7f8c8d;
        margin: 0;
        margin-top: -2px;
      }
      .chat-top .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: rgba(26, 138, 255, 0.1);
        color: #1a8aff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .chat-top .action-btn:hover {
        background: rgba(26, 138, 255, 0.2);
        transform: scale(1.1);
      }
      #chatTitle {
        font-size: 16px;
        font-weight: 700;
      }
      .chat-footer {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 10px 12px;
        background: linear-gradient(180deg, #fff, #f9fbff);
        box-shadow: 0 -6px 18px rgba(12, 40, 80, 0.04);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .attachment-icons {
        display: flex;
        gap: 8px;
      }
      .chat-input-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .chat-input {
        flex: 1;
        padding: 10px 14px;
        border-radius: 24px;
        border: 1px solid #eef3fb;
        background: #fff;
      }
      .send-btn {
        width: 64px;
        height: 40px;
        border-radius: 20px;
      }
      #messages {
        padding: 12px;
        min-height: 420px;
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-backdrop.active {
        display: flex;
      }
      .modal {
        width: 92%;
        max-width: 520px;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
      }
      textarea {
        font-family: inherit;
      }
      @media (max-width: 480px) {
        .phone {
          width: 360px;
          height: 780px;
        }
      }

      /* æ”¹è¿›çš„å“åº”å¼å’ŒUIæ ·å¼ */
      .phone {
        transition: all 0.3s ease;
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12);
      }

      .modal {
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .btn {
        transition: all 0.2s ease;
        user-select: none;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      /* ä¼˜åŒ–è¾“å…¥æ¡†æ ·å¼ */
      input,
      textarea,
      select {
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #1a8aff;
        box-shadow: 0 0 0 3px rgba(26, 138, 255, 0.1);
      }

      /* QQç•Œé¢ä¼˜åŒ– */
      .qq-session {
        transition: background-color 0.2s ease;
      }

      .qq-session:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }

      /* æ¶ˆæ¯æ°”æ³¡åŠ¨ç”» */
      .bubble {
        animation: bubbleSlideIn 0.3s ease-out;
      }

      @keyframes bubbleSlideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ä¸–ç•Œä¹¦æ¡ç›®æ ·å¼ä¼˜åŒ– */
      #worldBookList {
        scrollbar-width: thin;
        scrollbar-color: #ddd transparent;
      }

      #worldBookList::-webkit-scrollbar {
        width: 6px;
      }

      #worldBookList::-webkit-scrollbar-track {
        background: transparent;
      }

      #worldBookList::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 3px;
      }

      /* æ”¹è¿›loadingåŠ¨ç”» */
      .typing-dots span {
        animation: typing 1.4s infinite;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        30% {
          transform: translateY(-10px);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="phone" role="application" aria-label="HANBAO Demo Phone">
      <div class="wallpaper"></div>
      <div class="notch" aria-hidden></div>
      <div class="screen-content">
        <div class="watermark">HANBAO</div>
        <div class="home-panel">
          <div class="app-row" id="app-row">
            <a class="app" href="#" onclick="showWorldBookModal(); return false;"
              ><div class="icon"><img src="https://img.cdn1.vip/i/68b4d6a78c089_1756681895.webp" alt="ä¸–ç•Œä¹¦" /></div>
              <div class="label">ä¸–ç•Œä¹¦</div></a
            >
            <a class="app" href="#" data-screen="qq-screen"
              ><div class="icon"><img src="https://img.cdn1.vip/i/68b4d5cee23f7_1756681678.webp" alt="QQ" /></div>
              <div class="label">QQ</div></a
            >
            <a class="app" href="#" data-screen="api-screen"
              ><div class="icon"><img src="https://img.cdn1.vip/i/68b4d6a787f9c_1756681895.webp" alt="API" /></div>
              <div class="label">API</div></a
            >
            <a class="app" href="#" data-screen="settings-screen"
              ><div class="icon"><img src="https://i.111666.best/image/KrGLd0mjGkHswb9ieAE9CG.png" alt="è®¾ç½®" /></div>
              <div class="label">è®¾ç½®</div></a
            >
          </div>
        </div>

        <div id="chat-screen" class="screen" aria-hidden>
          <div class="nav chat-top">
            <div class="left-section">
              <button class="back-btn">â—€</button>
              <div class="contact-avatar" id="contactAvatar">AI</div>
              <div class="contact-info">
                <div class="contact-name" id="chatTitle">èŠå¤©</div>
                <div class="contact-status" id="contactStatus">åœ¨çº¿</div>
              </div>
            </div>
            <div class="right-section">
              <button class="action-btn" title="è¯­éŸ³é€šè¯" onclick="showTransferModal()">ï¿½</button>
              <button class="action-btn" title="è§†é¢‘é€šè¯" onclick="showRedPacketModal()">ğŸ“¹</button>
              <button class="action-btn" title="æ›´å¤š" onclick="showGroupChatModal()">â‹¯</button>
            </div>
          </div>
          <div class="page-content chat" id="chatPage">
            <div id="messages"></div>
          </div>
          <div class="chat-footer">
            <div class="attachment-icons">
              <button class="btn ghost" onclick="showGroupChatModal()" title="åˆ›å»ºç¾¤èŠ">
                <img
                  src="https://i.111666.best/image/9kHFDz5Nadhj7g2vwOyk9G.png"
                  alt="ç¾¤èŠ"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" onclick="showCameraModal()" title="æ‹ç…§">
                <img
                  src="https://i.111666.best/image/3QPuXFeAydF7NrY5IDMxYu.png"
                  alt="æ‹ç…§"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" onclick="showAlbumModal()" title="ç›¸å†Œ">
                <img
                  src="https://i.111666.best/image/GF2ZspS1bnNGxsoto5GhIc.png"
                  alt="ç›¸å†Œ"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" onclick="showTransferModal()" title="è½¬è´¦">
                <img
                  src="https://i.111666.best/image/gb4daNz41OHTOBfoHnvBqv.png"
                  alt="è½¬è´¦"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" onclick="showRedPacketModal()" title="çº¢åŒ…">
                <img
                  src="https://i.111666.best/image/K2nroRSSGapSjiL7yU70qc.png"
                  alt="çº¢åŒ…"
                  style="width: 20px; height: 20px"
                />
              </button>
              <button class="btn ghost" title="è¡¨æƒ…åŒ…">
                <img
                  src="https://i.111666.best/image/CNvFPp13Aiqt9ILZznqqha.png"
                  alt="è¡¨æƒ…åŒ…"
                  style="width: 20px; height: 20px"
                />
              </button>
            </div>
            <div class="chat-input-row">
              <input id="inputBox" placeholder="è¾“å…¥æ¶ˆæ¯..." class="chat-input" />
              <button
                id="rollFooterBtn"
                class="btn ghost"
                style="margin-left: 8px; padding: 6px 8px; border-radius: 14px"
                onclick="showRollOptions()"
              >
                <img
                  src="https://img.cdn1.vip/i/68b52535066a9_1756702005.webp"
                  alt="é‡ç”Ÿ"
                  style="width: 20px; height: 20px; display: block"
                />
              </button>
              <button id="sendBtn" class="btn primary send-btn">å‘é€</button>
            </div>
          </div>
        </div>

        <div id="qq-screen" class="screen" aria-hidden>
          <div class="nav"><button class="back-btn">è¿”å›</button><strong>QQ</strong></div>
          <div class="page-content">
            <div style="margin-bottom: 12px; display: flex; gap: 8px">
              <input
                id="qq-search"
                style="
                  flex: 1;
                  padding: 8px;
                  border-radius: 10px;
                  border: 1px solid #e6f1fb;
                  background: linear-gradient(180deg, #fff, #f7fbff);
                "
                placeholder="ğŸ” æœç´¢è”ç³»äºº"
              /><button id="addPersonaBtn" class="add-btn">+ æ·»åŠ </button>
            </div>
            <div id="qq-session-list"></div>
          </div>
        </div>

        <div id="api-screen" class="screen" aria-hidden>
          <div class="nav"><button class="back-btn">è¿”å›</button><strong>API é…ç½®</strong></div>
          <div class="page-content">
            <div style="display: flex; gap: 12px">
              <div style="flex: 1; min-width: 180px">
                <form id="apiForm">
                  <div style="display: flex; gap: 8px; align-items: center">
                    <label style="min-width: 56px">æ¥æº</label>
                    <select id="apiSource">
                      <option value="openai">OpenAI å…¼å®¹</option>
                      <option value="gemini">Gemini</option>
                    </select>
                  </div>
                  <div style="margin-top: 8px">
                    <label>ç«¯ç‚¹</label>
                    <input id="apiUrl" placeholder="https://api.openai.com/v1" style="width: 100%" />
                  </div>
                  <div style="margin-top: 8px">
                    <label id="apiKeyLabel">API Key</label>
                    <input id="apiKey" placeholder="sk-..." style="width: 100%" />
                  </div>
                  <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center">
                    <label style="min-width: 56px">æ¨¡å‹</label>
                    <select id="modelSelect" style="flex: 1; display: none"></select>
                    <button type="submit" class="btn primary">è¿æ¥</button>
                    <button id="saveBtn" type="button" class="btn ghost hidden">ä¿å­˜</button>
                  </div>
                  <div id="status" class="status" style="margin-top: 6px; color: #0b3a45; font-size: 13px"></div>
                </form>

                <!-- è‡ªå®šä¹‰è¯·æ±‚ä½“å·²ç§»é™¤ï¼Œå‘é€ä½¿ç”¨é¢„è®¾è¯·æ±‚ -->
                <div style="margin-top: 12px">
                  <div style="color: #6b8796; font-size: 13px">
                    å‘é€å°†ä½¿ç”¨é¢„è®¾ Chat Completions è¯·æ±‚ï¼Œé€‰æ‹©æ¨¡å‹åç‚¹å‡»å‘é€ã€‚
                  </div>
                </div>
                <!-- å‘é€æ§ä»¶å·²ç§»é™¤ -->
              </div>
              <!-- å“åº”é¢æ¿å·²ç§»é™¤ä»¥ä¿æŒç•Œé¢ç®€æ´ -->
            </div>
          </div>
        </div>

        <div id="settings-screen" class="screen" aria-hidden>
          <div class="nav"><button class="back-btn">è¿”å›</button><strong>è®¾ç½®</strong></div>
          <div class="page-content">
            <label><input id="enableNotchPreview" type="checkbox" /> å¯ç”¨çµåŠ¨å²›é¢„è§ˆ</label>

            <!-- å£çº¸è®¾ç½® -->
            <div style="margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 12px">
              <h4 style="margin: 0 0 12px 0; color: #333">ğŸ¨ å£çº¸è®¾ç½®</h4>
              <div style="margin-bottom: 12px">
                <label style="font-size: 13px; display: block; margin-bottom: 4px">å£çº¸ç±»å‹</label>
                <select
                  id="wallpaperType"
                  style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd"
                >
                  <option value="color">çº¯è‰²èƒŒæ™¯</option>
                  <option value="gradient">æ¸å˜èƒŒæ™¯</option>
                  <option value="image">å›¾ç‰‡èƒŒæ™¯</option>
                </select>
              </div>

              <div id="colorWallpaper" style="margin-bottom: 12px">
                <label style="font-size: 13px; display: block; margin-bottom: 4px">èƒŒæ™¯é¢œè‰²</label>
                <input
                  type="color"
                  id="wallpaperColor"
                  value="#f0f2f5"
                  style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer"
                />
              </div>

              <div id="gradientWallpaper" style="margin-bottom: 12px; display: none">
                <label style="font-size: 13px; display: block; margin-bottom: 4px">æ¸å˜è‰²å½©</label>
                <div style="display: flex; gap: 8px; align-items: center">
                  <input
                    type="color"
                    id="gradientColor1"
                    value="#667eea"
                    style="width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer"
                  />
                  <span>â†’</span>
                  <input
                    type="color"
                    id="gradientColor2"
                    value="#764ba2"
                    style="width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer"
                  />
                </div>
              </div>

              <div id="imageWallpaper" style="margin-bottom: 12px; display: none">
                <label style="font-size: 13px; display: block; margin-bottom: 4px">èƒŒæ™¯å›¾ç‰‡</label>
                <div style="display: flex; gap: 8px; align-items: center">
                  <input
                    id="wallpaperImageUrl"
                    placeholder="å›¾ç‰‡URLæˆ–ç‚¹å‡»ä¸Šä¼ "
                    style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd"
                  />
                  <button id="wallpaperUploadBtn" class="btn ghost" style="padding: 6px 8px">ä¸Šä¼ </button>
                </div>
                <input id="wallpaperImageFile" type="file" accept="image/*" style="display: none" />
              </div>

              <button id="applyWallpaper" class="btn primary" style="width: 100%; margin-top: 8px">åº”ç”¨å£çº¸</button>
            </div>

            <!-- ä¸–ç•Œä¹¦è®¾ç½® -->
            <div style="margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 12px">
              <h4 style="margin: 0 0 12px 0; color: #333">ğŸ“– ä¸–ç•Œä¹¦</h4>
              <p style="margin: 0 0 12px 0; font-size: 12px; color: #666">
                æ·»åŠ ä¸–ç•Œè§‚è®¾å®šã€è§’è‰²èƒŒæ™¯ç­‰é¢å¤–ä¿¡æ¯ï¼Œå¸®åŠ©AIæ›´å¥½åœ°ç†è§£å¯¹è¯åœºæ™¯
              </p>
              <button id="openWorldBook" class="btn primary" style="width: 100%">ç®¡ç†ä¸–ç•Œä¹¦</button>
            </div>

            <!-- ä½œè€…ä¿¡æ¯ -->
            <div
              style="
                margin: 20px 0;
                padding: 16px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px;
                color: white;
                text-align: center;
              "
            >
              <h4 style="margin: 0 0 8px 0">ğŸ‘¨â€ğŸ’» ä½œè€…ä¿¡æ¯</h4>
              <p style="margin: 0; font-size: 14px; opacity: 0.9">ä½œè€…ï¼šbaobaoyu</p>
              <div style="margin: 12px 0; font-size: 12px; opacity: 0.8; line-height: 1.4">
                <p style="margin: 0">âš ï¸ ç¦æ­¢äºŒä¼ ï¼Œç¦æ­¢å•†ä¸šåŒ–</p>
                <p style="margin: 4px 0 0 0">ğŸ“ ä»…åœ¨ç±»è„‘oræ—…ç¨‹å‘å¸ƒ</p>
                <p style="margin: 4px 0 0 0">ğŸ› æœ‰bugè¯·åœ¨æ—…ç¨‹orç±»è„‘æ‰¾æˆ‘å“¦</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- æ·»åŠ ä¼šè¯æ¨¡æ€ -->
    <div id="addModal" class="modal-backdrop">
      <div class="modal" style="padding: 16px">
        <div style="padding: 8px 0 12px"><strong>æ–°å»ºä¼šè¯</strong></div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">AI åç§°ï¼ˆcharï¼‰</label>
          <input
            id="charNameInput"
            placeholder="ä¾‹å¦‚ï¼šæ±‰å ¡å ¡"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 8px">
          <button id="cancelAddBtn" class="btn ghost">å–æ¶ˆ</button>
          <button id="confirmAddBtn" class="btn primary">åˆ›å»º</button>
        </div>
      </div>
    </div>
    <!-- ç¡®è®¤æ¨¡æ€ï¼ˆä¸ addModal é£æ ¼ä¸€è‡´ï¼‰ -->
    <div id="confirmModal" class="modal-backdrop">
      <div class="modal" style="padding: 16px">
        <div style="padding: 8px 0 12px"><strong id="confirmTitle">ç¡®è®¤</strong></div>
        <div id="confirmBody" style="margin-bottom: 12px; color: #444">ç¡®è®¤æ“ä½œå—ï¼Ÿ</div>
        <div style="display: flex; justify-content: flex-end; gap: 8px">
          <button id="confirmCancel" class="btn ghost">å–æ¶ˆ</button>
          <button id="confirmOk" class="btn primary">ç¡®è®¤</button>
        </div>
      </div>
    </div>

    <!-- è§’è‰²ä¸ç”¨æˆ·è®¾ç½®æ¨¡æ€ -->
    <div id="settingsModal" class="modal-backdrop">
      <div class="modal" style="padding: 16px">
        <div style="padding: 8px 0 12px"><strong>ä¼šè¯ä¸ç”¨æˆ·è®¾ç½®</strong></div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">AI åç§°ï¼ˆcharï¼‰</label>
          <input
            id="settingsCharName"
            placeholder="AI åç§°"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">AI å¤´åƒ URLï¼ˆå¯é€‰ï¼‰</label>
          <div style="display: flex; gap: 8px; align-items: center">
            <input
              id="settingsCharAvatar"
              placeholder="https://...png æˆ– æœ¬åœ°ä¸Šä¼ "
              style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
            />
            <button id="settingsCharUploadBtn" class="btn ghost" type="button" style="padding: 6px 8px">ä¸Šä¼ </button>
          </div>
          <input id="settingsCharAvatarFile" type="file" accept="image/*" style="display: none" />
          <div id="settingsCharAvatarPreview" style="margin-top: 6px"></div>
        </div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">AI è®¾å®šï¼ˆsystem promptï¼Œå¯é€‰ï¼‰</label>
          <textarea
            id="settingsCharPrompt"
            rows="3"
            placeholder="AI çš„è¡Œä¸ºè®¾å®š..."
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          ></textarea>
        </div>
        <hr />
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">ç”¨æˆ·åç§°</label>
          <input
            id="settingsUserName"
            placeholder="ä½ çš„åå­—"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 8px">
          <label style="font-size: 13px">ç”¨æˆ·å¤´åƒ URLï¼ˆå¯é€‰ï¼‰</label>
          <div style="display: flex; gap: 8px; align-items: center">
            <input
              id="settingsUserAvatar"
              placeholder="https://...png æˆ– æœ¬åœ°ä¸Šä¼ "
              style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
            />
            <button id="settingsUserUploadBtn" class="btn ghost" type="button" style="padding: 6px 8px">ä¸Šä¼ </button>
          </div>
          <input id="settingsUserAvatarFile" type="file" accept="image/*" style="display: none" />
          <div id="settingsUserAvatarPreview" style="margin-top: 6px"></div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 8px">
          <button id="settingsCancel" class="btn ghost">å–æ¶ˆ</button>
          <button id="settingsSave" class="btn primary">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- è½¬è´¦æ¨¡æ€æ¡† -->
    <div id="transferModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 300px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">ğŸ’° è½¬è´¦</h3>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">æ”¶æ¬¾äºº</label>
          <input
            id="transferReceiver"
            placeholder="è¾“å…¥æ”¶æ¬¾äººæ˜µç§°"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">è½¬è´¦é‡‘é¢</label>
          <input
            id="transferAmount"
            type="number"
            placeholder="0.00"
            style="
              width: 100%;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              margin-top: 4px;
              font-size: 18px;
              text-align: center;
            "
          />
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; color: #666">è½¬è´¦è¯´æ˜</label>
          <input
            id="transferNote"
            placeholder="æ·»åŠ è½¬è´¦è¯´æ˜ï¼ˆå¯é€‰ï¼‰"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="display: flex; gap: 8px">
          <button id="transferCancel" class="btn ghost" style="flex: 1">å–æ¶ˆ</button>
          <button id="transferConfirm" class="btn primary" style="flex: 1">ç¡®è®¤è½¬è´¦</button>
        </div>
      </div>
    </div>

    <!-- çº¢åŒ…æ¨¡æ€æ¡† -->
    <div id="redPacketModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 300px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #ff4757">ğŸ§§ å‘çº¢åŒ…</h3>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">çº¢åŒ…ç±»å‹</label>
          <select
            id="redPacketType"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          >
            <option value="normal">æ™®é€šçº¢åŒ…</option>
            <option value="lucky">æ‹¼æ‰‹æ°”çº¢åŒ…</option>
          </select>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">çº¢åŒ…é‡‘é¢</label>
          <input
            id="redPacketAmount"
            type="number"
            placeholder="0.00"
            style="
              width: 100%;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              margin-top: 4px;
              font-size: 18px;
              text-align: center;
            "
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">çº¢åŒ…ä¸ªæ•°</label>
          <input
            id="redPacketCount"
            type="number"
            value="1"
            min="1"
            max="100"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; color: #666">çº¢åŒ…ç¥ç¦</label>
          <input
            id="redPacketMessage"
            placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="display: flex; gap: 8px">
          <button id="redPacketCancel" class="btn ghost" style="flex: 1">å–æ¶ˆ</button>
          <button id="redPacketConfirm" class="btn primary" style="flex: 1">å‘çº¢åŒ…</button>
        </div>
      </div>
    </div>

    <!-- ç¾¤èŠæ¨¡æ€æ¡† -->
    <div id="groupChatModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 320px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">ğŸ‘¥ åˆ›å»ºç¾¤èŠ</h3>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">ç¾¤èŠåç§°</label>
          <input
            id="groupName"
            placeholder="è¾“å…¥ç¾¤èŠåç§°"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; color: #666">ç¾¤èŠå¤´åƒ URLï¼ˆå¯é€‰ï¼‰</label>
          <input
            id="groupAvatar"
            placeholder="https://... æˆ–ç•™ç©ºä½¿ç”¨é»˜è®¤"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #eef3fb; margin-top: 4px"
          />
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; color: #666">ç¾¤èŠä»‹ç»</label>
          <textarea
            id="groupDescription"
            placeholder="ç¾¤èŠä»‹ç»ï¼ˆå¯é€‰ï¼‰"
            style="
              width: 100%;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              margin-top: 4px;
              min-height: 60px;
              resize: vertical;
            "
          ></textarea>
        </div>
        <div style="display: flex; gap: 8px">
          <button id="groupCancel" class="btn ghost" style="flex: 1">å–æ¶ˆ</button>
          <button id="groupConfirm" class="btn primary" style="flex: 1">åˆ›å»ºç¾¤èŠ</button>
        </div>
      </div>
    </div>

    <!-- ä¸–ç•Œä¹¦æ¨¡æ€æ¡† -->
    <div id="worldBookModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 500px; max-height: 80vh; overflow-y: auto">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #667eea">ğŸ“– ä¸–ç•Œä¹¦ç®¡ç†</h3>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #666">
            æ·»åŠ å…³é”®è¯å’Œå¯¹åº”æè¿°ï¼Œå½“å¯¹è¯ä¸­å‡ºç°å…³é”®è¯æ—¶è‡ªåŠ¨æ³¨å…¥ç›¸å…³ä¿¡æ¯
          </p>
        </div>

        <div style="margin-bottom: 16px">
          <div style="display: flex; gap: 8px; margin-bottom: 12px">
            <input
              id="worldBookKeyword"
              placeholder="å…³é”®è¯ï¼ˆå¦‚ï¼šè§’è‰²åã€åœ°åï¼‰"
              style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
            />
            <button id="addWorldBookEntry" class="btn primary">æ·»åŠ </button>
          </div>
          <textarea
            id="worldBookContent"
            placeholder="æè¿°å†…å®¹ï¼ˆå½“å‡ºç°å…³é”®è¯æ—¶ï¼Œæ­¤å†…å®¹ä¼šè‡ªåŠ¨æ·»åŠ åˆ°å¯¹è¯ä¸Šä¸‹æ–‡ä¸­ï¼‰"
            style="
              width: 100%;
              padding: 8px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              min-height: 80px;
              resize: vertical;
            "
          ></textarea>
        </div>

        <div style="margin-bottom: 16px">
          <h4 style="margin: 0 0 8px 0; color: #333">å·²æ·»åŠ æ¡ç›®</h4>
          <div
            id="worldBookList"
            style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 8px"
          >
            <!-- ä¸–ç•Œä¹¦æ¡ç›®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          </div>
        </div>

        <div style="display: flex; gap: 8px">
          <button id="worldBookCancel" class="btn ghost" style="flex: 1">å…³é—­</button>
          <button id="clearWorldBook" class="btn" style="flex: 1; background: #ff4757; color: white">æ¸…ç©ºå…¨éƒ¨</button>
        </div>
      </div>
    </div>

    <!-- æ‹ç…§æ¨¡æ€æ¡† -->
    <div id="cameraModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 350px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">ğŸ“· æ‹ç…§æè¿°</h3>
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; color: #666">ç”¨æ–‡å­—æè¿°ä½ æƒ³è¦çš„å›¾ç‰‡å†…å®¹</label>
          <textarea
            id="cameraDescription"
            placeholder="ä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„å°çŒ«ååœ¨é˜³å…‰ä¸‹..."
            style="
              width: 100%;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #eef3fb;
              margin-top: 4px;
              min-height: 80px;
              resize: vertical;
            "
          ></textarea>
        </div>
        <div style="display: flex; gap: 8px">
          <button id="cameraCancel" class="btn ghost" style="flex: 1">å–æ¶ˆ</button>
          <button id="cameraConfirm" class="btn primary" style="flex: 1">å‘é€æè¿°</button>
        </div>
      </div>
    </div>

    <!-- ç›¸å†Œæ¨¡æ€æ¡† -->
    <div id="albumModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 350px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">ğŸ–¼ï¸ é€‰æ‹©å›¾ç‰‡</h3>
        </div>
        <div style="margin-bottom: 16px">
          <input type="file" id="albumFileInput" accept="image/*" style="display: none" />
          <button
            id="selectImageBtn"
            class="btn"
            style="width: 100%; padding: 20px; border: 2px dashed #ddd; background: #f9f9f9"
          >
            ç‚¹å‡»é€‰æ‹©å›¾ç‰‡
          </button>
          <div id="imagePreview" style="margin-top: 12px; text-align: center"></div>
        </div>
        <div style="display: flex; gap: 8px">
          <button id="albumCancel" class="btn ghost" style="flex: 1">å–æ¶ˆ</button>
          <button id="albumConfirm" class="btn primary" style="flex: 1; display: none">å‘é€å›¾ç‰‡</button>
        </div>
      </div>
    </div>

    <!-- Rollé€‰é¡¹æ¨¡æ€æ¡† -->
    <div id="rollOptionsModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 250px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">ğŸ² é€‰æ‹©æ“ä½œ</h3>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px">
          <button id="waitReplyBtn" class="btn primary" style="width: 100%">ç­‰å¾…å›å¤</button>
          <button id="rollBtn" class="btn" style="width: 100%; background: #f39c12; color: white">é‡æ–°ç”Ÿæˆ</button>
        </div>
      </div>
    </div>

    <!-- èŠå¤©è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="chatSettingsModal" class="modal-backdrop">
      <div class="modal" style="padding: 20px; max-width: 400px">
        <div style="text-align: center; padding-bottom: 16px">
          <h3 style="margin: 0; color: #1a8aff">âš™ï¸ èŠå¤©è®¾ç½®</h3>
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">AI æ˜µç§°</label>
          <input
            id="chatCharName"
            placeholder="AIçš„åå­—"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">AI å¤´åƒURL</label>
          <input
            id="chatCharAvatar"
            placeholder="å¤´åƒé“¾æ¥"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">AI äººè®¾</label>
          <textarea
            id="chatCharPrompt"
            placeholder="AIçš„æ€§æ ¼å’Œè¡Œä¸ºè®¾å®š..."
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb; min-height: 60px"
          ></textarea>
        </div>
        <hr style="margin: 16px 0; border: none; border-top: 1px solid #eee" />
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">ä½ çš„æ˜µç§°</label>
          <input
            id="chatUserName"
            placeholder="ä½ çš„åå­—"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="margin-bottom: 16px">
          <label style="font-size: 13px; display: block; margin-bottom: 4px">ä½ çš„å¤´åƒURL</label>
          <input
            id="chatUserAvatar"
            placeholder="å¤´åƒé“¾æ¥"
            style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #eef3fb"
          />
        </div>
        <div style="display: flex; gap: 8px">
          <button id="chatSettingsCancel" class="btn ghost" style="flex: 1">å–æ¶ˆ</button>
          <button id="chatSettingsSave" class="btn primary" style="flex: 1">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å‡½æ•°å®šä¹‰ï¼ˆä¾›onclickäº‹ä»¶ä½¿ç”¨ï¼‰
      function showTransferModal() {
        const modal = document.getElementById('transferModal');
        if (modal) {
          modal.classList.add('active');
          const activeChatName = window.activeChatName || '';
          document.getElementById('transferReceiver').value = activeChatName || '';
          document.getElementById('transferAmount').value = '';
          document.getElementById('transferNote').value = '';
        }
      }

      function showRedPacketModal() {
        const modal = document.getElementById('redPacketModal');
        if (modal) {
          modal.classList.add('active');
          document.getElementById('redPacketAmount').value = '';
          document.getElementById('redPacketCount').value = '1';
          document.getElementById('redPacketMessage').value = 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©';
        }
      }

      function showGroupChatModal() {
        const modal = document.getElementById('groupChatModal');
        if (modal) {
          modal.classList.add('active');
          document.getElementById('groupName').value = '';
          document.getElementById('groupAvatar').value = '';
          document.getElementById('groupDescription').value = '';
        }
      }

      function closeTransferModal() {
        const modal = document.getElementById('transferModal');
        if (modal) modal.classList.remove('active');
      }

      function closeRedPacketModal() {
        const modal = document.getElementById('redPacketModal');
        if (modal) modal.classList.remove('active');
      }

      function closeGroupChatModal() {
        const modal = document.getElementById('groupChatModal');
        if (modal) modal.classList.remove('active');
      }

      function showWorldBookModal() {
        const modal = document.getElementById('worldBookModal');
        if (modal) {
          modal.classList.add('active');
          loadWorldBookEntries();
        }
      }

      function closeWorldBookModal() {
        const modal = document.getElementById('worldBookModal');
        if (modal) modal.classList.remove('active');
      }

      // æ‹ç…§æ¨¡æ€æ¡†
      function showCameraModal() {
        const modal = document.getElementById('cameraModal');
        if (modal) {
          modal.classList.add('active');
          document.getElementById('cameraDescription').value = '';
        }
      }

      function closeCameraModal() {
        const modal = document.getElementById('cameraModal');
        if (modal) modal.classList.remove('active');
      }

      // ç›¸å†Œæ¨¡æ€æ¡†
      function showAlbumModal() {
        const modal = document.getElementById('albumModal');
        if (modal) {
          modal.classList.add('active');
          document.getElementById('imagePreview').innerHTML = '';
          document.getElementById('albumConfirm').style.display = 'none';
        }
      }

      function closeAlbumModal() {
        const modal = document.getElementById('albumModal');
        if (modal) modal.classList.remove('active');
      }

      // Rollé€‰é¡¹æ¨¡æ€æ¡†
      function showRollOptions() {
        const modal = document.getElementById('rollOptionsModal');
        if (modal) modal.classList.add('active');
      }

      function closeRollOptions() {
        const modal = document.getElementById('rollOptionsModal');
        if (modal) modal.classList.remove('active');
      }

      // èŠå¤©è®¾ç½®
      function openChatSettings() {
        const modal = document.getElementById('chatSettingsModal');
        if (modal) {
          modal.classList.add('active');
          loadChatSettings();
        }
      }

      function closeChatSettings() {
        const modal = document.getElementById('chatSettingsModal');
        if (modal) modal.classList.remove('active');
      }

      // åˆ é™¤æ¨¡å¼
      let deleteMode = false;
      function toggleDeleteMode() {
        deleteMode = !deleteMode;
        const deleteBtn = document.getElementById('deleteBtn');
        const messages = document.querySelectorAll('#messages .bubble');

        if (deleteMode) {
          deleteBtn.style.background = '#ff4757';
          deleteBtn.style.color = 'white';
          // ä¸ºæ¯ä¸ªæ¶ˆæ¯æ·»åŠ åˆ é™¤æŒ‰é’®
          messages.forEach((msg, index) => {
            if (!msg.querySelector('.delete-msg-btn')) {
              const delBtn = document.createElement('button');
              delBtn.className = 'delete-msg-btn';
              delBtn.innerHTML = 'âŒ';
              delBtn.style.cssText =
                'position: absolute; top: -5px; right: -5px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;';
              delBtn.onclick = () => deleteMessage(index);
              msg.style.position = 'relative';
              msg.appendChild(delBtn);
            }
          });
        } else {
          deleteBtn.style.background = '';
          deleteBtn.style.color = '';
          // ç§»é™¤æ‰€æœ‰åˆ é™¤æŒ‰é’®
          document.querySelectorAll('.delete-msg-btn').forEach(btn => btn.remove());
        }
      }

      function deleteMessage(index) {
        if (currentMessages && currentMessages[index]) {
          currentMessages.splice(index, 1);
          saveChat(activeChatName);
          // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
          const messagesEl = document.getElementById('messages');
          messagesEl.innerHTML = '';
          currentMessages.forEach(m => renderMessage(m.content, m.role === 'user' ? 'me' : 'assistant'));
          // é‡æ–°è¿›å…¥åˆ é™¤æ¨¡å¼
          deleteMode = false;
          toggleDeleteMode();
        }
      }

      function showMoreOptions() {
        alert('æ›´å¤šåŠŸèƒ½å¼€å‘ä¸­...');
      }

      // è½¬è´¦æ¥æ”¶å¤„ç†
      function showTransferReceived(receiver, amount, note) {
        const receivedCard = `
          <div class="transfer-received" style="
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            max-width: 250px;
            color: #2e7d32;
          ">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span style="color: #4caf50; margin-right: 8px;">âœ…</span>
              <span style="font-weight: bold;">è½¬è´¦å·²æ¥æ”¶</span>
            </div>
            <div style="font-size: 18px; font-weight: bold; margin: 8px 0; color: #2e7d32;">Â¥${amount}</div>
            <div style="font-size: 12px; color: #666;">æ¥è‡ª: ${receiver}</div>
            ${note ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${note}</div>` : ''}
            <div style="text-align: center; margin-top: 8px; font-size: 12px; color: #4caf50;">
              è½¬è´¦å·²åˆ°è´¦
            </div>
          </div>
        `;
        appendMessage(receivedCard, 'assistant');
      }

      // çº¢åŒ…æ¥æ”¶å¤„ç†
      function showRedPacketReceived(type, amount, count, message) {
        const randomAmount =
          type === 'lucky'
            ? (Math.random() * parseFloat(amount)).toFixed(2)
            : (parseFloat(amount) / parseInt(count)).toFixed(2);
        const receivedCard = `
          <div class="redpacket-received" style="
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            max-width: 250px;
            text-align: center;
            color: #e65100;
          ">
            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ‰</div>
            <div style="font-weight: bold; margin-bottom: 8px;">æ­å–œå‘è´¢!</div>
            <div style="font-size: 20px; font-weight: bold; color: #ff5722; margin: 8px 0;">Â¥${randomAmount}</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${message}</div>
            <div style="font-size: 10px; color: #999;">
              ${type === 'lucky' ? 'æ‹¼æ‰‹æ°”çº¢åŒ…' : 'æ™®é€šçº¢åŒ…'} Â· å·²é¢†å–
            </div>
          </div>
        `;
        appendMessage(receivedCard, 'assistant');
      }

      (function () {
        const screens = ['chat-screen', 'settings-screen', 'qq-screen', 'api-screen'];
        document.querySelectorAll('.app-row .app').forEach(a =>
          a.addEventListener('click', e => {
            e.preventDefault();
            document.getElementById('app-row').style.display = 'none';
            screens.forEach(id => document.getElementById(id).classList.remove('active'));
            const t = a.getAttribute('data-screen');
            if (t) document.getElementById(t).classList.add('active');
          }),
        );
        document.querySelectorAll('.back-btn').forEach(b =>
          b.addEventListener('click', () => {
            document.getElementById('app-row').style.display = 'grid';
            screens.forEach(id => document.getElementById(id).classList.remove('active'));
          }),
        );

        // API form connect
        const apiForm = document.getElementById('apiForm');
        if (apiForm) {
          const apiUrl = document.getElementById('apiUrl');
          const apiKey = document.getElementById('apiKey');
          const modelSelect = document.getElementById('modelSelect');
          const statusEl = document.getElementById('status');
          function buildModelsUrl(base) {
            base = (base || '').replace(/\/$/, '');
            if (/\/v1(\/|$)/.test(base)) return base + '/models';
            return base + '/v1/models';
          }
          function buildChatUrl(base) {
            base = (base || '').replace(/\/$/, '');
            if (/\/v1(\/|$)/.test(base)) return base + '/chat/completions';
            return base + '/v1/chat/completions';
          }

          async function connectAndFillModels(showStatus = true) {
            try {
              if (showStatus && statusEl) statusEl.textContent = 'è¿æ¥ä¸­...';
              const base = (apiUrl.value || '').trim();
              const modelsUrl = buildModelsUrl(base);
              const res = await fetch(modelsUrl, {
                headers: apiKey.value ? { Authorization: 'Bearer ' + apiKey.value } : {},
              });
              const text = await res.text();
              if (!res.ok) {
                // show raw body for debugging
                const msg = `HTTP ${res.status} ${text}`;
                throw new Error(msg);
              }
              let j = {};
              try {
                j = JSON.parse(text || '{}');
              } catch (e) {
                // not JSON
                j = { data: [] };
              }
              const models = (j.data || j.models || []).map(m => m.id || m.name || m);
              modelSelect.innerHTML = '';
              models.forEach(m => {
                const o = document.createElement('option');
                o.value = m;
                o.textContent = m;
                modelSelect.appendChild(o);
              });
              modelSelect.style.display = 'block';
              if (models.length) {
                const savedModel = localStorage.getItem('api-model');
                if (savedModel && models.indexOf(savedModel) >= 0) modelSelect.value = savedModel;
                else modelSelect.value = models[0];
              }
              document.getElementById('saveBtn').classList.remove('hidden');
              // è‡ªåŠ¨ä¿å­˜å½“å‰æœ‰æ•ˆé…ç½®ï¼Œé¿å…åˆ·æ–°ä¸¢å¤±
              localStorage.setItem('api-url', apiUrl.value);
              localStorage.setItem('api-key', apiKey.value);
              if (modelSelect && modelSelect.value) localStorage.setItem('api-model', modelSelect.value);
              if (showStatus && statusEl) {
                statusEl.style.color = '#28a745';
                statusEl.textContent = 'å·²è¿æ¥';
                setTimeout(() => (statusEl.textContent = ''), 3500);
              }
              return true;
            } catch (err) {
              console.error('è¿æ¥å¤±è´¥: ' + err.message);
              if (statusEl) {
                statusEl.style.color = '#f44';
                statusEl.textContent = 'è¿æ¥å¤±è´¥: ' + err.message;
                setTimeout(() => (statusEl.textContent = ''), 3500);
              }
              return false;
            }
          }

          apiForm.addEventListener('submit', async e => {
            e.preventDefault();
            await connectAndFillModels(true);
          });
          // å½“ç”¨æˆ·æ›´æ”¹æ¨¡å‹æ—¶ï¼Œä¿å­˜é€‰æ‹©
          if (modelSelect) {
            modelSelect.addEventListener('change', () => {
              if (modelSelect.value) localStorage.setItem('api-model', modelSelect.value);
            });
          }
          document.getElementById('saveBtn').addEventListener('click', () => {
            localStorage.setItem('api-url', apiUrl.value);
            localStorage.setItem('api-key', apiKey.value);
            // å¦‚æœæœ‰é€‰ä¸­çš„æ¨¡å‹ä¸€èµ·ä¿å­˜
            if (modelSelect && modelSelect.value) localStorage.setItem('api-model', modelSelect.value);
            console.log('å·²ä¿å­˜ API é…ç½®');
            if (statusEl) {
              statusEl.style.color = '#28a745';
              statusEl.textContent = 'å·²ä¿å­˜';
              setTimeout(() => (statusEl.textContent = ''), 3500);
            }
          });
          apiUrl.value = localStorage.getItem('api-url') || '';
          apiKey.value = localStorage.getItem('api-key') || '';
          // å¦‚æœå·²æœ‰å€¼ï¼Œæ˜¾ç¤ºä¿å­˜æŒ‰é’®ï¼Œé¿å…ç”¨æˆ·ä»¥ä¸ºæ²¡æœ‰ä¿å­˜
          if ((apiUrl.value && apiUrl.value.trim()) || (apiKey.value && apiKey.value.trim())) {
            document.getElementById('saveBtn').classList.remove('hidden');
          }
          // è‡ªåŠ¨åœ¨è¾“å…¥å˜åŒ–æ—¶ä¿å­˜ï¼Œç¡®ä¿åˆ·æ–°ä¸ä¼šä¸¢å¤±ï¼ˆä¹Ÿä¾¿äºè°ƒè¯•ï¼‰
          apiUrl.addEventListener('change', () => {
            localStorage.setItem('api-url', apiUrl.value || '');
            document.getElementById('saveBtn').classList.remove('hidden');
            if (statusEl) {
              statusEl.style.color = '#28a745';
              statusEl.textContent = 'å·²ä¿å­˜';
              setTimeout(() => (statusEl.textContent = ''), 2000);
            }
          });
          apiKey.addEventListener('change', () => {
            localStorage.setItem('api-key', apiKey.value || '');
            document.getElementById('saveBtn').classList.remove('hidden');
            if (statusEl) {
              statusEl.style.color = '#28a745';
              statusEl.textContent = 'å·²ä¿å­˜';
              setTimeout(() => (statusEl.textContent = ''), 2000);
            }
          });
          // æ¢å¤ä¸Šæ¬¡ä¿å­˜çš„æ¨¡å‹ï¼ˆè‹¥æœ‰ï¼‰
          const savedModel = localStorage.getItem('api-model');
          if (savedModel) {
            // å¦‚æœä¹‹å‰ä¿å­˜äº† url/keyï¼Œå°è¯•è‡ªåŠ¨è¿æ¥å¹¶æ¢å¤æ¨¡å‹
            if (apiUrl.value && apiKey.value) {
              // ä¸æ˜¾ç¤ºè¿æ¥æç¤ºï¼ˆç”¨æˆ·åˆ·æ–°æ—¶é™é»˜æ¢å¤ï¼‰
              connectAndFillModels(false);
            }
          }

          // å†å²åŠŸèƒ½å·²ç§»é™¤ï¼šä¸ºäº†åŒ¹é… UI è¦æ±‚ï¼Œç›¸å…³å†å²å­˜å‚¨ä¸äº‹ä»¶ç›‘å¬å·²åˆ é™¤
        }

        // ç®€å•èŠå¤©äº¤äº’
        const messagesEl = document.getElementById('messages');
        const inputBox = document.getElementById('inputBox');
        const sendBtn = document.getElementById('sendBtn');
        // å½“å‰æ¿€æ´»ä¼šè¯åä¸å†…å­˜æ¶ˆæ¯æ•°ç»„
        let activeChatName = null;
        let currentMessages = [];
        // è¯·æ±‚äº’æ–¥æ ‡å¿—ï¼Œé¿å…é‡å¤å¹¶å‘ç”Ÿæˆå¯¼è‡´å¤šæ¡å›å¤
        let pendingRequest = false;

        function saveChat(name) {
          if (!name) return;
          try {
            const data = JSON.stringify(currentMessages || []);
            localStorage.setItem('chat:' + name, data);
            console.log(`èŠå¤©è®°å½•å·²ä¿å­˜: ${name}, æ¶ˆæ¯æ•°é‡: ${(currentMessages || []).length}`);
          } catch (e) {
            console.error('ä¿å­˜èŠå¤©åˆ° localStorage å¤±è´¥', e);
            // å°è¯•æ¸…ç†ä¸€äº›ç©ºé—´
            try {
              const keys = Object.keys(localStorage);
              keys.forEach(key => {
                if (key.startsWith('chat:') && !localStorage.getItem(key)) {
                  localStorage.removeItem(key);
                }
              });
              // é‡è¯•ä¿å­˜
              localStorage.setItem('chat:' + name, JSON.stringify(currentMessages || []));
            } catch (retryError) {
              console.error('é‡è¯•ä¿å­˜ä¹Ÿå¤±è´¥äº†', retryError);
            }
          }
        }

        function loadChat(name) {
          if (!name) return [];
          try {
            const txt = localStorage.getItem('chat:' + name);
            if (!txt) {
              console.log(`æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½•: ${name}`);
              return [];
            }
            const data = JSON.parse(txt);
            console.log(`èŠå¤©è®°å½•å·²åŠ è½½: ${name}, æ¶ˆæ¯æ•°é‡: ${data.length}`);
            return data;
          } catch (e) {
            console.error('è¯»å–èŠå¤©å¤±è´¥', e);
            // å°è¯•ä¿®å¤æŸåçš„æ•°æ®
            try {
              localStorage.removeItem('chat:' + name);
              console.log(`å·²æ¸…ç†æŸåçš„èŠå¤©è®°å½•: ${name}`);
            } catch (cleanupError) {
              console.error('æ¸…ç†å¤±è´¥', cleanupError);
            }
            return [];
          }
        }

        // ä»…æ¸²æŸ“æ¶ˆæ¯åˆ° DOMï¼ˆä¸ä¿®æ”¹å†…å­˜æˆ– localStorageï¼‰
        function renderMessage(text, who) {
          const row = document.createElement('div');
          row.className = 'message-row ' + (who === 'me' ? 'me' : '');

          // avatar
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'avatar';
          // å†³å®šå¤´åƒï¼šä¼˜å…ˆä½¿ç”¨å½“å‰ä¼šè¯çš„ä¸“å±è®¾ç½®ï¼Œç„¶åæ˜¯å…¨å±€è®¾ç½®
          try {
            if (who === 'me') {
              let ua = '';
              let uname = '';

              // ä¼˜å…ˆä½¿ç”¨å½“å‰ä¼šè¯çš„ç”¨æˆ·è®¾ç½®
              if (activeChatName) {
                try {
                  const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
                  ua = meta.userAvatar || '';
                  uname = meta.userName || '';
                } catch (e) {}
              }

              // å¦‚æœå½“å‰ä¼šè¯æ²¡æœ‰è®¾ç½®ï¼Œå›é€€åˆ°å…¨å±€è®¾ç½®
              if (!ua) ua = localStorage.getItem('user-avatar') || '';
              if (!uname) uname = localStorage.getItem('user-name') || '';

              if (ua) {
                const img = document.createElement('img');
                img.src = ua;
                avatarDiv.appendChild(img);
              } else {
                avatarDiv.textContent = uname && uname[0] ? uname[0] : 'æˆ‘';
              }
            } else {
              let a = '';
              let label = '';

              // è·å–AIå¤´åƒå’Œåç§°
              if (activeChatName) {
                try {
                  const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
                  a = meta.avatar || '';
                  label = meta.name || activeChatName;
                } catch (e) {}
              }

              // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œå›é€€åˆ°å…¨å±€é»˜è®¤
              if (!a) a = localStorage.getItem('default-char-avatar') || '';

              if (a) {
                const img = document.createElement('img');
                img.src = a;
                avatarDiv.appendChild(img);
              } else {
                avatarDiv.textContent = label && label[0] ? label[0] : 'AI';
              }
            }
          } catch (e) {
            avatarDiv.textContent = who === 'me' ? 'æˆ‘' : 'AI';
          }

          const bubble = document.createElement('div');
          bubble.className = 'bubble ' + (who === 'me' ? 'me' : '');
          bubble.innerText = text;

          if (who === 'me') {
            row.appendChild(bubble);
            row.appendChild(avatarDiv);
          } else {
            row.appendChild(avatarDiv);
            row.appendChild(bubble);
          }

          messagesEl.appendChild(row);
        }

        // è¿½åŠ æ¶ˆæ¯å¹¶ä¿å­˜åˆ°å½“å‰ä¼šè¯
        function appendMessage(text, who) {
          renderMessage(text, who);
          messagesEl.scrollTop = messagesEl.scrollHeight;
          // ä¿å­˜åˆ°å½“å‰ä¼šè¯
          if (activeChatName) {
            currentMessages.push({ role: who === 'me' ? 'user' : 'assistant', content: text, ts: Date.now() });
            saveChat(activeChatName);
          }
        }
        // å°†è¯·æ±‚é€»è¾‘æå–ä¸ºä¸€ä¸ªå¯å¤ç”¨å‡½æ•°ï¼šrequestReply(text, { appendUser: true/false })
        async function requestReply(text, opts = { appendUser: true }) {
          const t = (text || '').trim();
          if (!t) return;
          if (pendingRequest) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
              statusEl.style.color = '#f5a623';
              statusEl.textContent = 'æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...';
              setTimeout(() => (statusEl.textContent = ''), 1800);
            }
            return;
          }
          pendingRequest = true;
          // ç¦ç”¨å‘é€ä¸é‡ç”ŸæŒ‰é’®ä»¥é¿å…å¹¶å‘
          const rollFooterEl = document.getElementById('rollFooterBtn');
          if (rollFooterEl) rollFooterEl.disabled = true;
          if (sendBtn) sendBtn.disabled = true;
          if (opts.appendUser) {
            appendMessage(t, 'me');
          }

          // åº”ç”¨ä¸–ç•Œä¹¦
          let worldBookContext = '';
          try {
            worldBookContext = applyWorldBook(t);
          } catch (e) {
            console.error('ä¸–ç•Œä¹¦åº”ç”¨å¤±è´¥', e);
          }

          // ä»é…ç½®è¯»å– endpoint/key/model
          const base =
            (document.getElementById('apiUrl') && document.getElementById('apiUrl').value) ||
            localStorage.getItem('api-url') ||
            '';
          const key =
            (document.getElementById('apiKey') && document.getElementById('apiKey').value) ||
            localStorage.getItem('api-key') ||
            '';
          const model =
            (document.getElementById('modelSelect') && document.getElementById('modelSelect').value) ||
            localStorage.getItem('api-model') ||
            '';

          if (!base || !key) {
            // æ²¡æœ‰é…ç½® APIï¼Œå°±ä¸å‘è¯·æ±‚ï¼ˆä¿æŒæœ¬åœ°å±•ç¤ºï¼‰
            return;
          }

          // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥çš„ typing æŒ‡ç¤ºå™¨
          const typing = document.createElement('div');
          typing.className = 'bubble';
          const span = document.createElement('div');
          span.className = 'typing-dots';
          span.innerHTML = '<span></span><span></span><span></span>';
          typing.appendChild(span);
          messagesEl.appendChild(typing);
          messagesEl.scrollTop = messagesEl.scrollHeight;

          try {
            const url = buildChatUrl(base);
            // å°è¯•æ³¨å…¥ system promptï¼ˆä¼šè¯çº§åˆ«ä¼˜å…ˆï¼Œç„¶åé»˜è®¤è®¾ç½®ï¼‰
            let sysPrompt = '';
            try {
              if (activeChatName) {
                const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
                if (meta && meta.prompt) sysPrompt = meta.prompt;
              }
            } catch (e) {}
            if (!sysPrompt) sysPrompt = localStorage.getItem('default-char-prompt') || '';

            const messagesPayload = [];
            // æ³¨å…¥ç”¨æˆ·å…ƒæ•°æ®ï¼Œè®©æ¨¡å‹çŸ¥é“ user çš„åå­—ç­‰ï¼ˆä½œä¸º system æè¿°ï¼‰
            try {
              const uname = localStorage.getItem('user-name') || '';
              if (uname) messagesPayload.push({ role: 'system', content: `User name: ${uname}` });
            } catch (e) {}
            if (sysPrompt) messagesPayload.push({ role: 'system', content: sysPrompt });

            // æ·»åŠ ä¸–ç•Œä¹¦ä¸Šä¸‹æ–‡
            if (worldBookContext) {
              messagesPayload.push({ role: 'system', content: `ä¸–ç•Œä¹¦ä¿¡æ¯: ${worldBookContext}` });
            }

            messagesPayload.push({ role: 'user', content: t });

            const body = {
              model: model || undefined,
              messages: messagesPayload,
              temperature: 0.7,
            };
            const res = await fetch(url, {
              method: 'POST',
              headers: Object.assign(
                { 'Content-Type': 'application/json' },
                key ? { Authorization: 'Bearer ' + key } : {},
              ),
              body: JSON.stringify(body),
            });
            const raw = await res.text();
            if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + raw);
            let j = {};
            try {
              j = JSON.parse(raw || '{}');
            } catch (e) {
              j = {};
            }
            let reply = '';
            if (j.choices && j.choices[0])
              reply = (j.choices[0].message && j.choices[0].message.content) || j.choices[0].text || '';
            if (!reply && j.text) reply = j.text;
            typing.remove();
            if (reply) appendMessage(reply, 'assistant');
            else appendMessage('[ç©ºå“åº”]', 'assistant');
          } catch (err) {
            typing.remove();
            appendMessage('[è¯·æ±‚å¤±è´¥] ' + err.message, 'assistant');
            const statusEl = document.getElementById('status');
            if (statusEl) {
              statusEl.style.color = '#f44';
              statusEl.textContent = 'è¯·æ±‚å¤±è´¥: ' + err.message;
              setTimeout(() => (statusEl.textContent = ''), 4000);
            }
          } finally {
            pendingRequest = false;
            const rollFooterEl2 = document.getElementById('rollFooterBtn');
            if (rollFooterEl2) rollFooterEl2.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
          }
        }

        if (sendBtn)
          sendBtn.addEventListener('click', () => {
            const t = (inputBox.value || '').trim();
            if (!t) return;
            inputBox.value = '';
            // åªå‘é€æ¶ˆæ¯ï¼Œä¸è¯·æ±‚AIå›å¤
            appendMessage(t, 'me');
          });

        // API å“åº”ç›¸å…³å·²ç§»é™¤

        // QQ å ä½æ¸²æŸ“ï¼ˆä¸ä½¿ç”¨ç¤ºä¾‹å¯¹è¯ï¼‰
        function renderQQPlaceholder() {
          const list = document.getElementById('qq-session-list');
          if (!list) return;
          if (!list.children.length) {
            list.innerHTML = '<div class="placeholder-qq">æš‚æ— ä¼šè¯ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ ä¸€ä¸ª</div>';
          }
        }
        renderQQPlaceholder();

        // æ·»åŠ ä¼šè¯æ¨¡æ€ï¼ˆåœ¨é¡µé¢åº•éƒ¨æœ‰å¯¹åº” DOMï¼‰
        const addBtn = document.getElementById('addPersonaBtn');
        const addModal = document.getElementById('addModal');
        const charInput = document.getElementById('charNameInput');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const confirmAddBtn = document.getElementById('confirmAddBtn');

        if (addBtn)
          addBtn.addEventListener('click', () => {
            if (addModal) {
              addModal.classList.add('active');
              if (charInput) {
                // æ–°å»ºæ—¶æ¸…ç©ºè¾“å…¥ï¼Œä»…å°† default åç§°ä½œä¸º placeholder æç¤º
                const def = localStorage.getItem('default-char-name') || '';
                charInput.value = '';
                charInput.placeholder = def || 'ä¾‹å¦‚ï¼šæ±‰å ¡å ¡';
                charInput.focus();
              }
            }
          });
        if (cancelAddBtn)
          cancelAddBtn.addEventListener('click', () => {
            if (addModal) addModal.classList.remove('active');
          });
        if (confirmAddBtn)
          confirmAddBtn.addEventListener('click', () => {
            const name = (charInput && charInput.value.trim()) || localStorage.getItem('default-char-name') || 'æ±‰å ¡å ¡';
            const list = document.getElementById('qq-session-list');
            if (!list) return;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåä¼šè¯
            const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
            if (sessions.indexOf(name) !== -1) {
              alert('ä¼šè¯åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
              return;
            }

            const placeholder = list.querySelector('.placeholder-qq');
            if (placeholder) placeholder.remove();
            const el = document.createElement('div');
            el.className = 'qq-session';

            // ä¸ºæ–°ä¼šè¯åˆ›å»ºç‹¬ç«‹çš„è®¾ç½®
            const metaKey = 'chatmeta:' + name;
            const newMeta = {
              name: name,
              avatar: '', // æ–°ä¼šè¯ä¸ç»§æ‰¿å¤´åƒ
              prompt: '', // æ–°ä¼šè¯ä¸ç»§æ‰¿æç¤º
              userName: '', // æ–°ä¼šè¯ä½¿ç”¨ç‹¬ç«‹çš„ç”¨æˆ·è®¾ç½®
              userAvatar: '', // æ–°ä¼šè¯ä½¿ç”¨ç‹¬ç«‹çš„ç”¨æˆ·å¤´åƒ
              isGroup: false,
            };

            try {
              localStorage.setItem(metaKey, JSON.stringify(newMeta));
              console.log(`[CREATE] åˆ›å»ºæ–°ä¼šè¯: ${name}ï¼Œç‹¬ç«‹è®¾ç½®å·²åˆå§‹åŒ–`);
            } catch (e) {
              console.error('åˆå§‹åŒ–ä¼šè¯è®¾ç½®å¤±è´¥', e);
            }

            // æ¸²æŸ“ä¼šè¯é¡¹ï¼ˆæ–°ä¼šè¯ä½¿ç”¨é¦–å­—æ¯å¤´åƒï¼‰
            el.innerHTML = `<div class="qq-avatar">${
              name[0] || 'æˆ‘'
            }</div><div class="info"><div class="name">${name} <span class="meta">Â· åˆšåˆš</span></div><div class="msg">ä¸ ${name} çš„å¯¹è¯</div></div><button class="qq-del">åˆ é™¤</button>`;

            list.insertBefore(el, list.firstChild);

            // persist sessions list
            try {
              sessions.push(name);
              localStorage.setItem('qq-sessions', JSON.stringify(sessions));

              // åˆ·æ–° UI
              try {
                renderUserDisplay();
                refreshSessionListAvatars();
                refreshMessageAvatars();
              } catch (e) {}
            } catch (e) {
              console.error('ä¿å­˜ä¼šè¯åˆ—è¡¨å¤±è´¥', e);
            }
            if (addModal) addModal.classList.remove('active');
          });
        if (addModal)
          addModal.addEventListener('click', e => {
            if (e.target === addModal) addModal.classList.remove('active');
          });
        // æ¨¡æ€ç¡®è®¤å·¥å…·ï¼Œè¿”å› Promise<boolean>
        const confirmModalEl = document.getElementById('confirmModal');
        const confirmOkBtn = document.getElementById('confirmOk');
        const confirmCancelBtn = document.getElementById('confirmCancel');
        const confirmTitleEl = document.getElementById('confirmTitle');
        const confirmBodyEl = document.getElementById('confirmBody');
        function showConfirm(title, body) {
          return new Promise(resolve => {
            if (!confirmModalEl) return resolve(window.confirm(body));
            confirmTitleEl.textContent = title || 'ç¡®è®¤';
            confirmBodyEl.textContent = body || '';
            confirmModalEl.classList.add('active');
            function done(val) {
              confirmModalEl.classList.remove('active');
              confirmOkBtn.removeEventListener('click', onOk);
              confirmCancelBtn.removeEventListener('click', onCancel);
              resolve(val);
            }
            function onOk() {
              done(true);
            }
            function onCancel() {
              done(false);
            }
            confirmOkBtn.addEventListener('click', onOk);
            confirmCancelBtn.addEventListener('click', onCancel);
          });
        }
        // è®¾ç½®æ¨¡æ€äº¤äº’ï¼šæ‰“å¼€/è¯»å–/ä¿å­˜
        const settingsModal = document.getElementById('settingsModal');
        const settingsCharName = document.getElementById('settingsCharName');
        const settingsCharAvatar = document.getElementById('settingsCharAvatar');
        const settingsCharPrompt = document.getElementById('settingsCharPrompt');
        const settingsUserName = document.getElementById('settingsUserName');
        const settingsUserAvatar = document.getElementById('settingsUserAvatar');
        const settingsSaveBtn = document.getElementById('settingsSave');
        const settingsCancelBtn = document.getElementById('settingsCancel');

        function openSettingsModal() {
          if (!settingsModal) return;
          settingsModal.classList.add('active');

          // æ ¹æ®å½“å‰ä¼šè¯åŠ è½½è®¾ç½®
          if (activeChatName) {
            try {
              // åŠ è½½å½“å‰ä¼šè¯çš„ä¸“å±è®¾ç½®
              const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');

              settingsCharName.value = meta.name || activeChatName || '';
              settingsCharAvatar.value = meta.avatar || '';
              settingsCharPrompt.value = meta.prompt || '';
              settingsUserName.value = meta.userName || localStorage.getItem('user-name') || '';
              settingsUserAvatar.value = meta.userAvatar || localStorage.getItem('user-avatar') || '';

              console.log(`[SETTINGS] å·²åŠ è½½ä¼šè¯è®¾ç½®: ${activeChatName}`, meta);
            } catch (e) {
              console.error('åŠ è½½ä¼šè¯è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®', e);
              // fallbackåˆ°å…¨å±€è®¾ç½®
              settingsCharName.value = localStorage.getItem('default-char-name') || '';
              settingsCharAvatar.value = localStorage.getItem('default-char-avatar') || '';
              settingsCharPrompt.value = localStorage.getItem('default-char-prompt') || '';
              settingsUserName.value = localStorage.getItem('user-name') || '';
              settingsUserAvatar.value = localStorage.getItem('user-avatar') || '';
            }
          } else {
            // æ²¡æœ‰æ¿€æ´»ä¼šè¯æ—¶ï¼ŒåŠ è½½å…¨å±€é»˜è®¤è®¾ç½®
            settingsCharName.value = localStorage.getItem('default-char-name') || '';
            settingsCharAvatar.value = localStorage.getItem('default-char-avatar') || '';
            settingsCharPrompt.value = localStorage.getItem('default-char-prompt') || '';
            settingsUserName.value = localStorage.getItem('user-name') || '';
            settingsUserAvatar.value = localStorage.getItem('user-avatar') || '';
          }

          // é¢„è§ˆå·²ä¿å­˜çš„å¤´åƒï¼ˆå¦‚æœæ˜¯ dataURL æˆ– URLï¼‰
          try {
            previewImageEl(document.getElementById('settingsCharAvatarPreview'), settingsCharAvatar.value);
          } catch (e) {}
          try {
            previewImageEl(document.getElementById('settingsUserAvatarPreview'), settingsUserAvatar.value);
          } catch (e) {}
        }

        function closeSettingsModal() {
          if (!settingsModal) return;
          settingsModal.classList.remove('active');
        }
        // æ›´æ–°èŠå¤©ç•Œé¢çš„è”ç³»äººä¿¡æ¯
        function updateChatContactInfo() {
          if (!activeChatName) return;

          try {
            // æ›´æ–°èŠå¤©æ ‡é¢˜
            const chatTitle = document.getElementById('chatTitle');
            const contactStatus = document.getElementById('contactStatus');
            const contactAvatar = document.getElementById('contactAvatar');

            // è·å–å½“å‰ä¼šè¯çš„è®¾ç½®
            const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');

            // æ›´æ–°æ ‡é¢˜
            if (chatTitle) {
              chatTitle.textContent = meta.name || activeChatName;
            }

            // æ›´æ–°çŠ¶æ€
            if (contactStatus) {
              contactStatus.textContent = meta.isGroup ? 'ç¾¤èŠ' : 'åœ¨çº¿';
            }

            // æ›´æ–°å¤´åƒ
            if (contactAvatar) {
              contactAvatar.innerHTML = '';
              if (meta.avatar) {
                const img = document.createElement('img');
                img.src = meta.avatar;
                contactAvatar.appendChild(img);
              } else {
                contactAvatar.textContent = (meta.name || activeChatName)[0] || 'AI';
              }
            }
          } catch (e) {
            console.error('æ›´æ–°è”ç³»äººä¿¡æ¯å¤±è´¥', e);
          }
        }

        // è°ƒè¯•ç”¨çš„çŸ­æç¤ºï¼ˆç”¨äºç¡®è®¤äº‹ä»¶è¢«è§¦å‘ï¼‰
        function showDebugToast(msg) {
          try {
            let t = document.getElementById('debugToast');
            if (!t) {
              t = document.createElement('div');
              t.id = 'debugToast';
              t.style.position = 'fixed';
              t.style.left = '50%';
              t.style.top = '8%';
              t.style.transform = 'translateX(-50%)';
              t.style.background = 'rgba(0,0,0,0.7)';
              t.style.color = '#fff';
              t.style.padding = '8px 12px';
              t.style.borderRadius = '6px';
              t.style.zIndex = '9999';
              document.body.appendChild(t);
            }
            t.textContent = msg || 'debug';
            t.style.display = 'block';
            setTimeout(() => (t.style.display = 'none'), 2000);
          } catch (e) {}
        }

        // å°†è®¾ç½®ä¿å­˜åˆ° localStorage
        if (settingsSaveBtn)
          settingsSaveBtn.addEventListener('click', () => {
            try {
              const cname = (settingsCharName && settingsCharName.value.trim()) || '';
              const cavatar = (settingsCharAvatar && settingsCharAvatar.value) || '';
              const cprompt = (settingsCharPrompt && settingsCharPrompt.value) || '';
              const uname = (settingsUserName && settingsUserName.value) || '';
              const uavatar = (settingsUserAvatar && settingsUserAvatar.value) || '';

              // å¦‚æœå½“å‰æœ‰æ¿€æ´»çš„èŠå¤©ä¼šè¯ï¼Œä¿å­˜åˆ°ä¼šè¯ä¸“å±è®¾ç½®
              if (activeChatName) {
                try {
                  const metaKey = 'chatmeta:' + activeChatName;
                  const meta = JSON.parse(localStorage.getItem(metaKey) || '{}');

                  // ä¿å­˜AIè®¾ç½®åˆ°å½“å‰ä¼šè¯
                  if (cname) meta.name = cname;
                  if (cavatar) meta.avatar = cavatar;
                  if (cprompt) meta.prompt = cprompt;

                  // ä¿å­˜ç”¨æˆ·è®¾ç½®åˆ°å½“å‰ä¼šè¯
                  meta.userName = uname;
                  meta.userAvatar = uavatar;

                  localStorage.setItem(metaKey, JSON.stringify(meta));
                  console.log(`[SETTINGS] å·²ä¿å­˜ä¼šè¯ä¸“å±è®¾ç½®: ${activeChatName}`, meta);
                } catch (e) {
                  console.error('ä¿å­˜ä¼šè¯è®¾ç½®å¤±è´¥', e);
                }
              } else {
                // æ²¡æœ‰æ¿€æ´»ä¼šè¯æ—¶ï¼Œä¿å­˜ä¸ºå…¨å±€é»˜è®¤è®¾ç½®
                localStorage.setItem('default-char-name', cname);
                localStorage.setItem('default-char-avatar', cavatar);
                localStorage.setItem('default-char-prompt', cprompt);
                localStorage.setItem('user-name', uname);
                localStorage.setItem('user-avatar', uavatar);
                console.log('[SETTINGS] å·²ä¿å­˜å…¨å±€é»˜è®¤è®¾ç½®');
              }

              // ç®€çŸ­æç¤º
              const statusEl = document.getElementById('status');
              if (statusEl) {
                statusEl.style.color = '#28a745';
                statusEl.textContent = 'å·²ä¿å­˜è®¾ç½®';
                setTimeout(() => (statusEl.textContent = ''), 2000);
              }

              // æ›´æ–°å½“å‰æ˜¾ç¤º
              try {
                renderUserDisplay();
                refreshSessionListAvatars();
                refreshMessageAvatars();

                // å¦‚æœåœ¨èŠå¤©ç•Œé¢ï¼Œæ›´æ–°è”ç³»äººä¿¡æ¯
                if (activeChatName) {
                  updateChatContactInfo();
                }
              } catch (e) {
                console.error('æ›´æ–°æ˜¾ç¤ºå¤±è´¥', e);
              }
              // å¦‚æœå½“å‰æ‰“å¼€äº†ä¼šè¯å¹¶ä¸”ä¿®æ”¹äº† AI åç§°ï¼Œå°è¯•é‡å‘½åå½“å‰ä¼šè¯å¹¶è¿ç§»æ•°æ®
              try {
                const newChar = (settingsCharName && settingsCharName.value && settingsCharName.value.trim()) || '';
                if (newChar && activeChatName && newChar !== activeChatName) {
                  // å¦‚æœç›®æ ‡åå·²å­˜åœ¨ï¼Œæç¤ºå¹¶è·³è¿‡è¿ç§»
                  if (localStorage.getItem('chat:' + newChar)) {
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                      statusEl.style.color = '#f44';
                      statusEl.textContent = 'ä¼šè¯åå·²å­˜åœ¨ï¼Œæœªæ‰§è¡Œé‡å‘½å';
                      setTimeout(() => (statusEl.textContent = ''), 3000);
                    }
                  } else {
                    // è¿ç§»èŠå¤©è®°å½•
                    try {
                      const oldChat = localStorage.getItem('chat:' + activeChatName);
                      if (oldChat != null) {
                        localStorage.setItem('chat:' + newChar, oldChat);
                        localStorage.removeItem('chat:' + activeChatName);
                      }
                    } catch (e) {}
                    // è¿ç§» meta
                    try {
                      const oldMeta = localStorage.getItem('chatmeta:' + activeChatName);
                      if (oldMeta != null) {
                        localStorage.setItem('chatmeta:' + newChar, oldMeta);
                        localStorage.removeItem('chatmeta:' + activeChatName);
                      }
                    } catch (e) {}
                    // æ›´æ–° qq-sessions åˆ—è¡¨
                    try {
                      const list = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
                      const idx = list.indexOf(activeChatName);
                      if (idx >= 0) {
                        list[idx] = newChar;
                        localStorage.setItem('qq-sessions', JSON.stringify(list));
                      }
                      // æ›´æ–° DOM åˆ—è¡¨é¡¹æ–‡æœ¬
                      const qqListEl = document.getElementById('qq-session-list');
                      if (qqListEl) {
                        const items = qqListEl.querySelectorAll('.qq-session');
                        items.forEach(it => {
                          const nameEl = it.querySelector('.name');
                          if (nameEl && nameEl.childNodes[0].textContent.trim() === activeChatName) {
                            nameEl.childNodes[0].textContent = newChar;
                          }
                        });
                      }
                    } catch (e) {}
                    // åˆ‡æ¢ activeChatName å¹¶é‡æ–°åŠ è½½æ¶ˆæ¯åŒº
                    try {
                      activeChatName = newChar;
                      const messages = document.getElementById('messages');
                      if (messages) {
                        messages.innerHTML = '';
                        currentMessages = loadChat(activeChatName) || [];
                        currentMessages.forEach(m => renderMessage(m.content, m.role === 'user' ? 'me' : 'assistant'));
                      }
                      const navStrong = document.querySelector('#chat-screen .nav strong');
                      if (navStrong) navStrong.textContent = activeChatName;
                    } catch (e) {}
                  }
                }
              } catch (e) {}
              // è¿ç§»ä¸ä¿å­˜é€»è¾‘å®Œæˆåï¼Œåç»­ä¼šåœ¨å†™å…¥ avatar åç»Ÿä¸€åˆ·æ–° UI
            } catch (e) {
              console.error('ä¿å­˜è®¾ç½®å¤±è´¥', e);
            }
            // ä¿å­˜åæ›´æ–°é¢„è§ˆå¹¶å­˜å‚¨å¯èƒ½ä¸º dataURL çš„å¤´åƒï¼Œå¹¶åŒæ­¥åˆ°å½“å‰ä¼šè¯çš„ metaï¼ˆå¦‚æœç”¨æˆ·å¡«å†™äº†ï¼‰
            try {
              const ca = (settingsCharAvatar && settingsCharAvatar.value) || '';
              const ua = (settingsUserAvatar && settingsUserAvatar.value) || '';
              if (ca) localStorage.setItem('default-char-avatar', ca);
              if (ua) localStorage.setItem('user-avatar', ua);
              // å¦‚æœå½“å‰æœ‰æ¿€æ´»ä¼šè¯ä¸”ç”¨æˆ·åœ¨è®¾ç½®ä¸­æŒ‡å®šäº† AI å¤´åƒï¼Œåˆ™åŒæ­¥åˆ°è¯¥ä¼šè¯çš„ chatmeta
              if (ca && activeChatName) {
                try {
                  const metaKey = 'chatmeta:' + activeChatName;
                  const meta = JSON.parse(localStorage.getItem(metaKey) || '{}');
                  meta.avatar = ca;
                  localStorage.setItem(metaKey, JSON.stringify(meta));
                } catch (e) {}
              }
              // å¼ºåˆ¶è¦†ç›–æ‰€æœ‰ä¼šè¯çš„ avatarï¼ˆè‹¥ ca ä¸ºç©ºåˆ™ç§»é™¤æ‰€æœ‰ä¼šè¯ avatarï¼‰ï¼Œä¿è¯è®¾ç½®èƒ½ç«‹å³åŒæ­¥åˆ°ä¼šè¯åˆ—è¡¨å’Œæ¶ˆæ¯åŒº
              try {
                const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
                sessions.forEach(n => {
                  try {
                    const key = 'chatmeta:' + n;
                    const m = JSON.parse(localStorage.getItem(key) || '{}');
                    if (ca) {
                      m.avatar = ca;
                    } else {
                      if (m.hasOwnProperty('avatar')) delete m.avatar;
                    }
                    localStorage.setItem(key, JSON.stringify(m));
                  } catch (e) {}
                });
              } catch (e) {}
            } catch (e) {}
            try {
              // å°†å…¨å±€è®¾ç½®åŒæ­¥åˆ°æ‰€æœ‰ä¼šè¯
              syncGlobalSettingsToSessions(true);
              renderUserDisplay();
              refreshSessionListAvatars();
              refreshMessageAvatars();
            } catch (e) {}
            closeSettingsModal();
          });
        if (settingsCancelBtn) settingsCancelBtn.addEventListener('click', closeSettingsModal);
        if (settingsModal)
          settingsModal.addEventListener('click', e => {
            if (e.target === settingsModal) closeSettingsModal();
          });

        // è½¬è´¦æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
        const transferModal = document.getElementById('transferModal');
        const transferConfirm = document.getElementById('transferConfirm');
        const transferCancel = document.getElementById('transferCancel');

        if (transferConfirm) {
          transferConfirm.addEventListener('click', () => {
            const receiver = document.getElementById('transferReceiver').value;
            const amount = document.getElementById('transferAmount').value;
            const note = document.getElementById('transferNote').value;

            if (!receiver || !amount) {
              alert('è¯·å¡«å†™æ”¶æ¬¾äººå’Œè½¬è´¦é‡‘é¢');
              return;
            }

            // å‘é€QQé£æ ¼çš„è½¬è´¦å¡ç‰‡
            const transferCard = `
              <div class="transfer-card" style="
                background: linear-gradient(135deg, #ff9a8b 0%, #a8e6cf 100%);
                border-radius: 12px;
                padding: 16px;
                margin: 8px 0;
                color: white;
                max-width: 250px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              ">
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                  <span style="font-size: 24px; margin-right: 8px;">ğŸ’°</span>
                  <span style="font-weight: bold;">è½¬è´¦ç»™ ${receiver}</span>
                </div>
                <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">Â¥${amount}</div>
                ${note ? `<div style="font-size: 12px; opacity: 0.9;">${note}</div>` : ''}
                <div style="text-align: center; margin-top: 12px;">
                  <button onclick="showTransferReceived('${receiver}', '${amount}', '${note}')" 
                          style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer;">
                    æŸ¥çœ‹è½¬è´¦
                  </button>
                </div>
              </div>
            `;
            appendMessage(transferCard, 'me');
            closeTransferModal();
          });
        }

        if (transferCancel) transferCancel.addEventListener('click', closeTransferModal);
        if (transferModal) {
          transferModal.addEventListener('click', e => {
            if (e.target === transferModal) closeTransferModal();
          });
        }

        // çº¢åŒ…æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
        const redPacketModal = document.getElementById('redPacketModal');
        const redPacketConfirm = document.getElementById('redPacketConfirm');
        const redPacketCancel = document.getElementById('redPacketCancel');

        if (redPacketConfirm) {
          redPacketConfirm.addEventListener('click', () => {
            const type = document.getElementById('redPacketType').value;
            const amount = document.getElementById('redPacketAmount').value;
            const count = document.getElementById('redPacketCount').value;
            const message = document.getElementById('redPacketMessage').value;

            if (!amount) {
              alert('è¯·å¡«å†™çº¢åŒ…é‡‘é¢');
              return;
            }

            // å‘é€QQé£æ ¼çš„çº¢åŒ…å¡ç‰‡
            const typeText = type === 'lucky' ? 'æ‹¼æ‰‹æ°”çº¢åŒ…' : 'æ™®é€šçº¢åŒ…';
            const redPacketCard = `
              <div class="redpacket-card" style="
                background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
                border-radius: 12px;
                padding: 16px;
                margin: 8px 0;
                color: white;
                max-width: 250px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                text-align: center;
              ">
                <div style="font-size: 32px; margin-bottom: 8px;">ğŸ§§</div>
                <div style="font-weight: bold; margin-bottom: 4px;">${message}</div>
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">${typeText}</div>
                <div style="font-size: 18px; font-weight: bold;">Â¥${amount} Ã— ${count}ä¸ª</div>
                <div style="margin-top: 12px;">
                  <button onclick="showRedPacketReceived('${type}', '${amount}', '${count}', '${message}')" 
                          style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer;">
                    å¼€çº¢åŒ…
                  </button>
                </div>
              </div>
            `;
            appendMessage(redPacketCard, 'me');
            closeRedPacketModal();
          });
        }

        if (redPacketCancel) redPacketCancel.addEventListener('click', closeRedPacketModal);
        if (redPacketModal) {
          redPacketModal.addEventListener('click', e => {
            if (e.target === redPacketModal) closeRedPacketModal();
          });
        }

        // ç¾¤èŠæ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
        const groupChatModal = document.getElementById('groupChatModal');
        const groupConfirm = document.getElementById('groupConfirm');
        const groupCancel = document.getElementById('groupCancel');

        if (groupConfirm) {
          groupConfirm.addEventListener('click', () => {
            const name = document.getElementById('groupName').value;
            const avatar = document.getElementById('groupAvatar').value;
            const description = document.getElementById('groupDescription').value;

            if (!name) {
              alert('è¯·å¡«å†™ç¾¤èŠåç§°');
              return;
            }

            // åˆ›å»ºç¾¤èŠä¼šè¯
            try {
              const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
              const groupName = `[ç¾¤] ${name}`;

              if (sessions.indexOf(groupName) === -1) {
                sessions.push(groupName);
                localStorage.setItem('qq-sessions', JSON.stringify(sessions));

                // ä¿å­˜ç¾¤èŠå…ƒæ•°æ®
                const groupMeta = {
                  name: groupName,
                  avatar: avatar || '',
                  prompt: description || `è¿™æ˜¯ä¸€ä¸ªåä¸º"${name}"çš„ç¾¤èŠ`,
                  isGroup: true,
                };
                localStorage.setItem('chatmeta:' + groupName, JSON.stringify(groupMeta));

                // é‡æ–°æ¸²æŸ“ä¼šè¯åˆ—è¡¨
                initQQSessionList();

                alert(`ç¾¤èŠ"${name}"åˆ›å»ºæˆåŠŸï¼`);
              } else {
                alert('ç¾¤èŠåç§°å·²å­˜åœ¨');
              }
            } catch (e) {
              console.error('åˆ›å»ºç¾¤èŠå¤±è´¥', e);
              alert('åˆ›å»ºç¾¤èŠå¤±è´¥');
            }

            closeGroupChatModal();
          });
        }

        if (groupCancel) groupCancel.addEventListener('click', closeGroupChatModal);
        if (groupChatModal) {
          groupChatModal.addEventListener('click', e => {
            if (e.target === groupChatModal) closeGroupChatModal();
          });
        }

        // ä¸Šä¼ æŒ‰é’®ä¸ file input è¡Œä¸º
        const settingsCharUploadBtn = document.getElementById('settingsCharUploadBtn');
        const settingsCharAvatarFile = document.getElementById('settingsCharAvatarFile');
        const settingsCharAvatarPreview = document.getElementById('settingsCharAvatarPreview');
        const settingsUserUploadBtn = document.getElementById('settingsUserUploadBtn');
        const settingsUserAvatarFile = document.getElementById('settingsUserAvatarFile');
        const settingsUserAvatarPreview = document.getElementById('settingsUserAvatarPreview');

        function previewImageEl(container, src) {
          if (!container) return;
          container.innerHTML = '';
          if (!src) return;
          const img = document.createElement('img');
          img.src = src;
          img.style.width = '48px';
          img.style.height = '48px';
          img.style.borderRadius = '6px';
          img.style.objectFit = 'cover';
          container.appendChild(img);
        }

        if (settingsCharUploadBtn && settingsCharAvatarFile) {
          settingsCharUploadBtn.addEventListener('click', () => settingsCharAvatarFile.click());
          settingsCharAvatarFile.addEventListener('change', e => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
              const data = ev.target.result;
              settingsCharAvatar.value = data;
              previewImageEl(settingsCharAvatarPreview, data);
            };
            r.readAsDataURL(f);
          });
        }
        if (settingsUserUploadBtn && settingsUserAvatarFile) {
          settingsUserUploadBtn.addEventListener('click', () => settingsUserAvatarFile.click());
          settingsUserAvatarFile.addEventListener('change', e => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
              const data = ev.target.result;
              settingsUserAvatar.value = data;
              previewImageEl(settingsUserAvatarPreview, data);
            };
            r.readAsDataURL(f);
          });
        }

        // åœ¨ä¸»è®¾ç½®é¡µçš„é½¿è½®æŒ‰é’®ä¸ŠæŒ‚è½½æ‰“å¼€è®¾ç½®æ¨¡æ€
        document.querySelectorAll('.btn.ghost[title="è®¾ç½®"]').forEach(b =>
          b.addEventListener('click', e => {
            e.preventDefault();
            openSettingsModal();
          }),
        );
        // æ¸²æŸ“ç”¨æˆ·æ˜¾ç¤ºï¼ˆå¤´åƒä¸åå­—ï¼‰
        // é¡¶éƒ¨å¤´åƒæ˜¾ç¤ºï¼šæ˜¾ç¤ºå½“å‰ä¼šè¯ï¼ˆAIï¼‰å¤´åƒï¼Œè‹¥æ— åˆ™æ˜¾ç¤ºé»˜è®¤è§’è‰²å¤´åƒ
        function renderUserDisplay() {
          const disp = document.getElementById('userDisplay');
          if (!disp) return;
          disp.innerHTML = '';
          let a = '';
          try {
            if (activeChatName) {
              const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
              a = meta && meta.avatar;
            }
          } catch (e) {}
          if (!a) a = localStorage.getItem('default-char-avatar') || '';
          if (a) {
            const i = document.createElement('img');
            i.src = a;
            i.alt = activeChatName || 'AI';
            i.style.width = '28px';
            i.style.height = '28px';
            i.style.borderRadius = '50%';
            disp.appendChild(i);
          } else {
            const s = document.createElement('div');
            const label =
              (activeChatName && activeChatName[0]) || (localStorage.getItem('default-char-name') || 'A')[0];
            s.textContent = label;
            s.style.width = '28px';
            s.style.height = '28px';
            s.style.borderRadius = '50%';
            s.style.background = 'linear-gradient(180deg,#fff,#eef7ff)';
            s.style.display = 'flex';
            s.style.alignItems = 'center';
            s.style.justifyContent = 'center';
            s.style.fontWeight = '700';
            disp.appendChild(s);
          }
        }

        // åˆ·æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„å¤´åƒæ˜¾ç¤ºï¼ˆå¦‚æœ chatmeta ä¸­æœ‰ avatarï¼‰
        function refreshSessionListAvatars() {
          const list = document.getElementById('qq-session-list');
          if (!list) return;
          Array.from(list.querySelectorAll('.qq-session')).forEach(el => {
            const nameEl = el.querySelector('.name');
            const name = nameEl ? nameEl.childNodes[0].textContent.trim() : null;
            if (!name) return;
            try {
              const meta = JSON.parse(localStorage.getItem('chatmeta:' + name) || '{}');
              const avatar = meta && meta.avatar;
              const avatarContainer = el.querySelector('.qq-avatar');
              if (avatar && avatarContainer) {
                avatarContainer.innerHTML = `<img src="${avatar}" alt="avatar" style="width:100%;height:100%;border-radius:50%"/>`;
              } else if (avatarContainer) {
                // æ—  avatar æ—¶å›é€€ä¸ºé¦–å­—æ¯å ä½ï¼Œé¿å…ä¿ç•™æ—§å›¾ç‰‡
                const ch = (name && name[0]) || 'æˆ‘';
                avatarContainer.innerHTML = '';
                avatarContainer.textContent = ch;
              }
            } catch (e) {}
          });
        }
        // åˆ·æ–°æ¶ˆæ¯åŒºä¸­çš„å¤´åƒï¼ˆç”¨äºè®¾ç½®ä¿®æ”¹ååŒæ­¥å·²æ¸²æŸ“çš„æ¶ˆæ¯ï¼‰
        function refreshMessageAvatars() {
          const msgs = document.getElementById('messages');
          if (!msgs) return;
          Array.from(msgs.querySelectorAll('.message-row')).forEach(row => {
            const isMe = row.classList.contains('me');
            const avatarDiv = row.querySelector('.avatar');
            if (!avatarDiv) return;
            avatarDiv.innerHTML = '';
            try {
              if (isMe) {
                const ua = localStorage.getItem('user-avatar') || '';
                const uname = localStorage.getItem('user-name') || '';
                if (ua) {
                  const img = document.createElement('img');
                  img.src = ua;
                  avatarDiv.appendChild(img);
                } else {
                  avatarDiv.textContent = uname && uname[0] ? uname[0] : 'æˆ‘';
                }
              } else {
                let a = '';
                if (activeChatName) {
                  try {
                    const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
                    a = meta && meta.avatar;
                  } catch (e) {}
                }
                if (!a) a = localStorage.getItem('default-char-avatar') || '';
                if (a) {
                  const img = document.createElement('img');
                  img.src = a;
                  avatarDiv.appendChild(img);
                } else {
                  const label = activeChatName && activeChatName[0] ? activeChatName[0] : 'AI';
                  avatarDiv.textContent = label;
                }
              }
            } catch (e) {
              avatarDiv.textContent = isMe ? 'æˆ‘' : 'AI';
            }
          });
        }

        // å°†å…¨å±€é»˜è®¤è®¾ç½®åŒæ­¥åˆ°æ‰€æœ‰ä¼šè¯çš„ chatmetaï¼ˆforce = true æ—¶å¼ºåˆ¶è¦†ç›–ï¼‰
        function syncGlobalSettingsToSessions(force = true) {
          try {
            const defName = localStorage.getItem('default-char-name') || '';
            const defAvatar = localStorage.getItem('default-char-avatar') || '';
            const defPrompt = localStorage.getItem('default-char-prompt') || '';
            const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
            sessions.forEach(n => {
              try {
                const key = 'chatmeta:' + n;
                const m = JSON.parse(localStorage.getItem(key) || '{}');
                if (force) {
                  // è¦†ç›–æˆ–å†™å…¥é»˜è®¤å­—æ®µ
                  if (defName) m.name = defName; // ä»…å½“ defName éç©ºæ—¶å†™å…¥
                  if (defAvatar) m.avatar = defAvatar;
                  else if (!defAvatar && m.hasOwnProperty('avatar')) delete m.avatar;
                  if (defPrompt) m.prompt = defPrompt;
                  else if (!defPrompt && m.hasOwnProperty('prompt')) delete m.prompt;
                } else {
                  if (!m.avatar && defAvatar) m.avatar = defAvatar;
                  if (!m.prompt && defPrompt) m.prompt = defPrompt;
                }
                const after = JSON.stringify(m);
                localStorage.setItem(key, after);
                try {
                  console.log('[SYNC] session', n, 'after:', after);
                } catch (e) {}
              } catch (e) {}
            });
          } catch (e) {}
        }
        // é¦–æ¬¡æ¸²æŸ“ç”¨æˆ·æ˜¾ç¤º
        renderUserDisplay();

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ•°æ®åŒæ­¥
        function initializeApp() {
          try {
            // åŒæ­¥å…¨å±€è®¾ç½®åˆ°æ‰€æœ‰ä¼šè¯
            syncGlobalSettingsToSessions(false); // ä¸å¼ºåˆ¶è¦†ç›–å·²æœ‰è®¾ç½®

            // åˆ·æ–°æ‰€æœ‰å¤´åƒæ˜¾ç¤º
            refreshSessionListAvatars();
            refreshMessageAvatars();

            // é‡æ–°æ¸²æŸ“ç”¨æˆ·æ˜¾ç¤º
            renderUserDisplay();

            console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œæ•°æ®å·²åŒæ­¥');
          } catch (e) {
            console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', e);
          }
        }

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³åˆå§‹åŒ–
        initializeApp();

        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬å™¨ï¼Œç¡®ä¿åˆ‡æ¢å›é¡µé¢æ—¶æ•°æ®åŒæ­¥
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            // é¡µé¢å˜ä¸ºå¯è§æ—¶é‡æ–°åŒæ­¥æ•°æ®
            setTimeout(initializeApp, 100);
          }
        });

        // æ·»åŠ çª—å£ç„¦ç‚¹ç›‘å¬å™¨ï¼Œç¡®ä¿çª—å£è·å¾—ç„¦ç‚¹æ—¶æ•°æ®åŒæ­¥
        window.addEventListener('focus', () => {
          setTimeout(initializeApp, 100);
        });

        // åœ¨åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢æ—¶ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
        function openChat(name) {
          document.getElementById('app-row').style.display = 'none';
          ['chat-screen', 'settings-screen', 'qq-screen', 'api-screen'].forEach(id =>
            document.getElementById(id).classList.remove('active'),
          );
          document.getElementById('chat-screen').classList.add('active');
          const navStrong = document.querySelector('#chat-screen .nav strong');
          if (navStrong) navStrong.textContent = name;
          const messages = document.getElementById('messages');
          if (messages) {
            messages.innerHTML = '';
            activeChatName = name;
            currentMessages = loadChat(name) || [];
            if (currentMessages.length) {
              currentMessages.forEach(m => {
                renderMessage(m.content, m.role === 'user' ? 'me' : 'assistant');
              });
            }
            // æ¸²æŸ“å®Œæˆåæ»šåŠ¨åˆ°åº•éƒ¨
            messages.scrollTop = messages.scrollHeight;
          }

          // ç¡®ä¿åˆ‡æ¢ä¼šè¯æ—¶å¤´åƒå’Œæ•°æ®åŒæ­¥
          try {
            renderUserDisplay();
            refreshMessageAvatars();
            updateChatContactInfo(); // æ›´æ–°èŠå¤©ç•Œé¢çš„è”ç³»äººä¿¡æ¯
          } catch (e) {
            console.error('åˆ‡æ¢ä¼šè¯æ—¶åŒæ­¥æ•°æ®å¤±è´¥:', e);
          }
        }
        const qqList = document.getElementById('qq-session-list');
        if (qqList) {
          qqList.addEventListener('click', async e => {
            // åˆ é™¤æŒ‰é’®ä½¿ç”¨äº‹ä»¶å§”æ‰˜
            const del = e.target.closest('.qq-del');
            if (del) {
              e.stopPropagation();
              const row = del.closest('.qq-session');
              const nameEl = row && row.querySelector('.name');
              const name = nameEl ? nameEl.childNodes[0].textContent.trim() : null;
              if (!name) return;
              const ok = await showConfirm('åˆ é™¤ä¼šè¯', `ç¡®è®¤åˆ é™¤ä¼šè¯ï¼š${name} ?`);
              if (!ok) return;
              try {
                localStorage.removeItem('chat:' + name);
                // åŒæ—¶ç§»é™¤è¯¥ä¼šè¯çš„ metaï¼ˆå¤´åƒ/æç¤ºï¼‰
                try {
                  localStorage.removeItem('chatmeta:' + name);
                } catch (e) {}
                try {
                  console.log('[DELETE] removed chat and chatmeta for', name);
                } catch (e) {}
                // å¦‚æœè¢«åˆ é™¤çš„ä¼šè¯æ­£å¥½æ˜¯å½“å‰çš„å…¨å±€é»˜è®¤ AI åï¼Œåˆ™æ¸…é™¤å¯¹åº”çš„å…¨å±€é»˜è®¤è®¾ç½®
                try {
                  const def = localStorage.getItem('default-char-name') || '';
                  if (def && def === name) {
                    localStorage.removeItem('default-char-name');
                    localStorage.removeItem('default-char-avatar');
                    localStorage.removeItem('default-char-prompt');
                  }
                } catch (e) {}
                row.remove();
                const remaining = Array.from(qqList.querySelectorAll('.qq-session'))
                  .map(s => {
                    const n = s.querySelector('.name');
                    return n ? n.childNodes[0].textContent.trim() : null;
                  })
                  .filter(Boolean);
                localStorage.setItem('qq-sessions', JSON.stringify(remaining));
                if (activeChatName === name) {
                  messagesEl.innerHTML = '';
                  activeChatName = null;
                  currentMessages = [];
                }
                try {
                  renderUserDisplay();
                  refreshSessionListAvatars();
                  refreshMessageAvatars();
                } catch (e) {}
              } catch (err) {
                console.error('åˆ é™¤ä¼šè¯å¤±è´¥', err);
              }
              return;
            }
            const s = e.target.closest('.qq-session');
            if (!s) return;
            const nameEl = s.querySelector('.name');
            const name = nameEl ? nameEl.childNodes[0].textContent.trim() : 'æ±‰å ¡å ¡';
            openChat(name);
          });
          // æ¢å¤å·²ä¿å­˜çš„ä¼šè¯
          try {
            const saved = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
            if (saved && saved.length) {
              qqList.innerHTML = '';
              saved.forEach(n => {
                const el = document.createElement('div');
                el.className = 'qq-session';
                // å°è¯•è¯»å–ä¼šè¯å…ƒæ•°æ®ï¼ˆavatar/promptï¼‰
                let avatar = null;
                try {
                  const meta = JSON.parse(localStorage.getItem('chatmeta:' + n) || '{}');
                  avatar = meta && meta.avatar;
                } catch (e) {}
                if (avatar) {
                  el.innerHTML = `<div class="qq-avatar"><img src="${avatar}" alt="avatar" style="width:100%;height:100%;border-radius:50%"/></div><div class="info"><div class="name">${n} <span class="meta">Â· ä¹‹å‰</span></div><div class="msg">ä¸ ${n} çš„å¯¹è¯</div></div><button class="qq-del">åˆ é™¤</button>`;
                } else {
                  el.innerHTML = `<div class="qq-avatar">${
                    n[0] || 'æˆ‘'
                  }</div><div class="info"><div class="name">${n} <span class="meta">Â· ä¹‹å‰</span></div><div class="msg">ä¸ ${n} çš„å¯¹è¯</div></div><button class="qq-del">åˆ é™¤</button>`;
                }
                qqList.appendChild(el);
              });
            }
            // roll æŒ‰é’®é€»è¾‘ï¼šé‡æ–°ç”Ÿæˆä¸Šä¸€æ¬¡ assistant çš„å›å¤ï¼ˆå¦‚æœæœ‰ï¼‰
            const rollFooter = document.getElementById('rollFooterBtn');
            if (rollFooter) {
              rollFooter.addEventListener('click', async () => {
                if (!activeChatName || !currentMessages.length) return;
                // æ‰¾åˆ°ä¸Šä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯
                let lastUser = null;
                for (let i = currentMessages.length - 1; i >= 0; i--) {
                  if (currentMessages[i].role === 'user') {
                    lastUser = currentMessages[i].content;
                    break;
                  }
                }
                if (!lastUser) return;
                // åˆ é™¤æœ€åä¸€æ¡ assistant å›å¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                for (let i = currentMessages.length - 1; i >= 0; i--) {
                  if (currentMessages[i].role === 'assistant') {
                    currentMessages.splice(i, 1);
                    break;
                  }
                }
                // re-render messages
                messagesEl.innerHTML = '';
                currentMessages.forEach(m => renderMessage(m.content, m.role === 'user' ? 'me' : 'assistant'));
                messagesEl.scrollTop = messagesEl.scrollHeight;
                // ç›´æ¥è°ƒç”¨ requestReplyï¼Œä¸é‡å¤æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                await requestReply(lastUser, { appendUser: false });
              });
            }
          } catch (e) {
            console.error('æ¢å¤ä¼šè¯å¤±è´¥', e);
          }
        }

        // å£çº¸åŠŸèƒ½
        function initWallpaperSettings() {
          const wallpaperType = document.getElementById('wallpaperType');
          const colorDiv = document.getElementById('colorWallpaper');
          const gradientDiv = document.getElementById('gradientWallpaper');
          const imageDiv = document.getElementById('imageWallpaper');
          const applyBtn = document.getElementById('applyWallpaper');
          const uploadBtn = document.getElementById('wallpaperUploadBtn');
          const fileInput = document.getElementById('wallpaperImageFile');

          // åˆ‡æ¢å£çº¸ç±»å‹
          wallpaperType.addEventListener('change', () => {
            const type = wallpaperType.value;
            colorDiv.style.display = type === 'color' ? 'block' : 'none';
            gradientDiv.style.display = type === 'gradient' ? 'block' : 'none';
            imageDiv.style.display = type === 'image' ? 'block' : 'none';
          });

          // ä¸Šä¼ å›¾ç‰‡
          uploadBtn.addEventListener('click', () => fileInput.click());
          fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = e => {
                document.getElementById('wallpaperImageUrl').value = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          });

          // åº”ç”¨å£çº¸
          applyBtn.addEventListener('click', () => {
            const type = wallpaperType.value;
            let backgroundStyle = '';

            if (type === 'color') {
              const color = document.getElementById('wallpaperColor').value;
              backgroundStyle = `background: ${color}`;
            } else if (type === 'gradient') {
              const color1 = document.getElementById('gradientColor1').value;
              const color2 = document.getElementById('gradientColor2').value;
              backgroundStyle = `background: linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
            } else if (type === 'image') {
              const imageUrl = document.getElementById('wallpaperImageUrl').value;
              if (imageUrl) {
                backgroundStyle = `background: url('${imageUrl}') center/cover no-repeat`;
              }
            }

            if (backgroundStyle) {
              document.body.style.cssText += '; ' + backgroundStyle;
              localStorage.setItem('wallpaper-style', backgroundStyle);
              localStorage.setItem('wallpaper-type', type);
              alert('å£çº¸å·²åº”ç”¨ï¼');
            }
          });

          // åŠ è½½ä¿å­˜çš„å£çº¸
          const savedStyle = localStorage.getItem('wallpaper-style');
          const savedType = localStorage.getItem('wallpaper-type');
          if (savedStyle) {
            document.body.style.cssText += '; ' + savedStyle;
            if (savedType) wallpaperType.value = savedType;
          }
        }

        // ä¸–ç•Œä¹¦åŠŸèƒ½
        function initWorldBook() {
          const openBtn = document.getElementById('openWorldBook');
          const addBtn = document.getElementById('addWorldBookEntry');
          const clearBtn = document.getElementById('clearWorldBook');
          const cancelBtn = document.getElementById('worldBookCancel');

          openBtn.addEventListener('click', showWorldBookModal);
          cancelBtn.addEventListener('click', closeWorldBookModal);

          addBtn.addEventListener('click', () => {
            const keyword = document.getElementById('worldBookKeyword').value.trim();
            const content = document.getElementById('worldBookContent').value.trim();

            if (!keyword || !content) {
              alert('è¯·å¡«å†™å…³é”®è¯å’Œæè¿°å†…å®¹');
              return;
            }

            const worldBook = JSON.parse(localStorage.getItem('world-book') || '[]');
            const existingIndex = worldBook.findIndex(entry => entry.keyword === keyword);

            if (existingIndex >= 0) {
              worldBook[existingIndex].content = content;
            } else {
              worldBook.push({ keyword, content, id: Date.now() });
            }

            localStorage.setItem('world-book', JSON.stringify(worldBook));
            document.getElementById('worldBookKeyword').value = '';
            document.getElementById('worldBookContent').value = '';
            loadWorldBookEntries();
          });

          clearBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸–ç•Œä¹¦æ¡ç›®å—ï¼Ÿ')) {
              localStorage.removeItem('world-book');
              loadWorldBookEntries();
            }
          });
        }

        function loadWorldBookEntries() {
          const listDiv = document.getElementById('worldBookList');
          const worldBook = JSON.parse(localStorage.getItem('world-book') || '[]');

          if (worldBook.length === 0) {
            listDiv.innerHTML = '<p style="color: #999; text-align: center; margin: 20px 0">æš‚æ— æ¡ç›®</p>';
            return;
          }

          listDiv.innerHTML = worldBook
            .map(
              entry => `
            <div style="border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; align-items: flex-start">
              <div style="flex: 1">
                <strong style="color: #667eea">${entry.keyword}</strong>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #666; white-space: pre-wrap">${entry.content}</p>
              </div>
              <button onclick="deleteWorldBookEntry(${entry.id})" 
                      style="background: #ff4757; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer">åˆ é™¤</button>
            </div>
          `,
            )
            .join('');
        }

        window.deleteWorldBookEntry = function (id) {
          const worldBook = JSON.parse(localStorage.getItem('world-book') || '[]');
          const filtered = worldBook.filter(entry => entry.id !== id);
          localStorage.setItem('world-book', JSON.stringify(filtered));
          loadWorldBookEntries();
        };

        // åœ¨æ¶ˆæ¯å‘é€æ—¶åº”ç”¨ä¸–ç•Œä¹¦
        function applyWorldBook(messageContent) {
          const worldBook = JSON.parse(localStorage.getItem('world-book') || '[]');
          let contextAddition = '';

          worldBook.forEach(entry => {
            if (messageContent.toLowerCase().includes(entry.keyword.toLowerCase())) {
              contextAddition += `\n[ä¸–ç•Œä¹¦: ${entry.keyword}] ${entry.content}`;
            }
          });

          return contextAddition;
        }

        // åˆå§‹åŒ–æ–°åŠŸèƒ½æ¨¡æ€æ¡†
        function initNewModals() {
          // æ‹ç…§æ¨¡æ€æ¡†
          const cameraCancel = document.getElementById('cameraCancel');
          const cameraConfirm = document.getElementById('cameraConfirm');
          cameraCancel.addEventListener('click', closeCameraModal);
          cameraConfirm.addEventListener('click', () => {
            const description = document.getElementById('cameraDescription').value.trim();
            if (description) {
              appendMessage(`[å›¾ç‰‡æè¿°] ${description}`, 'me');
              closeCameraModal();
            }
          });

          // ç›¸å†Œæ¨¡æ€æ¡†
          const albumCancel = document.getElementById('albumCancel');
          const albumConfirm = document.getElementById('albumConfirm');
          const selectImageBtn = document.getElementById('selectImageBtn');
          const albumFileInput = document.getElementById('albumFileInput');

          albumCancel.addEventListener('click', closeAlbumModal);
          selectImageBtn.addEventListener('click', () => albumFileInput.click());

          albumFileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = e => {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;" />`;
                document.getElementById('albumConfirm').style.display = 'block';
              };
              reader.readAsDataURL(file);
            }
          });

          albumConfirm.addEventListener('click', () => {
            const preview = document.getElementById('imagePreview');
            const img = preview.querySelector('img');
            if (img) {
              appendMessage(`[å‘é€å›¾ç‰‡] <img src="${img.src}" style="max-width: 200px; border-radius: 8px;" />`, 'me');
              closeAlbumModal();
            }
          });

          // Rollé€‰é¡¹æ¨¡æ€æ¡†
          const waitReplyBtn = document.getElementById('waitReplyBtn');
          const rollBtn = document.getElementById('rollBtn');

          waitReplyBtn.addEventListener('click', () => {
            closeRollOptions();
            // è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯å¹¶è¯·æ±‚AIå›å¤
            const lastUserMsg = [...currentMessages].reverse().find(m => m.role === 'user');
            if (lastUserMsg) {
              requestReply(lastUserMsg.content, { appendUser: false });
            }
          });

          rollBtn.addEventListener('click', () => {
            closeRollOptions();
            // åˆ é™¤æœ€åä¸€æ¡AIå›å¤å¹¶é‡æ–°ç”Ÿæˆ
            if (currentMessages.length > 0 && currentMessages[currentMessages.length - 1].role === 'assistant') {
              currentMessages.pop();
              const messagesEl = document.getElementById('messages');
              messagesEl.removeChild(messagesEl.lastChild);
              saveChat(activeChatName);
            }
            // è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯å¹¶é‡æ–°è¯·æ±‚
            const lastUserMsg = [...currentMessages].reverse().find(m => m.role === 'user');
            if (lastUserMsg) {
              requestReply(lastUserMsg.content, { appendUser: false });
            }
          });

          // èŠå¤©è®¾ç½®æ¨¡æ€æ¡†
          const chatSettingsCancel = document.getElementById('chatSettingsCancel');
          const chatSettingsSave = document.getElementById('chatSettingsSave');

          chatSettingsCancel.addEventListener('click', closeChatSettings);
          chatSettingsSave.addEventListener('click', saveChatSettings);

          // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
          document.addEventListener('click', e => {
            if (e.target.classList.contains('modal-backdrop')) {
              e.target.classList.remove('active');
            }
          });
        }

        // èŠå¤©è®¾ç½®ç›¸å…³å‡½æ•°
        function loadChatSettings() {
          if (activeChatName) {
            const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
            document.getElementById('chatCharName').value = activeChatName || '';
            document.getElementById('chatCharAvatar').value = meta.avatar || '';
            document.getElementById('chatCharPrompt').value = meta.prompt || '';
          }
          document.getElementById('chatUserName').value = localStorage.getItem('user-name') || '';
          document.getElementById('chatUserAvatar').value = localStorage.getItem('user-avatar') || '';
        }

        function saveChatSettings() {
          const charName = document.getElementById('chatCharName').value.trim();
          const charAvatar = document.getElementById('chatCharAvatar').value.trim();
          const charPrompt = document.getElementById('chatCharPrompt').value.trim();
          const userName = document.getElementById('chatUserName').value.trim();
          const userAvatar = document.getElementById('chatUserAvatar').value.trim();

          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          if (userName) localStorage.setItem('user-name', userName);
          if (userAvatar) localStorage.setItem('user-avatar', userAvatar);

          // ä¿å­˜AIä¿¡æ¯
          if (activeChatName && charName) {
            // å¦‚æœæ”¹äº†åå­—ï¼Œéœ€è¦è¿ç§»æ•°æ®
            if (charName !== activeChatName) {
              const chatData = localStorage.getItem('chat:' + activeChatName);
              const metaData = localStorage.getItem('chatmeta:' + activeChatName);
              if (chatData) localStorage.setItem('chat:' + charName, chatData);

              const meta = JSON.parse(metaData || '{}');
              meta.avatar = charAvatar;
              meta.prompt = charPrompt;
              localStorage.setItem('chatmeta:' + charName, JSON.stringify(meta));

              // æ›´æ–°ä¼šè¯åˆ—è¡¨
              const sessions = JSON.parse(localStorage.getItem('qq-sessions') || '[]');
              const index = sessions.indexOf(activeChatName);
              if (index >= 0) {
                sessions[index] = charName;
                localStorage.setItem('qq-sessions', JSON.stringify(sessions));
              }

              // æ¸…ç†æ—§æ•°æ®
              localStorage.removeItem('chat:' + activeChatName);
              localStorage.removeItem('chatmeta:' + activeChatName);

              activeChatName = charName;
            } else {
              const meta = JSON.parse(localStorage.getItem('chatmeta:' + activeChatName) || '{}');
              meta.avatar = charAvatar;
              meta.prompt = charPrompt;
              localStorage.setItem('chatmeta:' + activeChatName, JSON.stringify(meta));
            }

            // æ›´æ–°ç•Œé¢
            document.getElementById('chatTitle').textContent = charName;
            if (charAvatar) {
              document.getElementById(
                'contactAvatar',
              ).innerHTML = `<img src="${charAvatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />`;
            }
          }

          closeChatSettings();
          renderUserDisplay();
          refreshSessionListAvatars();
          refreshMessageAvatars();
        }

        // åˆå§‹åŒ–æ–°åŠŸèƒ½
        initWallpaperSettings();
        initWorldBook();
        initNewModals();

        // ä¿®å¤èŠå¤©é¡µé¢å¯¼èˆªæ 
        function fixChatNavigation() {
          const rightSection = document.querySelector('#chat-screen .nav .right-section');
          if (rightSection) {
            rightSection.innerHTML = `
              <button class="action-btn" title="åˆ é™¤æ¶ˆæ¯" onclick="toggleDeleteMode()" id="deleteBtn">
                <img src="https://i.111666.best/image/8B6YbkOChM9r1Qh7j66M3O.png" alt="åˆ é™¤" style="width: 18px; height: 18px;" />
              </button>
              <button class="action-btn" title="èŠå¤©è®¾ç½®" onclick="openChatSettings()">âš™ï¸</button>
              <button class="action-btn" title="æ›´å¤š" onclick="showMoreOptions()">â‹¯</button>
            `;
          }
        }

        // åœ¨DOMåŠ è½½å®Œæˆåæ‰§è¡Œä¿®å¤
        setTimeout(fixChatNavigation, 100);
      })();
    </script>
  </body>
</html>
